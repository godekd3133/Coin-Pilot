<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinPilot | Automated Trading</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --bg-card: #1c2128;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-red: #f85149;
            --accent-yellow: #d29922;
            --accent-purple: #a371f7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-status {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-running { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .badge-stopped { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .badge-dry { background: rgba(210, 153, 34, 0.2); color: var(--accent-yellow); }
        .badge-live { background: rgba(163, 113, 247, 0.2); color: var(--accent-purple); }
        .badge-buy { background: rgba(63, 185, 80, 0.2); color: var(--accent-green); }
        .badge-sell { background: rgba(248, 81, 73, 0.2); color: var(--accent-red); }
        .badge-hold { background: rgba(139, 148, 158, 0.2); color: var(--text-secondary); }

        /* Grid Layout */
        .grid {
            display: grid;
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-2 { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .grid-3 { grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        .grid-4 { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .card-header h2 {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-body {
            padding: 20px;
        }

        /* Stats */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
        }

        .stat-value.positive { color: var(--accent-green); }
        .stat-value.negative { color: var(--accent-red); }

        /* 숫자 롤링 애니메이션 효과 */
        .stat-value, .today-stat-value, .position-large-stat-value, .chart-stat-value, .account-large-value {
            transition: color 0.3s ease-out;
            display: inline-block;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            background: var(--bg-tertiary);
        }

        tr:hover {
            background: var(--bg-tertiary);
        }

        /* Forms */
        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.15);
        }

        .form-range {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            outline: none;
        }

        .form-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--accent-blue);
            color: #fff;
        }

        .btn-primary:hover {
            background: #4c9aed;
        }

        .btn-success {
            background: var(--accent-green);
            color: #fff;
        }

        .btn-success:hover {
            background: #36a849;
        }

        .btn-danger {
            background: var(--accent-red);
            color: #fff;
        }

        .btn-danger:hover {
            background: #e04840;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .preset-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .preset-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .preset-btn.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Trading Panel Tabs */
        .trading-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .trading-tab {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .trading-tab:not(:last-child) {
            border-right: 1px solid var(--border-color);
        }

        .trading-tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .trading-tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .trading-tab.buy-tab.active {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
            border-bottom: 2px solid var(--accent-green);
        }

        .trading-tab.sell-tab.active {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
            border-bottom: 2px solid var(--accent-red);
        }

        .trading-tab.rec-tab.active {
            background: rgba(88, 166, 255, 0.15);
            color: var(--accent-blue);
            border-bottom: 2px solid var(--accent-blue);
        }

        /* Position Card with Actions */
        .position-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
        }

        .position-card:hover {
            border-color: var(--accent-blue);
        }

        .position-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .position-coin {
            font-weight: 600;
            font-size: 15px;
        }

        .position-profit {
            font-weight: 600;
            font-size: 14px;
        }

        .position-profit.positive { color: var(--accent-green); }
        .position-profit.negative { color: var(--accent-red); }

        .position-details {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .position-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
        }

        .position-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }

        .quantity-input-group {
            display: flex;
            gap: 4px;
            align-items: center;
        }

        .quantity-input {
            width: 80px;
            padding: 6px 8px;
            font-size: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-primary);
            text-align: right;
        }

        .quantity-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* Recommendation Card */
        .rec-card {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 14px;
            margin-bottom: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.2s;
        }

        .rec-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-1px);
        }

        .rec-card.buy-rec {
            border-left: 3px solid var(--accent-green);
        }

        .rec-card.sell-rec {
            border-left: 3px solid var(--accent-red);
        }

        .rec-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .rec-coin {
            font-weight: 600;
            font-size: 16px;
        }

        .rec-score {
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }

        .rec-score.high {
            background: rgba(63, 185, 80, 0.2);
            color: var(--accent-green);
        }

        .rec-score.medium {
            background: rgba(210, 153, 34, 0.2);
            color: var(--accent-yellow);
        }

        .rec-reason {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .rec-metrics {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .rec-action {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .rec-action .form-input {
            width: 100px;
            padding: 8px;
            font-size: 13px;
        }

        /* Additional rec-card styles */
        .rec-price {
            font-size: 13px;
            color: var(--text-muted);
        }

        .rec-holding {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .rec-profit {
            font-size: 14px;
            font-weight: 600;
        }

        .rec-profit.positive { color: var(--accent-green); }
        .rec-profit.negative { color: var(--accent-red); }

        .rec-indicators {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }

        .indicator-badge {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            color: var(--text-muted);
        }

        .rec-trade-form {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-color);
        }

        /* Position card additional styles */
        .position-info {
            flex: 1;
        }

        .position-value {
            text-align: right;
        }

        .position-action-group {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: wrap;
        }

        .rec-action .btn {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Coin Analysis Cards */
        .coin-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.2s;
        }

        .coin-card:hover {
            border-color: var(--accent-blue);
        }

        .coin-card.buy-signal {
            border-left: 4px solid var(--accent-green);
        }

        .coin-card.sell-signal {
            border-left: 4px solid var(--accent-red);
        }

        .coin-card.hold-signal {
            border-left: 4px solid var(--text-secondary);
        }

        .coin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .coin-name {
            font-size: 18px;
            font-weight: 700;
        }

        .coin-price {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .coin-metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .metric {
            text-align: center;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .metric-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 16px;
            font-weight: 600;
        }

        .coin-reason {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
        }

        .coin-actions {
            display: flex;
            gap: 10px;
        }

        .coin-actions .btn {
            flex: 1;
        }

        /* Parameter Grid */
        .param-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .param-item {
            background: var(--bg-tertiary);
            padding: 16px;
            border-radius: 8px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .param-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .param-value-display {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-blue);
        }

        .param-range-info {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Preset Grid */
        .preset-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .preset-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .preset-card:hover {
            border-color: var(--accent-blue);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .preset-card.active {
            border-color: var(--accent-green);
            background: rgba(46, 213, 115, 0.1);
        }

        .preset-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .preset-icon {
            font-size: 32px;
        }

        .preset-title {
            flex: 1;
        }

        .preset-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .preset-name-en {
            font-size: 12px;
            color: var(--text-muted);
        }

        .preset-description {
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .preset-risk {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preset-risk-label {
            font-size: 12px;
            color: var(--text-muted);
        }

        .risk-dots {
            display: flex;
            gap: 4px;
        }

        .risk-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
        }

        .risk-dot.filled {
            border: none;
        }

        .risk-dot.filled.low { background: var(--accent-green); }
        .risk-dot.filled.medium { background: var(--accent-yellow); }
        .risk-dot.filled.high { background: var(--accent-red); }

        .preset-apply-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--accent-green);
            color: white;
            font-size: 11px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            display: none;
        }

        .preset-card.active .preset-apply-badge {
            display: block;
        }

        /* History List */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-cycle {
            font-weight: 600;
            color: var(--accent-purple);
        }

        .history-date {
            font-size: 12px;
            color: var(--text-muted);
        }

        .history-fitness {
            font-weight: 600;
        }

        /* System Status */
        .system-status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .status-icon {
            font-size: 20px;
        }

        .status-info {
            flex: 1;
        }

        .status-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .status-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Today Summary */
        .today-summary-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .today-stat {
            text-align: center;
            padding: 12px 8px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .today-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .today-stat-value.positive {
            color: var(--accent-green);
        }

        .today-stat-value.negative {
            color: var(--accent-red);
        }

        .today-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* Portfolio Legend */
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .legend-item:last-child {
            border-bottom: none;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .legend-info {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .legend-name {
            font-size: 12px;
            font-weight: 500;
        }

        .legend-weight {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Pie Chart Tooltip */
        .pie-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 1000;
            min-width: 150px;
        }

        .pie-tooltip.active {
            opacity: 1;
        }

        .pie-tooltip-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pie-tooltip-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
            display: inline-block;
        }

        .pie-tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-bottom: 4px;
        }

        .pie-tooltip-label {
            color: var(--text-muted);
        }

        .pie-tooltip-value {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Pie chart hover effect */
        .pie-slice {
            transition: transform 0.15s ease, filter 0.15s ease;
            transform-origin: center;
            cursor: pointer;
        }

        .pie-slice:hover {
            filter: brightness(1.2);
        }

        /* Chart Tooltip */
        .chart-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 1000;
            min-width: 180px;
        }

        .chart-tooltip.active {
            opacity: 1;
        }

        .chart-tooltip-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .chart-tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .chart-tooltip-label {
            color: var(--text-muted);
        }

        .chart-tooltip-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .chart-point {
            cursor: pointer;
            transition: r 0.15s ease;
        }

        .chart-point:hover {
            r: 6;
        }

        /* Price Chart Tooltip */
        .price-chart-tooltip {
            position: fixed;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.15s ease;
            z-index: 1000;
            min-width: 200px;
        }

        .price-chart-tooltip.active {
            opacity: 1;
        }

        .price-chart-tooltip-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .price-chart-tooltip-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            margin-bottom: 4px;
        }

        .price-chart-tooltip-label {
            color: var(--text-muted);
        }

        .price-chart-tooltip-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .price-chart-bar {
            cursor: pointer;
            transition: opacity 0.15s ease;
        }

        .price-chart-bar:hover {
            opacity: 1 !important;
        }

        /* Candlestick Chart Styles */
        .candlestick-container {
            display: flex;
            align-items: stretch;
            height: 250px;
            gap: 2px;
            background: linear-gradient(180deg, var(--bg-tertiary) 0%, rgba(15, 23, 42, 0.8) 100%);
            border-radius: 12px;
            padding: 20px 80px 20px 15px;
            position: relative;
            overflow: hidden;
        }

        .candlestick-container::before {
            content: '';
            position: absolute;
            left: 15px;
            right: 80px;
            top: 20%;
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
        }

        .candlestick-container::after {
            content: '';
            position: absolute;
            left: 15px;
            right: 80px;
            top: 50%;
            height: 1px;
            background: rgba(255, 255, 255, 0.05);
        }

        .candlestick {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            position: relative;
            min-width: 4px;
            cursor: pointer;
            transition: transform 0.15s ease;
        }

        .candlestick:hover {
            transform: scaleX(1.5);
            z-index: 10;
        }

        .candlestick-wick {
            position: absolute;
            width: 1px;
            background: currentColor;
            opacity: 0.7;
        }

        .candlestick-body {
            width: 70%;
            min-width: 3px;
            max-width: 12px;
            border-radius: 1px;
            position: relative;
            transition: all 0.2s ease;
        }

        .candlestick.bullish .candlestick-body {
            background: linear-gradient(180deg, #10b981 0%, #059669 100%);
            box-shadow: 0 0 8px rgba(16, 185, 129, 0.3);
        }

        .candlestick.bearish .candlestick-body {
            background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.3);
        }

        .candlestick.bullish .candlestick-wick {
            color: #10b981;
        }

        .candlestick.bearish .candlestick-wick {
            color: #ef4444;
        }

        .candlestick:hover .candlestick-body {
            filter: brightness(1.2);
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.2);
        }

        /* Current (live) candle animation */
        .candlestick.current .candlestick-body {
            animation: pulse-candle 1.5s ease-in-out infinite;
        }

        @keyframes pulse-candle {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Price scale on the right */
        .price-scale {
            position: absolute;
            right: 5px;
            top: 20px;
            bottom: 20px;
            width: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            font-size: 10px;
            color: var(--text-muted);
            text-align: right;
            pointer-events: none;
        }

        /* Time scale at bottom */
        .time-scale {
            display: flex;
            justify-content: space-between;
            padding: 8px 80px 0 15px;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Chart header with live price */
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding: 0 4px;
        }

        .chart-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chart-price-info {
            display: flex;
            flex-direction: column;
        }

        .chart-current-price {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .chart-price-change {
            font-size: 14px;
            font-weight: 600;
        }

        .chart-stats {
            display: flex;
            gap: 20px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .chart-stat-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chart-stat-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .chart-stat-value {
            font-weight: 600;
        }

        /* Volume bars */
        .volume-container {
            display: flex;
            align-items: flex-end;
            height: 40px;
            gap: 2px;
            padding: 8px 80px 8px 15px;
            background: var(--bg-tertiary);
            border-radius: 0 0 12px 12px;
            margin-top: -1px;
        }

        .volume-bar {
            flex: 1;
            min-width: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 1px 1px 0 0;
            transition: background 0.15s ease;
        }

        .volume-bar.bullish {
            background: rgba(16, 185, 129, 0.3);
        }

        .volume-bar.bearish {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Top Gainers/Losers */
        .top-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .top-item:last-child {
            margin-bottom: 0;
        }

        .top-coin {
            font-weight: 600;
            font-size: 13px;
        }

        .top-percent {
            font-weight: 600;
            font-size: 13px;
        }

        .top-percent.positive {
            color: var(--accent-green);
        }

        .top-percent.negative {
            color: var(--accent-red);
        }

        /* Position Card Hover */
        .position-card:hover {
            background: var(--bg-secondary) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        /* Coin Detail Modal */
        .coin-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .coin-detail-item {
            background: var(--bg-tertiary);
            padding: 12px;
            border-radius: 8px;
        }

        .coin-detail-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .coin-detail-value {
            font-size: 16px;
            font-weight: 600;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            width: 90%;
            max-width: 450px;
            transform: scale(0.9);
            transition: all 0.3s;
        }

        .modal-overlay.active .modal {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 14px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        .toast.success { border-left: 4px solid var(--accent-green); }
        .toast.error { border-left: 4px solid var(--accent-red); }
        .toast.info { border-left: 4px solid var(--accent-blue); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Notification Popup Modal */
        .notification-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--bg-secondary);
            border: 2px solid var(--accent-blue);
            border-radius: 16px;
            min-width: 400px;
            max-width: 500px;
            z-index: 2000;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: popupAppear 0.3s ease forwards;
            display: none;
        }
        .notification-popup.show { display: block; }
        .notification-popup.breaking-news { border-color: var(--accent-red); }
        .notification-popup.bundle-signal { border-color: var(--accent-yellow); }
        @keyframes popupAppear {
            from { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        .notification-popup-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            border-radius: 14px 14px 0 0;
        }
        .notification-popup-header h3 { display: flex; align-items: center; gap: 10px; font-size: 16px; margin: 0; }
        .notification-popup-close { background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 24px; padding: 4px; }
        .notification-popup-close:hover { color: var(--text-primary); }
        .notification-popup-body { padding: 20px; }
        .notification-popup-footer { display: flex; gap: 10px; padding: 16px 20px; border-top: 1px solid var(--border-color); justify-content: flex-end; }
        .bundle-coin { display: flex; align-items: center; justify-content: space-between; padding: 12px; background: var(--bg-card); border-radius: 8px; margin-bottom: 8px; }
        .bundle-coin.sell { border-left: 3px solid var(--accent-red); }
        .bundle-coin.buy { border-left: 3px solid var(--accent-green); }
        .bundle-coin-info { display: flex; flex-direction: column; gap: 4px; }
        .bundle-coin-name { font-weight: 600; font-size: 15px; }
        .bundle-coin-details { font-size: 12px; color: var(--text-secondary); }
        .bundle-coin-value { text-align: right; }
        .bundle-arrow { display: flex; align-items: center; justify-content: center; padding: 8px; font-size: 24px; color: var(--accent-yellow); }
        /* 자동매매 알림 스타일 */
        .notification-popup.buy-signal { border-color: var(--accent-green); }
        .notification-popup.sell-signal { border-color: var(--accent-red); }
        .auto-trade-detail { text-align: center; padding: 10px; }
        .trade-coin { font-size: 28px; font-weight: 700; margin-bottom: 8px; }
        .trade-price { font-size: 20px; color: var(--text-primary); margin-bottom: 12px; }
        .trade-amount, .trade-volume { font-size: 14px; color: var(--text-secondary); margin-bottom: 6px; }
        .trade-strength { font-size: 14px; margin: 12px 0; padding: 8px; background: var(--bg-tertiary); border-radius: 8px; }
        .trade-profit { font-size: 16px; font-weight: 600; margin: 12px 0; padding: 10px; border-radius: 8px; }
        .trade-profit.positive { background: rgba(46, 204, 113, 0.15); color: var(--accent-green); }
        .trade-profit.negative { background: rgba(231, 76, 60, 0.15); color: var(--accent-red); }
        .trade-reason { font-size: 13px; color: var(--text-secondary); margin-top: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; }
        .breaking-news-content { background: var(--bg-tertiary); padding: 16px; border-radius: 10px; border-left: 4px solid var(--accent-red); }
        .breaking-news-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; line-height: 1.4; }
        .breaking-news-meta { display: flex; align-items: center; gap: 12px; font-size: 12px; color: var(--text-secondary); }
        .notification-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); z-index: 1999; display: none; }
        .notification-overlay.show { display: block; }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        /* Refresh Info */
        .refresh-info {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .pulse-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* Indicators */
        .indicator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 10px;
        }

        .indicator {
            text-align: center;
            padding: 8px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 11px;
        }

        .indicator-label {
            color: var(--text-muted);
            margin-bottom: 2px;
        }

        .indicator-value {
            font-weight: 600;
        }

        /* Tab Navigation */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--bg-tertiary);
            padding: 4px;
            border-radius: 8px;
            overflow-x: auto;
        }

        .tab {
            padding: 10px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* View Mode Selector */
        .view-mode-selector {
            display: flex;
            gap: 2px;
            background: var(--bg-tertiary);
            padding: 3px;
            border-radius: 6px;
        }

        .view-mode-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .view-mode-btn:hover {
            color: var(--text-primary);
            background: var(--bg-primary);
        }

        .view-mode-btn.active {
            color: var(--accent-blue);
            background: var(--bg-primary);
        }

        /* Market Price Items */
        .market-item {
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .market-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .market-item.selected {
            border: 2px solid var(--accent-blue);
        }

        .market-item::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 8px;
            height: 8px;
            background: var(--accent-blue);
            border-radius: 50%;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .market-item.selected::after {
            opacity: 1;
        }

        /* List View Styles */
        .market-list-view {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .market-list-item {
            display: grid;
            grid-template-columns: 100px 1fr 120px 100px 120px;
            gap: 16px;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .market-list-item:hover {
            background: var(--border-color);
        }

        .market-list-item.selected {
            background: rgba(88, 166, 255, 0.1);
            border-left: 3px solid var(--accent-blue);
        }

        /* Compact View Styles */
        .market-compact-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 8px;
        }

        .market-compact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .market-compact-item:hover {
            background: var(--border-color);
        }

        .market-compact-item.selected {
            background: rgba(88, 166, 255, 0.1);
            border: 1px solid var(--accent-blue);
        }

        /* Quick Trade Modal */
        .quick-trade-modal {
            position: fixed;
            z-index: 1001;
            background: var(--bg-secondary);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            min-width: 320px;
            max-width: 400px;
            border: 1px solid var(--border-color);
            animation: quickTradeSlideIn 0.2s ease-out;
        }

        @keyframes quickTradeSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .quick-trade-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-trade-coin-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .quick-trade-symbol {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .quick-trade-change {
            font-size: 14px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .quick-trade-change.positive {
            background: rgba(63, 185, 80, 0.15);
            color: var(--accent-green);
        }

        .quick-trade-change.negative {
            background: rgba(248, 81, 73, 0.15);
            color: var(--accent-red);
        }

        .quick-trade-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .quick-trade-close:hover {
            color: var(--text-primary);
        }

        .quick-trade-body {
            padding: 20px;
        }

        .quick-trade-price {
            text-align: center;
            margin-bottom: 20px;
        }

        .quick-trade-current-price {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .quick-trade-price-sub {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .quick-trade-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }

        .quick-trade-stat {
            text-align: center;
        }

        .quick-trade-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .quick-trade-stat-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 2px;
        }

        .quick-trade-amount {
            margin-bottom: 16px;
        }

        .quick-trade-amount label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .quick-trade-amount-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            text-align: right;
        }

        .quick-trade-amount-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .quick-trade-presets {
            display: flex;
            gap: 6px;
            margin-top: 8px;
        }

        .quick-trade-preset {
            flex: 1;
            padding: 8px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-trade-preset:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .quick-trade-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .quick-trade-btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-trade-btn.buy {
            background: var(--accent-green);
            color: white;
        }

        .quick-trade-btn.buy:hover {
            background: #2ea043;
        }

        .quick-trade-btn.sell {
            background: var(--accent-red);
            color: white;
        }

        .quick-trade-btn.sell:hover {
            background: #da3633;
        }

        .quick-trade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .quick-trade-footer {
            padding: 12px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-trade-chart-btn {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .quick-trade-chart-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .quick-trade-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
        }

        /* Overview Stat Cards */
        .overview-large-stat {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
        }

        .overview-large-stat .stat-label {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .overview-large-stat .stat-value {
            font-size: 32px;
            font-weight: 700;
        }

        .overview-large-stat .stat-change {
            font-size: 14px;
            margin-top: 8px;
        }

        /* Mini Sparkline */
        .mini-sparkline {
            display: flex;
            align-items: flex-end;
            gap: 1px;
            height: 30px;
            width: 60px;
        }

        .mini-sparkline-bar {
            flex: 1;
            min-width: 2px;
            border-radius: 1px 1px 0 0;
            opacity: 0.8;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .coin-metrics {
                grid-template-columns: 1fr;
            }

            .indicator-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .market-list-item {
                grid-template-columns: 80px 1fr 80px;
            }

            .market-list-item > *:nth-child(4),
            .market-list-item > *:nth-child(5) {
                display: none;
            }
        }

        /* Large Account Details Grid */
        .account-large-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
        }
        .account-large-item {
            background: var(--bg-tertiary);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
        }
        .account-large-label {
            font-size: 1rem;
            color: var(--text-muted);
            margin-bottom: 10px;
            font-weight: 500;
        }
        .account-large-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .account-large-value.positive { color: var(--success); }
        .account-large-value.negative { color: var(--danger); }

        /* Large Positions Grid */
        .positions-large-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }
        .position-large-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-color);
        }
        .position-large-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            border-color: var(--primary);
        }
        .position-large-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .position-large-coin {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        .position-large-percent {
            font-size: 1.3rem;
            font-weight: 700;
        }
        .position-large-percent.positive { color: var(--success); }
        .position-large-percent.negative { color: var(--danger); }
        .position-large-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }
        .position-large-stat {
            text-align: center;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .position-large-stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .position-large-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .position-large-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }
        .position-large-footer-label {
            font-size: 1rem;
            color: var(--text-muted);
        }
        .position-large-profit {
            font-size: 1.3rem;
            font-weight: 700;
        }
        .position-large-profit.positive { color: var(--success); }
        .position-large-profit.negative { color: var(--danger); }

        @media (max-width: 768px) {
            .account-large-grid {
                grid-template-columns: 1fr;
            }
            .positions-large-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 확장 가능한 에러 아이템 스타일 */
        .error-item {
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
            margin-bottom: 6px;
            overflow: hidden;
        }
        .error-item:last-child {
            margin-bottom: 0;
        }
        .error-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 8px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .error-header:hover {
            background: rgba(255,255,255,0.1);
        }
        .error-summary {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-right: 8px;
        }
        .error-toggle {
            font-size: 10px;
            color: var(--text-secondary);
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            white-space: nowrap;
        }
        .error-details {
            display: none;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-top: 1px solid rgba(255,255,255,0.1);
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            font-size: 10px;
            line-height: 1.4;
        }
        .error-item.expanded .error-details {
            display: block;
        }
        .error-item.expanded .error-toggle {
            background: var(--accent-red);
            color: white;
        }
        .error-time {
            color: var(--text-secondary);
            font-size: 10px;
            margin-right: 6px;
        }

        /* Toggle Switch Styles */
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            cursor: pointer;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-tertiary);
            border-radius: 26px;
            transition: 0.3s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 2px;
            background-color: var(--text-secondary);
            border-radius: 50%;
            transition: 0.3s;
        }
        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-green);
            border-color: var(--accent-green);
        }
        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(24px);
            background-color: white;
        }
        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Optimization Settings Card */
        .optimization-settings {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .optimization-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 8px;
        }
        .optimization-row-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .optimization-row-label {
            font-weight: 600;
            color: var(--text-primary);
        }
        .optimization-row-desc {
            font-size: 12px;
            color: var(--text-muted);
        }
        .optimization-row-control {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .interval-select {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 14px;
            min-width: 120px;
        }
        .interval-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }
        .optimization-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            font-size: 12px;
        }
        .optimization-status.running {
            color: var(--accent-green);
        }
        .optimization-status.stopped {
            color: var(--text-muted);
        }
        .optimization-status .pulse-dot {
            width: 8px;
            height: 8px;
        }
        .next-run-info {
            font-size: 12px;
            color: var(--text-muted);
            padding: 12px 16px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            border-left: 3px solid var(--accent-blue);
        }

        /* 숫자 롤링 애니메이션 (슬롯머신 효과) */
        .rolling-number {
            display: inline-flex;
            overflow: hidden;
            position: relative;
        }
        .rolling-digit {
            display: inline-block;
            position: relative;
            overflow: hidden;
            height: 1.2em;
            line-height: 1.2em;
        }
        .rolling-digit-inner {
            display: flex;
            flex-direction: column;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .rolling-digit-inner span {
            height: 1.2em;
            line-height: 1.2em;
        }
        .rolling-digit.rolling .rolling-digit-inner {
            animation: rollDigit 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        @keyframes rollDigit {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(0); }
        }
        .price-flash-up {
            animation: flashUp 0.5s ease-out;
        }
        .price-flash-down {
            animation: flashDown 0.5s ease-out;
        }
        @keyframes flashUp {
            0% { background-color: rgba(46, 204, 113, 0.3); }
            100% { background-color: transparent; }
        }
        @keyframes flashDown {
            0% { background-color: rgba(231, 76, 60, 0.3); }
            100% { background-color: transparent; }
        }
        .market-price-value {
            transition: color 0.2s ease;
        }
        .market-price-value.price-up {
            color: var(--accent-green) !important;
        }
        .market-price-value.price-down {
            color: var(--accent-red) !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>
                <span>&#129302;</span>
                CoinPilot
            </h1>
            <div class="header-status" id="systemStatus">
                <div class="loading"><div class="spinner"></div>로딩 중...</div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="trading">Trading</button>
            <button class="tab" data-tab="portfolio">Portfolio</button>
            <button class="tab" data-tab="market">Market</button>
            <button class="tab" data-tab="analysis">Analysis</button>
            <button class="tab" data-tab="news">News</button>
            <button class="tab" data-tab="parameters">Parameters</button>
            <button class="tab" data-tab="history">History</button>
        </div>

        <!-- Overview Tab -->
        <div id="tab-overview" class="tab-content">
            <!-- 시스템 상태 & 오늘의 거래 요약 -->
            <div class="grid grid-2" style="margin-bottom: 20px;">
                <!-- 시스템 상태 -->
                <div class="card">
                    <div class="card-header">
                        <h2>⚙️ 시스템 상태</h2>
                        <span id="systemStatusBadge" class="badge badge-running">-</span>
                    </div>
                    <div class="card-body" id="systemStatusContent">
                        <div class="system-status-grid">
                            <div class="status-item">
                                <span class="status-icon">⏱️</span>
                                <div class="status-info">
                                    <div class="status-label">서버 가동시간</div>
                                    <div class="status-value" id="sysUptime">-</div>
                                </div>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">🔄</span>
                                <div class="status-info">
                                    <div class="status-label">마지막 분석</div>
                                    <div class="status-value" id="sysLastAnalysis">-</div>
                                </div>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">⏰</span>
                                <div class="status-info">
                                    <div class="status-label">분석 주기</div>
                                    <div class="status-value" id="sysInterval">-</div>
                                </div>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">📊</span>
                                <div class="status-info">
                                    <div class="status-label">포지션</div>
                                    <div class="status-value" id="sysPositions">-</div>
                                </div>
                            </div>
                        </div>
                        <div id="systemErrors" style="margin-top: 10px; display: none;">
                            <div style="color: var(--accent-red); font-size: 12px; padding: 8px; background: rgba(248,81,73,0.1); border-radius: 6px;">
                                <strong>⚠️ 최근 에러:</strong>
                                <div id="errorList" style="margin-top: 5px; font-family: monospace; font-size: 11px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 오늘의 거래 요약 -->
                <div class="card">
                    <div class="card-header">
                        <h2>📅 오늘의 거래</h2>
                        <span id="todayDate" style="color: var(--text-muted); font-size: 12px;">-</span>
                    </div>
                    <div class="card-body">
                        <div class="today-summary-grid">
                            <div class="today-stat">
                                <div class="today-stat-value" id="todayTotalTrades">0</div>
                                <div class="today-stat-label">총 거래</div>
                            </div>
                            <div class="today-stat">
                                <div class="today-stat-value positive" id="todayBuyCount">0</div>
                                <div class="today-stat-label">매수</div>
                            </div>
                            <div class="today-stat">
                                <div class="today-stat-value negative" id="todaySellCount">0</div>
                                <div class="today-stat-label">매도</div>
                            </div>
                            <div class="today-stat">
                                <div class="today-stat-value" id="todayProfit">0원</div>
                                <div class="today-stat-label">실현 손익</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px;">
                                <span style="color: var(--text-muted);">총 매수금액</span>
                                <span id="todayBuyAmount" style="color: var(--accent-green);">0원</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 8px;">
                                <span style="color: var(--text-muted);">총 매도금액</span>
                                <span id="todaySellAmount" style="color: var(--accent-red);">0원</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px; font-weight: 600;">
                                <span style="color: var(--text-muted);">순 자금흐름</span>
                                <span id="todayNetFlow">0원</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Market Overview -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2>&#128200; 시장 현황</h2>
                </div>
                <div class="card-body">
                    <div id="marketOverview">
                        <div class="loading"><div class="spinner"></div>로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trading Tab (수동 매매) -->
        <div id="tab-trading" class="tab-content" style="display: none;">
            <!-- 수동 매매 패널 -->
            <div class="grid grid-2" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <h2>🛒 스마트 매수</h2>
                        <span style="font-size: 12px; color: var(--text-muted);">자동 선별 분산 투자</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">총 투자금액 (KRW)</label>
                            <input type="text" id="quickBuyAmount" class="form-input money-input" placeholder="예: 100,000" value="100,000">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px; color: var(--text-muted);">보유 현금 기준 비율</label>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button class="btn btn-sm preset-btn" onclick="setBuyPreset(0)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">초기화</button>
                                <button class="btn btn-sm preset-btn" onclick="setBuyPreset(10)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">10%</button>
                                <button class="btn btn-sm preset-btn" onclick="setBuyPreset(25)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">25%</button>
                                <button class="btn btn-sm preset-btn" onclick="setBuyPreset(50)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">50%</button>
                                <button class="btn btn-sm preset-btn" onclick="setBuyPreset(75)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">75%</button>
                                <button class="btn btn-sm preset-btn" onclick="setBuyPreset(100)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">100%</button>
                            </div>
                            <div id="buyPresetInfo" style="font-size: 11px; color: var(--text-muted); margin-top: 5px; text-align: right;">보유: <span id="availableKrwDisplay">-</span></div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">💡 자동 선별 매수</div>
                            <div style="font-size: 13px;">거래량 상위 30개 코인 중 매수 점수 60점 이상인 코인에 자동 분배 투자</div>
                        </div>
                        <button class="btn btn-success" style="width: 100%;" onclick="executeSmartBuy()">
                            <span>🛒</span> 스마트 매수 실행
                        </button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>💰 스마트 매도</h2>
                        <span style="font-size: 12px; color: var(--text-muted);">목표 금액 분할 매도</span>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">목표 매도금액 (KRW)</label>
                            <input type="text" id="quickSellAmount" class="form-input money-input" placeholder="예: 100,000" value="100,000">
                        </div>
                        <div class="form-group">
                            <label class="form-label" style="font-size: 11px; color: var(--text-muted);">보유 코인 평가액 기준 비율</label>
                            <div style="display: flex; gap: 6px; flex-wrap: wrap;">
                                <button class="btn btn-sm preset-btn" onclick="setSellPreset(0)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">초기화</button>
                                <button class="btn btn-sm preset-btn" onclick="setSellPreset(10)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">10%</button>
                                <button class="btn btn-sm preset-btn" onclick="setSellPreset(25)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">25%</button>
                                <button class="btn btn-sm preset-btn" onclick="setSellPreset(50)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">50%</button>
                                <button class="btn btn-sm preset-btn" onclick="setSellPreset(75)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">75%</button>
                                <button class="btn btn-sm preset-btn" onclick="setSellPreset(100)" style="flex: 1; min-width: 45px; padding: 6px 4px; font-size: 11px;">100%</button>
                            </div>
                            <div id="sellPresetInfo" style="font-size: 11px; color: var(--text-muted); margin-top: 5px; text-align: right;">보유 평가액: <span id="totalHoldingDisplay">-</span></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">매도 전략</label>
                            <select id="quickSellStrategy" class="form-input">
                                <option value="worst">손실 큰 것부터 (손절)</option>
                                <option value="best">수익 큰 것부터 (익절)</option>
                                <option value="overbought">과매수(RSI 높은) 것부터</option>
                            </select>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 15px;">
                            <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">💡 목표 금액 매도</div>
                            <div style="font-size: 13px;">선택한 전략 순서대로 목표 금액에 도달할 때까지 분할 매도</div>
                        </div>
                        <button class="btn btn-danger" style="width: 100%;" onclick="executeSmartSell()">
                            <span>💰</span> 스마트 매도 실행
                        </button>
                    </div>
                </div>
            </div>

            <!-- 매수/매도 추천 -->
            <div class="grid grid-2" style="margin-bottom: 20px;">
                <div class="card">
                    <div class="card-header">
                        <h2>📈 매수 추천</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadBuyRecommendations()">새로고침</button>
                    </div>
                    <div class="card-body">
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid var(--accent-green);">
                            <div style="font-size: 13px;">현재 매수하기 좋은 코인들을 분석하여 추천합니다. 직접 금액을 입력하고 매수하세요.</div>
                        </div>
                        <div id="buyRecommendations" style="max-height: 350px; overflow-y: auto;">
                            <div class="loading"><div class="spinner"></div>분석 중...</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>📉 매도 추천</h2>
                        <button class="btn btn-secondary btn-sm" onclick="loadSellRecommendations()">새로고침</button>
                    </div>
                    <div class="card-body">
                        <div style="background: var(--bg-tertiary); padding: 12px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid var(--accent-red);">
                            <div style="font-size: 13px;">보유 중인 코인 중 매도하기 좋은 종목을 분석하여 추천합니다.</div>
                        </div>
                        <div id="sellRecommendations" style="max-height: 350px; overflow-y: auto;">
                            <div class="loading"><div class="spinner"></div>분석 중...</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 보유 포지션 -->
            <div class="card">
                <div class="card-header">
                    <h2>💼 보유 포지션</h2>
                    <button class="btn btn-secondary btn-sm" onclick="loadManualPositions()">새로고침</button>
                </div>
                <div class="card-body">
                    <div id="manualPositions" style="max-height: 500px; overflow-y: auto;">
                        <div class="loading"><div class="spinner"></div>로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Tab -->
        <div id="tab-portfolio" class="tab-content" style="display: none;">
            <!-- Large Portfolio Stats -->
            <div class="grid grid-4" style="margin-bottom: 20px;">
                <div class="overview-large-stat" id="portfolioTotalAssets">
                    <div class="stat-label">총 평가자산</div>
                    <div class="stat-value">-</div>
                </div>
                <div class="overview-large-stat" id="portfolioCumulativePnL">
                    <div class="stat-label">누적손익 (시드머니 대비)</div>
                    <div class="stat-value">-</div>
                    <div class="stat-change">-</div>
                </div>
                <div class="overview-large-stat" id="portfolioTotalProfit">
                    <div class="stat-label">평가손익 (보유코인)</div>
                    <div class="stat-value">-</div>
                    <div class="stat-change">-</div>
                </div>
                <div class="overview-large-stat" id="portfolioWinRate">
                    <div class="stat-label">승률</div>
                    <div class="stat-value">-</div>
                    <div class="stat-change">-</div>
                </div>
            </div>

            <!-- 포트폴리오 분석 -->
            <div class="grid grid-2" style="margin-bottom: 20px;">
                <!-- 포트폴리오 비중 차트 -->
                <div class="card">
                    <div class="card-header">
                        <h2>🥧 포트폴리오 구성</h2>
                    </div>
                    <div class="card-body">
                        <div style="display: flex; gap: 20px; align-items: center;">
                            <div id="portfolioPieChart" style="width: 160px; height: 160px; flex-shrink: 0;">
                                <!-- SVG 파이 차트 -->
                            </div>
                            <div id="portfolioLegend" style="flex: 1; max-height: 160px; overflow-y: auto;">
                                <!-- 범례 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 상위 수익/손실 코인 -->
                <div class="card">
                    <div class="card-header">
                        <h2>🏆 수익/손실 TOP</h2>
                    </div>
                    <div class="card-body">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <div style="font-size: 12px; color: var(--accent-green); margin-bottom: 8px; font-weight: 600;">📈 상위 수익</div>
                                <div id="topGainers" style="font-size: 13px;">
                                    <div style="color: var(--text-muted); padding: 10px; text-align: center;">-</div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 12px; color: var(--accent-red); margin-bottom: 8px; font-weight: 600;">📉 상위 손실</div>
                                <div id="topLosers" style="font-size: 13px;">
                                    <div style="color: var(--text-muted); padding: 10px; text-align: center;">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Virtual Wallet Panel (Dry Run Only) -->
            <div id="virtualWalletPanel" class="card" style="margin-bottom: 20px; display: none;">
                <div class="card-header">
                    <h2>💰 모의투자 가상지갑</h2>
                    <span class="badge badge-dry">DRY RUN 전용</span>
                </div>
                <div class="card-body">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; align-items: end;">
                        <!-- 입금 -->
                        <div>
                            <label class="form-label">입금</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="depositAmount" class="form-input" placeholder="금액 (원)" min="1000" step="1000" style="flex: 1;">
                                <button class="btn btn-success" onclick="virtualDeposit()">입금</button>
                            </div>
                        </div>
                        <!-- 출금 -->
                        <div>
                            <label class="form-label">출금</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="withdrawAmount" class="form-input" placeholder="금액 (원)" min="1000" step="1000" style="flex: 1;">
                                <button class="btn btn-danger" onclick="virtualWithdraw()">출금</button>
                            </div>
                        </div>
                        <!-- 빠른 입금 버튼 -->
                        <div>
                            <label class="form-label">빠른 입금</label>
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <button class="btn btn-secondary btn-sm" onclick="quickDeposit(100000)">+10만</button>
                                <button class="btn btn-secondary btn-sm" onclick="quickDeposit(500000)">+50만</button>
                                <button class="btn btn-secondary btn-sm" onclick="quickDeposit(1000000)">+100만</button>
                            </div>
                        </div>
                        <!-- 리셋 -->
                        <div>
                            <label class="form-label">시드머니 리셋</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="resetSeedMoney" class="form-input" placeholder="새 시드머니 (원)" min="100000" step="100000" style="flex: 1;">
                                <button class="btn btn-secondary" onclick="virtualReset()" style="background: var(--accent-yellow); color: #000;">리셋</button>
                            </div>
                        </div>
                    </div>
                    <div id="virtualWalletMessage" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
                </div>
            </div>

            <!-- Asset History Chart -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2>📊 자산 추이</h2>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" data-period="10s" onclick="loadPortfolioHistory('10s', true)">10초</button>
                        <button class="btn btn-secondary btn-sm" data-period="30s" onclick="loadPortfolioHistory('30s', true)">30초</button>
                        <button class="btn btn-secondary btn-sm" data-period="1m" onclick="loadPortfolioHistory('1m', true)">1분</button>
                        <button class="btn btn-secondary btn-sm" data-period="5m" onclick="loadPortfolioHistory('5m', true)">5분</button>
                        <button class="btn btn-secondary btn-sm" data-period="15m" onclick="loadPortfolioHistory('15m', true)">15분</button>
                        <button class="btn btn-secondary btn-sm" data-period="30m" onclick="loadPortfolioHistory('30m', true)">30분</button>
                        <button class="btn btn-secondary btn-sm" data-period="1h" onclick="loadPortfolioHistory('1h', true)">1시간</button>
                        <button class="btn btn-secondary btn-sm active" data-period="24h" onclick="loadPortfolioHistory('24h', true)">24시간</button>
                        <button class="btn btn-secondary btn-sm" data-period="7d" onclick="loadPortfolioHistory('7d', true)">7일</button>
                        <button class="btn btn-secondary btn-sm" data-period="30d" onclick="loadPortfolioHistory('30d', true)">30일</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="portfolioChart" style="height: 250px; position: relative;">
                        <div class="loading"><div class="spinner"></div>데이터 수집 중...</div>
                    </div>
                    <div id="portfolioChartStats" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px;">
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">시작 자산</div>
                            <div id="chartStartValue" style="font-weight: 600;">-</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">현재 자산</div>
                            <div id="chartEndValue" style="font-weight: 600;">-</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">변동</div>
                            <div id="chartChange" style="font-weight: 600;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Profit Rate History Chart -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2>📈 수익률 추이</h2>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" data-profit-period="10s" onclick="loadProfitHistory('10s', true)">10초</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="30s" onclick="loadProfitHistory('30s', true)">30초</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="1m" onclick="loadProfitHistory('1m', true)">1분</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="5m" onclick="loadProfitHistory('5m', true)">5분</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="15m" onclick="loadProfitHistory('15m', true)">15분</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="30m" onclick="loadProfitHistory('30m', true)">30분</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="1h" onclick="loadProfitHistory('1h', true)">1시간</button>
                        <button class="btn btn-secondary btn-sm active" data-profit-period="24h" onclick="loadProfitHistory('24h', true)">24시간</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="7d" onclick="loadProfitHistory('7d', true)">7일</button>
                        <button class="btn btn-secondary btn-sm" data-profit-period="30d" onclick="loadProfitHistory('30d', true)">30일</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="profitChart" style="height: 250px; position: relative;">
                        <div class="loading"><div class="spinner"></div>데이터 수집 중...</div>
                    </div>
                    <div id="profitChartStats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px;">
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">시작 수익률</div>
                            <div id="profitChartStart" style="font-weight: 600;">-</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">현재 수익률</div>
                            <div id="profitChartEnd" style="font-weight: 600;">-</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">최고 수익률</div>
                            <div id="profitChartMax" style="font-weight: 600;">-</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background: var(--bg-tertiary); border-radius: 6px;">
                            <div style="font-size: 11px; color: var(--text-muted);">최저 수익률</div>
                            <div id="profitChartMin" style="font-weight: 600;">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Details - Full Width Large -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header" style="padding: 20px 25px;">
                    <h2 style="font-size: 1.5rem;">&#128176; 계좌 상세</h2>
                </div>
                <div class="card-body" id="accountInfo" style="padding: 25px; font-size: 1.1rem;">
                    <div class="loading"><div class="spinner"></div>로딩 중...</div>
                </div>
            </div>

            <!-- Positions - Full Width Large -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header" style="padding: 20px 25px;">
                    <h2 style="font-size: 1.5rem;">&#127919; 보유 포지션</h2>
                </div>
                <div class="card-body" id="positions" style="padding: 25px; min-height: 300px; max-height: 600px; overflow-y: auto;">
                    <div class="loading"><div class="spinner"></div>로딩 중...</div>
                </div>
            </div>

            <!-- Trading Stats & Recent Trades -->
            <div class="grid grid-2">
                <div class="card">
                    <div class="card-header">
                        <h2>&#128200; 코인별 거래 통계</h2>
                    </div>
                    <div class="card-body" id="tradeStats" style="max-height: 350px; overflow-y: auto;">
                        <div class="loading"><div class="spinner"></div>로딩 중...</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>&#128220; 최근 거래 내역</h2>
                    </div>
                    <div class="card-body">
                        <div class="table-container" id="recentTrades" style="max-height: 350px; overflow-y: auto;">
                            <div class="loading"><div class="spinner"></div>로딩 중...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Market Tab -->
        <div id="tab-market" class="tab-content" style="display: none;">
            <!-- Chart Section (상단으로 이동) -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2>&#128202; Price Chart</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="chartCoin" class="form-input" style="width: auto;" onchange="loadChart()">
                            <!-- 동적으로 로드됨 -->
                        </select>
                        <select id="chartInterval" class="form-input" style="width: auto;" onchange="loadChart()">
                            <option value="1">1분</option>
                            <option value="5" selected>5분</option>
                            <option value="15">15분</option>
                            <option value="60">1시간</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div id="priceChart" style="height: 300px; position: relative;">
                        <div class="loading"><div class="spinner"></div>Loading chart...</div>
                    </div>
                </div>
            </div>

            <!-- Inline Trade Panel (차트 아래 매수/매도 패널) -->
            <div id="inlineTradePanel" class="card" style="margin-bottom: 20px; display: none;">
                <div class="card-body" style="padding: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span id="inlineTradeCoin" style="font-size: 20px; font-weight: 700; color: var(--text-primary);">BTC</span>
                            <span id="inlineTradeChange" class="positive" style="font-size: 14px; font-weight: 600;">+0.00%</span>
                        </div>
                        <div style="text-align: right;">
                            <div id="inlineTradePrice" style="font-size: 22px; font-weight: 700; color: var(--text-primary);">0원</div>
                            <div id="inlineTradePriceSub" style="font-size: 12px; color: var(--text-muted);">24시간 변동: 0원</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">24h 고가</div>
                            <div id="inlineTradeHigh" style="font-size: 13px; font-weight: 600; color: var(--accent-red);">0원</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">24h 저가</div>
                            <div id="inlineTradeLow" style="font-size: 13px; font-weight: 600; color: var(--accent-blue);">0원</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">거래량</div>
                            <div id="inlineTradeVolume" style="font-size: 13px; font-weight: 600;">0억</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">보유수량</div>
                            <div id="inlineTradeHolding" style="font-size: 13px; font-weight: 600; color: var(--accent-yellow);">-</div>
                        </div>
                    </div>

                    <div id="inlineTradeHoldingInfo" style="display: none; padding: 10px 12px; background: var(--bg-secondary); border-radius: 6px; margin-bottom: 16px; border-left: 3px solid var(--accent-yellow);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: var(--text-muted);">보유평가</span>
                            <span id="inlineTradeHoldingValue" style="font-size: 14px; font-weight: 600;">0원</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 12px; color: var(--text-muted);">평균단가</span>
                            <span id="inlineTradeAvgPrice" style="font-size: 14px; font-weight: 600;">0원</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 12px; color: var(--text-muted);">손익</span>
                            <span id="inlineTradePnL" style="font-size: 14px; font-weight: 600;">0원 (0%)</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 6px;">매수/매도 금액 (KRW)</label>
                            <input type="number" id="inlineTradeAmount" class="form-input" placeholder="금액 입력" value="50000" style="width: 100%;">
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 11px; color: var(--text-muted); display: block; margin-bottom: 6px;">예상 수량</label>
                            <div id="inlineTradeEstQty" style="padding: 10px 12px; background: var(--bg-tertiary); border-radius: 6px; font-size: 14px; color: var(--text-secondary);">0.00000000</div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmount(10000)">1만</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmount(50000)">5만</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmount(100000)">10만</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmount(500000)">50만</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmount(1000000)">100만</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmountPercent(25)">25%</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmountPercent(50)">50%</button>
                        <button class="btn btn-secondary btn-sm" onclick="setInlineTradeAmountPercent(100)">전액</button>
                    </div>

                    <div style="display: flex; gap: 12px;">
                        <button id="inlineTradeBuyBtn" class="btn btn-success" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 700;" onclick="executeInlineTrade('BUY')">
                            매수
                        </button>
                        <button id="inlineTradeSellBtn" class="btn btn-danger" style="flex: 1; padding: 14px; font-size: 16px; font-weight: 700;" onclick="executeInlineTrade('SELL')" disabled>
                            매도
                        </button>
                    </div>
                </div>
            </div>

            <!-- Market Prices -->
            <div class="card">
                <div class="card-header">
                    <h2>&#128200; Real-time Prices</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <!-- View Mode Selector -->
                        <div class="view-mode-selector">
                            <button class="view-mode-btn active" data-view="grid" onclick="setMarketViewMode('grid')" title="Grid View">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <rect x="1" y="1" width="6" height="6" rx="1"/>
                                    <rect x="9" y="1" width="6" height="6" rx="1"/>
                                    <rect x="1" y="9" width="6" height="6" rx="1"/>
                                    <rect x="9" y="9" width="6" height="6" rx="1"/>
                                </svg>
                            </button>
                            <button class="view-mode-btn" data-view="list" onclick="setMarketViewMode('list')" title="List View">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <rect x="1" y="1" width="14" height="3" rx="1"/>
                                    <rect x="1" y="6" width="14" height="3" rx="1"/>
                                    <rect x="1" y="11" width="14" height="3" rx="1"/>
                                </svg>
                            </button>
                            <button class="view-mode-btn" data-view="compact" onclick="setMarketViewMode('compact')" title="Compact View">
                                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                                    <rect x="1" y="2" width="14" height="2" rx="0.5"/>
                                    <rect x="1" y="7" width="14" height="2" rx="0.5"/>
                                    <rect x="1" y="12" width="14" height="2" rx="0.5"/>
                                </svg>
                            </button>
                        </div>
                        <select id="marketSort" class="form-input" style="width: auto;" onchange="sortMarketPrices()">
                            <option value="volume">거래량순</option>
                            <option value="change_desc">변동률↓</option>
                            <option value="change_asc">변동률↑</option>
                            <option value="name">이름순</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="loadMarketPrices()">Refresh</button>
                    </div>
                </div>
                <div class="card-body">
                    <div id="marketPrices">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Coin Analysis Tab -->
        <div id="tab-analysis" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>📊 AI 코인 평가</h2>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <select id="analysisFilter" class="form-input" style="width: auto; min-width: 120px;" onchange="filterAnalysisResults()">
                            <option value="all">전체</option>
                            <option value="buy">매수 추천</option>
                            <option value="sell">매도 추천</option>
                            <option value="hold">관망</option>
                            <option value="strong">강한 신호</option>
                        </select>
                        <select id="analysisSort" class="form-input" style="width: auto; min-width: 120px;" onchange="sortAnalysisResults()">
                            <option value="score">총점순</option>
                            <option value="buy">매수점수순</option>
                            <option value="sell">매도점수순</option>
                            <option value="volume">거래량순</option>
                            <option value="change">변동률순</option>
                        </select>
                        <button class="btn btn-secondary btn-sm" onclick="loadCoinAnalysis()">새로고침</button>
                    </div>
                </div>
                <div class="card-body" style="padding: 0;">
                    <!-- 요약 통계 -->
                    <div id="analysisStats" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; padding: 16px; background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">분석 코인</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">매수 추천</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-red);">-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">매도 추천</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-yellow);">-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">관망</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">-</div>
                            <div style="font-size: 11px; color: var(--text-muted);">강한 신호</div>
                        </div>
                    </div>
                    <!-- 테이블 헤더 -->
                    <div style="display: grid; grid-template-columns: 140px 100px 80px 60px 60px 80px 100px 100px 70px; gap: 8px; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border-color); font-size: 11px; font-weight: 600; color: var(--text-muted);">
                        <div>코인</div>
                        <div style="text-align: right;">현재가</div>
                        <div style="text-align: right;">24h</div>
                        <div style="text-align: center;">RSI</div>
                        <div style="text-align: center;">MACD</div>
                        <div style="text-align: center;">점수</div>
                        <div style="text-align: center;">신호강도</div>
                        <div style="text-align: center;">추천</div>
                        <div style="text-align: center;">매매</div>
                    </div>
                    <!-- 코인 리스트 -->
                    <div id="coinAnalysis" style="max-height: 600px; overflow-y: auto;">
                        <div class="loading" style="padding: 40px;"><div class="spinner"></div>상위 100개 코인 분석 중... (약 30초 소요)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- News Tab -->
        <div id="tab-news" class="tab-content" style="display: none;">
            <!-- Market Sentiment Overview -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2>&#128200; 뉴스 시장 심리</h2>
                    <button class="btn btn-secondary btn-sm" onclick="loadNews()">새로고침</button>
                </div>
                <div class="card-body">
                    <div id="newsSentimentOverview">
                        <div class="loading"><div class="spinner"></div>뉴스 분석 중...</div>
                    </div>
                </div>
            </div>

            <!-- News List -->
            <div class="card">
                <div class="card-header">
                    <h2>&#128240; 최신 암호화폐 뉴스</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <select id="newsFilter" class="form-input" style="width: auto;" onchange="filterNews()">
                            <option value="all">전체</option>
                            <option value="positive">긍정적</option>
                            <option value="negative">부정적</option>
                            <option value="neutral">중립</option>
                        </select>
                        <select id="newsSource" class="form-input" style="width: auto;" onchange="filterNews()">
                            <option value="all">전체 소스</option>
                            <option value="CoinDesk">CoinDesk</option>
                            <option value="CoinTelegraph">CoinTelegraph</option>
                            <option value="Naver">Naver</option>
                            <option value="Google News">Google News</option>
                            <option value="Google News KR">Google News KR</option>
                            <option value="twitter">Twitter/X</option>
                        </select>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <input type="text" id="coinNewsSearch" class="form-input" style="width: 100px;" placeholder="코인 (BTC)">
                            <button class="btn btn-sm" style="background: var(--accent-blue); padding: 6px 12px;" onclick="searchCoinNews()">코인별 뉴스</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="coinNewsHeader" style="display: none; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span id="coinNewsTitle" style="font-weight: 600;"></span>
                            <button class="btn btn-sm" style="background: var(--text-muted); padding: 4px 10px;" onclick="clearCoinNewsFilter()">전체 뉴스 보기</button>
                        </div>
                        <div id="coinNewsSources" style="margin-top: 8px; font-size: 12px; color: var(--text-muted);"></div>
                    </div>
                    <div id="newsList" style="max-height: 600px; overflow-y: auto;">
                        <div class="loading"><div class="spinner"></div>뉴스 로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Parameters Tab -->
        <div id="tab-parameters" class="tab-content" style="display: none;">
            <!-- Auto Optimization Settings -->
            <div class="card">
                <div class="card-header">
                    <h2>🧬 자동 최적화 설정</h2>
                    <div class="optimization-status" id="optimizationStatus">
                        <span class="pulse-dot"></span>
                        <span id="optimizationStatusText">확인 중...</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="optimization-settings">
                        <div class="optimization-row">
                            <div class="optimization-row-info">
                                <span class="optimization-row-label">자동 최적화</span>
                                <span class="optimization-row-desc">유전 알고리즘을 사용하여 주기적으로 파라미터를 최적화합니다</span>
                            </div>
                            <div class="optimization-row-control">
                                <label class="toggle-switch">
                                    <input type="checkbox" id="autoOptimizationToggle" onchange="toggleAutoOptimization()">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>
                        <div class="optimization-row">
                            <div class="optimization-row-info">
                                <span class="optimization-row-label">최적화 주기</span>
                                <span class="optimization-row-desc">얼마나 자주 파라미터를 최적화할지 설정합니다</span>
                            </div>
                            <div class="optimization-row-control">
                                <select class="interval-select" id="optimizationInterval" onchange="updateOptimizationInterval()">
                                    <option value="3600000">1시간</option>
                                    <option value="7200000">2시간</option>
                                    <option value="10800000">3시간</option>
                                    <option value="21600000">6시간</option>
                                    <option value="43200000">12시간</option>
                                    <option value="86400000">24시간</option>
                                </select>
                            </div>
                        </div>
                        <div class="optimization-row">
                            <div class="optimization-row-info">
                                <span class="optimization-row-label">즉시 실행</span>
                                <span class="optimization-row-desc">현재 설정으로 즉시 최적화를 실행합니다</span>
                            </div>
                            <div class="optimization-row-control">
                                <button class="btn btn-primary btn-sm" id="runOptimizationNow" onclick="runOptimizationNow()">
                                    지금 실행
                                </button>
                            </div>
                        </div>
                        <div class="next-run-info" id="nextOptimizationInfo">
                            다음 최적화 예정: <span id="nextOptimizationTime">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Investment Presets -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2>🎯 투자 성향 프리셋</h2>
                    <span style="font-size: 12px; color: var(--text-muted);">클릭하여 프리셋 적용</span>
                </div>
                <div class="card-body">
                    <div class="preset-grid" id="investmentPresets">
                        <div class="loading"><div class="spinner"></div>로딩 중...</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2>&#9881;&#65039; 트레이딩 파라미터 설정</h2>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary btn-sm" onclick="applyParameters()">변경사항 적용</button>
                        <button class="btn btn-secondary btn-sm" onclick="reloadParametersFromServer()">서버에서 다시 로드</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="param-grid" id="parameterSettings">
                        <div class="loading"><div class="spinner"></div>로딩 중...</div>
                    </div>
                </div>
            </div>

            <!-- Current Optimal Config -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2>&#129303; 현재 최적화 파라미터</h2>
                </div>
                <div class="card-body" id="optimalParams">
                    <div class="loading"><div class="spinner"></div>로딩 중...</div>
                </div>
            </div>
        </div>

        <!-- History Tab -->
        <div id="tab-history" class="tab-content" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h2>&#128202; 최적화 이력</h2>
                </div>
                <div class="card-body" id="optimizationHistory">
                    <div class="loading"><div class="spinner"></div>로딩 중...</div>
                </div>
            </div>

            <!-- Backtest Results -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2>&#128203; 백테스팅 결과</h2>
                </div>
                <div class="card-body">
                    <div class="table-container" id="backtestResults">
                        <div class="loading"><div class="spinner"></div>로딩 중...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Refresh Info -->
        <div class="refresh-info">
            <span class="pulse-dot"></span>
            자동 갱신 활성화 | 마지막 업데이트: <span id="lastUpdate">-</span>
        </div>
    </div>

    <!-- Accept Modal (추천 수락용) -->
    <div class="modal-overlay" id="acceptModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="acceptModalTitle">추천 수락</h3>
                <button class="modal-close" onclick="closeAcceptModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 15px;">
                        <span style="font-weight: 600;" id="acceptCoin">-</span>
                        <span id="acceptCurrentPrice">-</span>
                    </div>
                </div>
                <div class="form-group" id="acceptAmountGroup">
                    <label class="form-label">투자 금액 선택</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 10px;">
                        <button class="btn btn-secondary btn-sm amount-option" data-multiplier="1" style="flex: 1;">추천 금액</button>
                        <button class="btn btn-secondary btn-sm amount-option" data-multiplier="1.5" style="flex: 1;">1.5배</button>
                        <button class="btn btn-secondary btn-sm amount-option" data-multiplier="2" style="flex: 1;">2배</button>
                    </div>
                    <input type="number" class="form-input" id="acceptAmount" value="50000" min="5000" step="1000">
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">직접 금액을 입력하거나 위 버튼으로 조절할 수 있습니다</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAcceptModal()">취소</button>
                <button class="btn btn-primary" id="acceptConfirmBtn" onclick="executeAccept()">실행</button>
            </div>
        </div>
    </div>

    <!-- Trade Modal (기존 수동 거래용) -->
    <div class="modal-overlay" id="tradeModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="tradeModalTitle">매매 실행</h3>
                <button class="modal-close" onclick="closeTradeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">코인</label>
                    <input type="text" class="form-input" id="tradeCoin" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">현재가</label>
                    <input type="text" class="form-input" id="tradeCurrentPrice" readonly>
                </div>
                <div class="form-group" id="tradeAmountGroup">
                    <label class="form-label">투자 금액 (원)</label>
                    <input type="number" class="form-input" id="tradeAmount" value="50000" min="5000" step="1000">
                </div>
                <div class="form-group">
                    <label class="form-label">거래 유형</label>
                    <input type="text" class="form-input" id="tradeAction" readonly>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeTradeModal()">취소</button>
                <button class="btn btn-primary" id="tradeConfirmBtn" onclick="executeTrade()">실행</button>
            </div>
        </div>
    </div>

    <!-- News Detail Modal -->
    <div class="modal-overlay" id="newsDetailModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3>뉴스 분석</h3>
                <button class="modal-close" onclick="closeNewsDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="newsDetailContent">
                    <div class="loading"><div class="spinner"></div>로딩 중...</div>
                </div>
            </div>
            <div class="modal-footer">
                <a id="newsDetailLink" href="#" target="_blank" class="btn btn-primary" style="text-decoration: none;">
                    원문 보기 ↗
                </a>
                <button class="btn btn-secondary" onclick="closeNewsDetailModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- Pie Chart Tooltip -->
    <div class="pie-tooltip" id="pieTooltip">
        <div class="pie-tooltip-title">
            <span class="pie-tooltip-color" id="pieTooltipColor"></span>
            <span id="pieTooltipName">코인명</span>
        </div>
        <div class="pie-tooltip-row">
            <span class="pie-tooltip-label">평가금액</span>
            <span class="pie-tooltip-value" id="pieTooltipValue">0원</span>
        </div>
        <div class="pie-tooltip-row">
            <span class="pie-tooltip-label">비중</span>
            <span class="pie-tooltip-value" id="pieTooltipWeight">0%</span>
        </div>
    </div>

    <!-- Chart Tooltip -->
    <div class="chart-tooltip" id="chartTooltip">
        <div class="chart-tooltip-time" id="chartTooltipTime">2025-01-01 12:00:00</div>
        <div class="chart-tooltip-row">
            <span class="chart-tooltip-label">총 자산</span>
            <span class="chart-tooltip-value" id="chartTooltipValue">0원</span>
        </div>
        <div class="chart-tooltip-row">
            <span class="chart-tooltip-label">시작대비</span>
            <span class="chart-tooltip-value" id="chartTooltipChange">0%</span>
        </div>
    </div>

    <!-- Price Chart Tooltip -->
    <div class="price-chart-tooltip" id="priceChartTooltip">
        <div class="price-chart-tooltip-time" id="priceChartTooltipTime">2025-01-01 12:00:00</div>
        <div class="price-chart-tooltip-row">
            <span class="price-chart-tooltip-label">시가</span>
            <span class="price-chart-tooltip-value" id="priceChartTooltipOpen">0원</span>
        </div>
        <div class="price-chart-tooltip-row">
            <span class="price-chart-tooltip-label">고가</span>
            <span class="price-chart-tooltip-value" id="priceChartTooltipHigh">0원</span>
        </div>
        <div class="price-chart-tooltip-row">
            <span class="price-chart-tooltip-label">저가</span>
            <span class="price-chart-tooltip-value" id="priceChartTooltipLow">0원</span>
        </div>
        <div class="price-chart-tooltip-row">
            <span class="price-chart-tooltip-label">종가</span>
            <span class="price-chart-tooltip-value" id="priceChartTooltipClose">0원</span>
        </div>
        <div class="price-chart-tooltip-row">
            <span class="price-chart-tooltip-label">변동률</span>
            <span class="price-chart-tooltip-value" id="priceChartTooltipChange">0%</span>
        </div>
    </div>

    <!-- Coin Detail Modal -->
    <div class="modal-overlay" id="coinDetailModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="coinDetailTitle">코인 상세</h3>
                <button class="modal-close" onclick="closeCoinDetailModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="coinDetailContent">
                    <div class="loading"><div class="spinner"></div>로딩 중...</div>
                </div>
            </div>
            <div class="modal-footer" id="coinDetailActions" style="display: flex; gap: 10px;">
                <button class="btn btn-success" style="flex: 1;" id="coinDetailBuyBtn">매수</button>
                <button class="btn btn-danger" style="flex: 1;" id="coinDetailSellBtn">매도</button>
                <button class="btn btn-secondary" onclick="closeCoinDetailModal()">닫기</button>
            </div>
        </div>
    </div>

    <!-- Notification Overlay -->
    <div class="notification-overlay" id="notificationOverlay" onclick="closeNotificationPopup()"></div>

    <!-- Notification Popup -->
    <div class="notification-popup" id="notificationPopup">
        <div class="notification-popup-header">
            <h3 id="notificationTitle"><span>🔔</span> 알림</h3>
            <button class="notification-popup-close" onclick="closeNotificationPopup()">&times;</button>
        </div>
        <div class="notification-popup-body" id="notificationBody"></div>
        <div class="notification-popup-footer" id="notificationFooter">
            <button class="btn btn-secondary" onclick="closeNotificationPopup()">닫기</button>
        </div>
    </div>

    <!-- Quick Trade Modal (마켓 탭용) -->
    <div class="quick-trade-overlay" id="quickTradeOverlay" style="display: none;" onclick="closeQuickTrade()"></div>
    <div class="quick-trade-modal" id="quickTradeModal" style="display: none;">
        <div class="quick-trade-header">
            <div class="quick-trade-coin-info">
                <span class="quick-trade-symbol" id="quickTradeSymbol">BTC</span>
                <span class="quick-trade-change positive" id="quickTradeChange">+0.00%</span>
            </div>
            <button class="quick-trade-close" onclick="closeQuickTrade()">&times;</button>
        </div>
        <div class="quick-trade-body">
            <div class="quick-trade-price">
                <div class="quick-trade-current-price" id="quickTradePrice">0원</div>
                <div class="quick-trade-price-sub" id="quickTradePriceSub">24시간 변동: 0원</div>
            </div>
            <div class="quick-trade-stats">
                <div class="quick-trade-stat">
                    <div class="quick-trade-stat-label">24H 고가</div>
                    <div class="quick-trade-stat-value positive" id="quickTradeHigh">-</div>
                </div>
                <div class="quick-trade-stat">
                    <div class="quick-trade-stat-label">24H 저가</div>
                    <div class="quick-trade-stat-value negative" id="quickTradeLow">-</div>
                </div>
                <div class="quick-trade-stat">
                    <div class="quick-trade-stat-label">거래대금</div>
                    <div class="quick-trade-stat-value" id="quickTradeVolume">-</div>
                </div>
                <div class="quick-trade-stat">
                    <div class="quick-trade-stat-label">보유수량</div>
                    <div class="quick-trade-stat-value" id="quickTradeHolding">-</div>
                </div>
            </div>
            <div class="quick-trade-amount" id="quickTradeAmountSection">
                <label>매수 금액 (원)</label>
                <input type="number" class="quick-trade-amount-input" id="quickTradeAmountInput" value="50000" min="5000" step="1000">
                <div class="quick-trade-presets">
                    <button class="quick-trade-preset" onclick="setQuickTradeAmount(10000)">1만</button>
                    <button class="quick-trade-preset" onclick="setQuickTradeAmount(50000)">5만</button>
                    <button class="quick-trade-preset" onclick="setQuickTradeAmount(100000)">10만</button>
                    <button class="quick-trade-preset" onclick="setQuickTradeAmount(500000)">50만</button>
                </div>
            </div>
            <div class="quick-trade-actions">
                <button class="quick-trade-btn buy" id="quickTradeBuyBtn" onclick="executeQuickTrade('BUY')">매수</button>
                <button class="quick-trade-btn sell" id="quickTradeSellBtn" onclick="executeQuickTrade('SELL')">매도</button>
            </div>
        </div>
        <div class="quick-trade-footer">
            <button class="quick-trade-chart-btn" onclick="viewQuickTradeChart()">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                    <path d="M1 1v14h14V1H1zm13 13H2V2h12v12z"/>
                    <path d="M3 11l3-3 2 2 4-4"/>
                </svg>
                차트 보기
            </button>
            <span style="font-size: 12px; color: var(--text-muted);" id="quickTradeHoldingValue">보유평가: -</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Socket.io Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <script>
        const API_BASE = '';

        // State
        let currentParams = {};
        let parameterRanges = {};
        let lastCoinAnalysisTime = 0;
        const COIN_ANALYSIS_INTERVAL = 60000; // 1분
        let socket = null;
        let notificationQueue = [];

        // ===== Socket.io 실시간 알림 시스템 =====
        function initializeSocket() {
            try {
                socket = io();

                socket.on('connect', () => {
                    console.log('📡 실시간 알림 연결됨');
                    showToast('📡 실시간 알림 연결됨', 'info');
                });

                socket.on('disconnect', () => {
                    console.log('📡 실시간 알림 연결 해제됨');
                });

                // 번들 제안 알림 (새로운 신호)
                socket.on('new-signal', (data) => {
                    console.log('🔔 새 신호 수신:', data);
                    if (data.type === 'bundle' && data.bundle) {
                        showBundleNotification(data.bundle);
                    }
                });

                // 속보 알림
                socket.on('breaking-news', (news) => {
                    console.log('🚨 속보 수신:', news);
                    showBreakingNewsNotification(news);
                });

                // 자동매매 거래 알림
                socket.on('auto-trade', (data) => {
                    console.log('🤖 자동매매 알림:', data);
                    showAutoTradeNotification(data.trade);
                });

            } catch (error) {
                console.error('Socket.io 초기화 오류:', error);
            }
        }

        // 자동매매 알림 표시
        function showAutoTradeNotification(trade) {
            const isBuy = trade.type === 'BUY';
            const emoji = isBuy ? '🟢' : '🔴';
            const action = isBuy ? '매수' : '매도';
            const coin = trade.coin?.replace('KRW-', '') || '';
            const modeLabel = trade.mode === 'DRY_RUN' ? '[모의]' : '[실전]';

            // 토스트 메시지
            const message = `${emoji} ${modeLabel} ${coin} ${action} ${formatNumber(trade.amount || 0)}원`;
            showToast(message, isBuy ? 'success' : 'error', 5000);

            // 상세 팝업 표시
            const popup = document.getElementById('notificationPopup');
            const overlay = document.getElementById('notificationOverlay');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            const footer = document.getElementById('notificationFooter');

            popup.className = `notification-popup ${isBuy ? 'buy-signal' : 'sell-signal'} show`;
            overlay.className = 'notification-overlay show';
            title.innerHTML = `<span>${emoji}</span> 자동매매 ${action} ${modeLabel}`;

            let profitHtml = '';
            if (!isBuy && trade.profitPercent) {
                const profitClass = parseFloat(trade.profitPercent) >= 0 ? 'positive' : 'negative';
                profitHtml = `<div class="trade-profit ${profitClass}">수익률: ${trade.profitPercent}%</div>`;
            }

            let strengthHtml = '';
            if (trade.signalStrength) {
                const strengthEmoji = {
                    'VERY_STRONG': '🔥🔥',
                    'STRONG': '🔥',
                    'MEDIUM': '💡',
                    'WEAK': '💤'
                }[trade.signalStrength] || '';
                strengthHtml = `<div class="trade-strength">신호 강도: ${strengthEmoji} ${trade.signalStrength}</div>`;
            }

            body.innerHTML = `
                <div class="auto-trade-detail">
                    <div class="trade-coin">${coin}</div>
                    <div class="trade-price">${formatNumber(trade.price || 0)} 원</div>
                    <div class="trade-amount">금액: ${formatNumber(trade.amount || 0)} 원</div>
                    <div class="trade-volume">수량: ${trade.volume?.toFixed(8) || 0}</div>
                    ${strengthHtml}
                    ${profitHtml}
                    <div class="trade-reason">${trade.reason || ''}</div>
                </div>
            `;

            footer.innerHTML = `
                <button class="btn btn-secondary" onclick="closeNotificationPopup()">확인</button>
            `;

            // 소리 알림 (선택적)
            playNotificationSound();

            // 데이터 새로고침
            loadOverviewStats();
            loadRecentTrades();
        }

        // 번들 제안 팝업 표시
        function showBundleNotification(bundle) {
            const popup = document.getElementById('notificationPopup');
            const overlay = document.getElementById('notificationOverlay');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            const footer = document.getElementById('notificationFooter');

            popup.className = 'notification-popup bundle-signal show';
            overlay.className = 'notification-overlay show';
            title.innerHTML = '<span>💡</span> 리밸런싱 제안';

            const sellCoin = bundle.sell?.coin?.replace('KRW-', '') || '-';
            const buyCoin = bundle.buy?.coin?.replace('KRW-', '') || '-';

            body.innerHTML = `
                <div style="margin-bottom: 12px; font-size: 14px; color: var(--text-secondary);">
                    ${bundle.rationale || '분석 결과 리밸런싱을 권장합니다'}
                </div>
                <div class="bundle-coin sell">
                    <div class="bundle-coin-info">
                        <div class="bundle-coin-name">🔴 ${sellCoin} 매도</div>
                        <div class="bundle-coin-details">${bundle.sell?.reasons?.join(', ') || ''}</div>
                    </div>
                    <div class="bundle-coin-value">
                        <div style="color: var(--accent-red);">${formatNumber(bundle.sell?.value || 0)}원</div>
                        <div class="bundle-coin-details">${bundle.sell?.profitPercent || 0}% 수익</div>
                    </div>
                </div>
                <div class="bundle-arrow">⬇️</div>
                <div class="bundle-coin buy">
                    <div class="bundle-coin-info">
                        <div class="bundle-coin-name">🟢 ${buyCoin} 매수</div>
                        <div class="bundle-coin-details">${bundle.buy?.reasons?.join(', ') || ''}</div>
                    </div>
                    <div class="bundle-coin-value">
                        <div style="color: var(--accent-green);">${formatNumber(bundle.buy?.suggestedAmount || 0)}원</div>
                        <div class="bundle-coin-details">예상 투자금</div>
                    </div>
                </div>
                <div style="margin-top: 12px; padding: 10px; background: var(--bg-tertiary); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                    📊 총 점수: ${bundle.totalScore}점 | 매도 ${bundle.sell?.score || 0}점 + 매수 ${bundle.buy?.score || 0}점
                </div>
            `;

            footer.innerHTML = `
                <button class="btn btn-secondary" onclick="closeNotificationPopup()">나중에</button>
                <button class="btn btn-primary" onclick="executeBundleTrade('${bundle.sell?.coin}', '${bundle.buy?.coin}')">
                    리밸런싱 실행
                </button>
            `;

            // 알림음 (옵션)
            playNotificationSound();
        }

        // 속보 팝업 표시
        function showBreakingNewsNotification(news) {
            const popup = document.getElementById('notificationPopup');
            const overlay = document.getElementById('notificationOverlay');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            const footer = document.getElementById('notificationFooter');

            popup.className = 'notification-popup breaking-news show';
            overlay.className = 'notification-overlay show';
            title.innerHTML = '<span>🚨</span> 속보';

            const sentimentEmoji = news.sentiment > 0 ? '📈' : news.sentiment < 0 ? '📉' : '➡️';
            const sentimentText = news.sentiment > 0 ? '긍정적' : news.sentiment < 0 ? '부정적' : '중립';

            body.innerHTML = `
                <div class="breaking-news-content">
                    <div class="breaking-news-title">${news.title}</div>
                    <div class="breaking-news-meta">
                        <span>📰 ${news.source || '알 수 없음'}</span>
                        <span>${sentimentEmoji} ${sentimentText}</span>
                        <span>🕐 ${new Date(news.timestamp).toLocaleTimeString('ko-KR')}</span>
                    </div>
                </div>
                <div style="margin-top: 16px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 13px; color: var(--text-secondary);">
                    ⚠️ 이 뉴스가 시장에 영향을 줄 수 있습니다. 포지션을 확인하세요.
                </div>
            `;

            footer.innerHTML = `
                <button class="btn btn-secondary" onclick="closeNotificationPopup()">확인</button>
                ${news.url ? `<button class="btn btn-primary" onclick="window.open('${news.url}', '_blank')">원문 보기</button>` : ''}
            `;

            playNotificationSound();
        }

        // 알림 팝업 닫기
        function closeNotificationPopup() {
            document.getElementById('notificationPopup').classList.remove('show');
            document.getElementById('notificationOverlay').classList.remove('show');
        }

        // 번들 거래 실행
        async function executeBundleTrade(sellCoin, buyCoin) {
            if (!confirm(`${sellCoin?.replace('KRW-', '')} 매도 → ${buyCoin?.replace('KRW-', '')} 매수를 실행하시겠습니까?`)) {
                return;
            }

            closeNotificationPopup();
            showToast('번들 거래 실행 중...', 'info');

            try {
                const response = await fetch('/api/trade/execute-bundle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sellCoin, buyCoin })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`✅ ${result.message}`, 'success');
                    loadAccountInfo();
                    loadOverviewStats();
                } else {
                    showToast(`❌ 거래 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`❌ 오류: ${error.message}`, 'error');
            }
        }

        // 알림음 재생
        function playNotificationSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                // 오디오 재생 실패 무시
            }
        }

        // 페이지 로드 시 Socket.io 초기화
        if (typeof io !== 'undefined') {
            initializeSocket();
        }

        // Chart initialization flags (must be declared before switchToTab)
        let portfolioChart = null;
        let portfolioChartData = null;
        let portfolioChartInitialized = false;
        let profitChartData = null;
        let profitChartInitialized = false;
        let currentProfitPeriod = '24h';
        let currentPortfolioPeriod = '24h';
        let initialSeedMoney = 10000000;
        let parametersTabLoaded = false;  // 파라미터 탭 최초 로드 여부

        // Tab Navigation
        function switchToTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');

            const tab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (tab) {
                tab.classList.add('active');
                const tabId = 'tab-' + tabName;
                document.getElementById(tabId).style.display = 'block';
                localStorage.setItem('currentTab', tabName);

                // Load tab-specific data
                if (tabName === 'market') {
                    loadMarketPrices().then(() => {
                        // 마켓 데이터 로드 후 인라인 패널 업데이트
                        if (selectedCoin) {
                            updateInlineTradePanel(selectedCoin);
                        }
                    });
                    loadChart();
                } else if (tabName === 'analysis') {
                    loadCoinAnalysis();
                    lastCoinAnalysisTime = Date.now(); // 탭 전환 시 즉시 로드
                } else if (tabName === 'news') {
                    loadNews();
                } else if (tabName === 'trading') {
                    loadBuyRecommendations();
                    loadSellRecommendations();
                    loadManualPositions();
                    updateBuyPresetInfo();
                    updateSellPresetInfo();
                } else if (tabName === 'parameters') {
                    // 파라미터 탭은 처음 방문시에만 로드 (사용자 변경 내용 보존)
                    if (!parametersTabLoaded) {
                        loadOptimizationSettings();
                        loadInvestmentPresets();
                        loadParameterRanges();
                        loadOptimalParams();
                        parametersTabLoaded = true;
                    } else {
                        // 최적화 설정은 항상 최신 상태로 유지
                        loadOptimizationSettings();
                    }
                } else if (tabName === 'history') {
                    loadOptimizationHistory();
                    loadBacktestResults();
                } else if (tabName === 'portfolio') {
                    loadOverviewStats();
                    loadPortfolioAnalysis();
                    loadAccountInfo();
                    loadPositions();
                    loadTradeStats();
                    loadRecentTrades();
                    loadPortfolioHistory();
                    loadProfitHistory();
                }
            }
        }

        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                switchToTab(tab.dataset.tab);
            });
        });

        // 저장된 탭 복원
        const savedTab = localStorage.getItem('currentTab');
        if (savedTab) {
            switchToTab(savedTab);
        }

        // API Helper
        async function fetchAPI(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE}/api${endpoint}`, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error(`API Error (${endpoint}):`, error);
                return null;
            }
        }

        // Formatters
        function formatNumber(num) {
            if (num === undefined || num === null || isNaN(num)) return '0';
            const n = parseFloat(num);
            if (isNaN(n)) return '0';
            return Math.round(n).toLocaleString();
        }

        function formatPercent(num) {
            if (num === undefined || num === null) return '0.00';
            const n = parseFloat(num);
            if (isNaN(n)) return '0.00';
            return n.toFixed(2);
        }

        // ===== 숫자 롤링 애니메이션 =====
        const animatingElements = new Map();

        function animateNumber(element, targetValue, options = {}) {
            const {
                duration = 800,
                suffix = '',
                prefix = '',
                decimals = 0,
                easing = 'easeOutExpo'
            } = options;

            // 요소가 없으면 리턴
            if (!element) return;

            // 현재 진행 중인 애니메이션 취소
            if (animatingElements.has(element)) {
                cancelAnimationFrame(animatingElements.get(element).frameId);
            }

            // 현재 값 파싱 (숫자만 추출)
            const currentText = element.textContent || '0';
            const currentValue = parseFloat(currentText.replace(/[^0-9.-]/g, '')) || 0;
            const target = parseFloat(targetValue) || 0;

            // 값이 같으면 애니메이션 스킵
            if (Math.abs(currentValue - target) < 0.01) {
                element.textContent = prefix + formatNumberWithDecimals(target, decimals) + suffix;
                return;
            }

            const startTime = performance.now();
            const diff = target - currentValue;

            // 원래 색상 저장
            const originalColor = element.style.color || '';

            // 증가/감소에 따른 색상 설정
            if (diff > 0) {
                element.style.color = 'var(--accent-green)';
            } else if (diff < 0) {
                element.style.color = 'var(--accent-red)';
            }

            // Easing 함수
            const easingFunctions = {
                easeOutExpo: t => t === 1 ? 1 : 1 - Math.pow(2, -10 * t),
                easeOutQuart: t => 1 - Math.pow(1 - t, 4),
                easeInOutQuad: t => t < 0.5 ? 2 * t * t : 1 - Math.pow(-2 * t + 2, 2) / 2
            };

            const ease = easingFunctions[easing] || easingFunctions.easeOutExpo;

            function animate(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easedProgress = ease(progress);
                const current = currentValue + diff * easedProgress;

                element.textContent = prefix + formatNumberWithDecimals(current, decimals) + suffix;

                if (progress < 1) {
                    const frameId = requestAnimationFrame(animate);
                    animatingElements.set(element, { frameId, originalColor });
                } else {
                    element.textContent = prefix + formatNumberWithDecimals(target, decimals) + suffix;
                    // 애니메이션 완료 후 원래 색상으로 복귀
                    element.style.color = originalColor;
                    animatingElements.delete(element);
                }
            }

            const frameId = requestAnimationFrame(animate);
            animatingElements.set(element, { frameId, originalColor });
        }

        function formatNumberWithDecimals(num, decimals) {
            const n = parseFloat(num);
            if (isNaN(n)) return '0';
            if (decimals > 0) {
                return n.toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }
            return Math.round(n).toLocaleString();
        }

        // 통합 업데이트 함수 (요소 ID, 값, 옵션)
        function updateStatWithAnimation(elementId, value, options = {}) {
            const element = document.getElementById(elementId);
            if (!element) return;

            // stat-value 클래스를 가진 하위 요소 찾기
            let targetEl = element.querySelector('.stat-value') || element;

            // 텍스트만 있는 간단한 요소인 경우
            if (!element.querySelector('.stat-value') && !element.querySelector('.stat-label')) {
                targetEl = element;
            }

            animateNumber(targetEl, value, options);
        }

        // 지표 값 포맷팅 (숫자, 문자열, 객체 처리)
        function formatIndicator(value) {
            if (value === undefined || value === null) return '-';
            // 숫자인 경우
            if (typeof value === 'number') return value.toFixed(1);
            // 문자열인 경우 (숫자 문자열 포함)
            if (typeof value === 'string') {
                const num = parseFloat(value);
                if (!isNaN(num)) return num.toFixed(1);
                return value;
            }
            // 객체인 경우
            if (typeof value === 'object') {
                if (value.value !== undefined) return formatIndicator(value.value);
                if (value.current !== undefined) return formatIndicator(value.current);
                if (value.histogram !== undefined) return formatIndicator(value.histogram);
                return '-';
            }
            return String(value);
        }

        // 볼린저 밴드 포맷팅
        function formatBB(bb) {
            if (!bb) return '-';
            if (typeof bb === 'string') return bb;
            if (bb.position) return bb.position;
            if (bb.percentB !== undefined) {
                const pB = parseFloat(bb.percentB);
                if (pB < 0.2) return 'Lower';
                if (pB > 0.8) return 'Upper';
                return 'Middle';
            }
            if (bb.upper && bb.lower && bb.middle) {
                return 'Active';
            }
            return '-';
        }

        // 손익 포맷팅 (0일 때 회색)
        function formatProfit(profit, showSign = true) {
            const value = parseFloat(profit) || 0;
            if (value === 0) {
                return '<span style="color: var(--text-muted);">-</span>';
            }
            const sign = showSign && value > 0 ? '+' : '';
            const className = value >= 0 ? 'positive' : 'negative';
            return `<span class="stat-value ${className}">${sign}${formatNumber(value)}원</span>`;
        }

        // 변동률 포맷팅 (0일 때 회색)
        function formatChange(change) {
            const value = parseFloat(change) || 0;
            if (Math.abs(value) < 0.01) {
                return '<span style="color: var(--text-muted);">0.00%</span>';
            }
            const sign = value > 0 ? '+' : '';
            const className = value >= 0 ? 'positive' : 'negative';
            return `<span class="stat-value ${className}">${sign}${value.toFixed(2)}%</span>`;
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ===== 상세 시스템 상태 로드 =====
        async function loadDetailedSystemStatus() {
            const data = await fetchAPI('/system-status');
            if (!data) return;

            // 상태 배지 업데이트
            const badge = document.getElementById('systemStatusBadge');
            if (badge) {
                if (data.isRunning) {
                    badge.textContent = '실행중';
                    badge.className = 'badge badge-running';
                } else {
                    badge.textContent = '중지됨';
                    badge.className = 'badge badge-stopped';
                }
            }

            // 가동시간
            const uptimeEl = document.getElementById('sysUptime');
            if (uptimeEl) uptimeEl.textContent = data.uptimeFormatted || '-';

            // 마지막 분석
            const lastAnalysisEl = document.getElementById('sysLastAnalysis');
            if (lastAnalysisEl) {
                if (data.lastTradeTime) {
                    const lastTime = new Date(data.lastTradeTime);
                    const now = new Date();
                    const diffMin = Math.floor((now - lastTime) / 60000);
                    lastAnalysisEl.textContent = diffMin < 1 ? '방금 전' : `${diffMin}분 전`;
                } else {
                    lastAnalysisEl.textContent = '-';
                }
            }

            // 분석 주기
            const intervalEl = document.getElementById('sysInterval');
            if (intervalEl) {
                const intervalSec = Math.floor((data.checkInterval || 60000) / 1000);
                intervalEl.textContent = intervalSec >= 60 ? `${Math.floor(intervalSec/60)}분` : `${intervalSec}초`;
            }

            // 포지션 (무제한 - 개수만 표시)
            const positionsEl = document.getElementById('sysPositions');
            if (positionsEl) positionsEl.textContent = `${data.currentPositions || 0}개`;

            // 에러 표시
            const errorPanel = document.getElementById('systemErrors');
            const errorList = document.getElementById('errorList');
            if (errorPanel && errorList) {
                if (data.hasErrors && data.recentErrors?.length > 0) {
                    errorPanel.style.display = 'block';
                    errorList.innerHTML = data.recentErrors.map((e, idx) => {
                        // 에러 문자열 파싱 (시간 | 내용 형식 또는 그냥 텍스트)
                        const parts = e.split(' | ');
                        let time = '';
                        let content = e;
                        if (parts.length >= 2) {
                            time = parts[0];
                            content = parts.slice(1).join(' | ');
                        }
                        // 요약: 첫 줄만 또는 80자까지
                        const firstLine = content.split('\n')[0];
                        const summary = firstLine.length > 80 ? firstLine.substring(0, 80) + '...' : firstLine;
                        const hasMore = content.length > summary.length || content.includes('\n');

                        return `
                            <div class="error-item" id="error-${idx}">
                                <div class="error-header" onclick="toggleError(${idx})">
                                    <span class="error-summary">
                                        ${time ? `<span class="error-time">${time}</span>` : ''}
                                        ${escapeHtml(summary)}
                                    </span>
                                    ${hasMore ? `<span class="error-toggle">더보기</span>` : ''}
                                </div>
                                ${hasMore ? `<div class="error-details">${escapeHtml(content)}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                } else {
                    errorPanel.style.display = 'none';
                }
            }
        }

        // 에러 토글 함수
        function toggleError(idx) {
            const item = document.getElementById(`error-${idx}`);
            if (item) {
                item.classList.toggle('expanded');
                const toggle = item.querySelector('.error-toggle');
                if (toggle) {
                    toggle.textContent = item.classList.contains('expanded') ? '접기' : '더보기';
                }
            }
        }

        // HTML 이스케이프 함수
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ===== 오늘의 거래 요약 로드 =====
        async function loadTodaySummary() {
            const data = await fetchAPI('/today-summary');
            if (!data) return;

            // 날짜
            document.getElementById('todayDate').textContent = data.date || '-';

            // 거래 건수 (애니메이션 적용)
            animateNumber(document.getElementById('todayTotalTrades'), data.totalTrades || 0, { duration: 500 });
            animateNumber(document.getElementById('todayBuyCount'), data.buyCount || 0, { duration: 500 });
            animateNumber(document.getElementById('todaySellCount'), data.sellCount || 0, { duration: 500 });

            // 실현 손익 (애니메이션 적용)
            const profitEl = document.getElementById('todayProfit');
            const profit = data.realizedProfit || 0;
            profitEl.className = `today-stat-value ${profit >= 0 ? 'positive' : 'negative'}`;
            animateNumber(profitEl, profit, {
                suffix: '원',
                prefix: profit >= 0 ? '+' : '',
                duration: 600
            });

            // 금액 (애니메이션 적용)
            animateNumber(document.getElementById('todayBuyAmount'), data.totalBuyAmount || 0, { suffix: '원', duration: 600 });
            animateNumber(document.getElementById('todaySellAmount'), data.totalSellAmount || 0, { suffix: '원', duration: 600 });

            // 순 자금흐름 (애니메이션 적용)
            const netFlowEl = document.getElementById('todayNetFlow');
            const netFlow = data.netFlow || 0;
            netFlowEl.style.color = netFlow >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            animateNumber(netFlowEl, netFlow, {
                suffix: '원',
                prefix: netFlow >= 0 ? '+' : '',
                duration: 600
            });
        }

        // ===== 포트폴리오 분석 로드 =====
        const PORTFOLIO_COLORS = [
            '#58a6ff', '#3fb950', '#f85149', '#d29922', '#a371f7',
            '#79c0ff', '#7ee787', '#ff7b72', '#e3b341', '#d2a8ff',
            '#56d4dd', '#ffa657', '#ff9bce', '#8b949e'
        ];

        async function loadPortfolioAnalysis() {
            const data = await fetchAPI('/portfolio-analysis');
            if (!data) return;

            // 파이 차트 렌더링
            renderPortfolioPieChart(data.holdings, data.summary);

            // 상위 수익 코인
            const topGainers = document.getElementById('topGainers');
            if (data.topGainers?.length > 0) {
                topGainers.innerHTML = data.topGainers.map(h => `
                    <div class="top-item">
                        <span class="top-coin">${h.symbol}</span>
                        <span class="top-percent positive">+${h.profitPercent}%</span>
                    </div>
                `).join('');
            } else {
                topGainers.innerHTML = '<div style="color: var(--text-muted); padding: 10px; text-align: center;">데이터 없음</div>';
            }

            // 상위 손실 코인
            const topLosers = document.getElementById('topLosers');
            if (data.topLosers?.length > 0 && parseFloat(data.topLosers[0]?.profitPercent) < 0) {
                topLosers.innerHTML = data.topLosers.filter(h => parseFloat(h.profitPercent) < 0).map(h => `
                    <div class="top-item">
                        <span class="top-coin">${h.symbol}</span>
                        <span class="top-percent negative">${h.profitPercent}%</span>
                    </div>
                `).join('') || '<div style="color: var(--text-muted); padding: 10px; text-align: center;">손실 없음</div>';
            } else {
                topLosers.innerHTML = '<div style="color: var(--text-muted); padding: 10px; text-align: center;">손실 없음</div>';
            }
        }

        // 파이 차트 데이터 저장 (툴팁용)
        let pieChartData = [];

        function renderPortfolioPieChart(holdings, summary) {
            const container = document.getElementById('portfolioPieChart');
            const legend = document.getElementById('portfolioLegend');

            // 데이터 준비 (KRW 포함)
            const chartData = [];
            if (summary?.krwBalance > 0) {
                chartData.push({
                    name: 'KRW',
                    value: summary.krwBalance,
                    weight: parseFloat(summary.krwWeight) || 0
                });
            }
            holdings?.forEach(h => {
                if (h.currentValue > 0) {
                    chartData.push({
                        name: h.symbol,
                        value: h.currentValue,
                        weight: parseFloat(h.weight) || 0,
                        amount: h.amount,
                        avgPrice: h.avgPrice
                    });
                }
            });

            // 전역 데이터 저장 (툴팁용)
            pieChartData = chartData;

            if (chartData.length === 0) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">보유 자산 없음</div>';
                legend.innerHTML = '';
                return;
            }

            // SVG 파이 차트 생성
            const size = 160;
            const radius = 65;
            const centerX = size / 2;
            const centerY = size / 2;

            let currentAngle = -Math.PI / 2;
            let paths = '';

            chartData.forEach((item, i) => {
                const angle = (item.weight / 100) * 2 * Math.PI;
                const endAngle = currentAngle + angle;

                const x1 = centerX + radius * Math.cos(currentAngle);
                const y1 = centerY + radius * Math.sin(currentAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);

                const largeArc = angle > Math.PI ? 1 : 0;
                const color = PORTFOLIO_COLORS[i % PORTFOLIO_COLORS.length];

                // 클래스와 data 속성 추가 (툴팁용)
                paths += `<path class="pie-slice" data-index="${i}" d="M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z" fill="${color}" stroke="var(--bg-secondary)" stroke-width="2"/>`;

                currentAngle = endAngle;
            });

            container.innerHTML = `
                <svg viewBox="0 0 ${size} ${size}" width="${size}" height="${size}" id="portfolioSvg">
                    ${paths}
                    <circle cx="${centerX}" cy="${centerY}" r="35" fill="var(--bg-secondary)"/>
                    <text x="${centerX}" y="${centerY - 5}" text-anchor="middle" fill="var(--text-muted)" font-size="10">총 자산</text>
                    <text x="${centerX}" y="${centerY + 12}" text-anchor="middle" fill="var(--text-primary)" font-size="11" font-weight="600">${formatNumber(summary?.totalAssets || 0)}</text>
                </svg>
            `;

            // 파이 슬라이스에 이벤트 리스너 추가
            const svg = document.getElementById('portfolioSvg');
            const tooltip = document.getElementById('pieTooltip');
            const slices = svg.querySelectorAll('.pie-slice');

            slices.forEach(slice => {
                slice.addEventListener('mouseenter', (e) => {
                    const index = parseInt(slice.dataset.index);
                    const data = pieChartData[index];
                    if (!data) return;

                    const color = PORTFOLIO_COLORS[index % PORTFOLIO_COLORS.length];
                    document.getElementById('pieTooltipColor').style.background = color;
                    document.getElementById('pieTooltipName').textContent = data.name;
                    document.getElementById('pieTooltipValue').textContent = formatNumber(data.value) + '원';
                    document.getElementById('pieTooltipWeight').textContent = data.weight.toFixed(2) + '%';

                    tooltip.classList.add('active');
                });

                slice.addEventListener('mousemove', (e) => {
                    tooltip.style.left = (e.clientX + 15) + 'px';
                    tooltip.style.top = (e.clientY + 15) + 'px';
                });

                slice.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('active');
                });
            });

            // 범례 생성 (범례에도 hover 툴팁 추가)
            legend.innerHTML = chartData.map((item, i) => `
                <div class="legend-item" data-index="${i}" style="cursor: pointer;">
                    <div class="legend-color" style="background: ${PORTFOLIO_COLORS[i % PORTFOLIO_COLORS.length]};"></div>
                    <div class="legend-info">
                        <span class="legend-name">${item.name}</span>
                        <span class="legend-weight">${item.weight.toFixed(1)}%</span>
                    </div>
                    <span style="font-size: 11px; color: var(--text-muted);">${formatNumber(item.value)}원</span>
                </div>
            `).join('');
        }

        // ===== 코인 상세 모달 =====
        let currentCoinForModal = null;

        async function openCoinDetailModal(coin) {
            currentCoinForModal = coin;
            const modal = document.getElementById('coinDetailModal');
            const content = document.getElementById('coinDetailContent');
            const title = document.getElementById('coinDetailTitle');

            title.textContent = `${coin} 상세 정보`;
            content.innerHTML = '<div class="loading"><div class="spinner"></div>로딩 중...</div>';
            modal.classList.add('active');

            const data = await fetchAPI(`/coin-detail/${coin}`);
            if (!data) {
                content.innerHTML = '<div style="color: var(--accent-red);">정보를 불러올 수 없습니다.</div>';
                return;
            }

            const changeClass = parseFloat(data.change24h) >= 0 ? 'positive' : 'negative';
            const profitClass = parseFloat(data.holding.profitPercent) >= 0 ? 'positive' : 'negative';

            content.innerHTML = `
                <div class="coin-detail-grid">
                    <div class="coin-detail-item">
                        <div class="coin-detail-label">현재가</div>
                        <div class="coin-detail-value">${formatNumber(data.currentPrice)}원</div>
                    </div>
                    <div class="coin-detail-item">
                        <div class="coin-detail-label">24시간 변동</div>
                        <div class="coin-detail-value ${changeClass}">${parseFloat(data.change24h) >= 0 ? '+' : ''}${data.change24h}%</div>
                    </div>
                    <div class="coin-detail-item">
                        <div class="coin-detail-label">24시간 고가</div>
                        <div class="coin-detail-value">${formatNumber(data.high24h)}원</div>
                    </div>
                    <div class="coin-detail-item">
                        <div class="coin-detail-label">24시간 저가</div>
                        <div class="coin-detail-value">${formatNumber(data.low24h)}원</div>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">📊 보유 현황</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">보유 수량</div>
                            <div style="font-weight: 600;">${data.holding.amount > 0 ? data.holding.amount.toFixed(8) : '없음'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">평균 매수가</div>
                            <div style="font-weight: 600;">${data.holding.avgPrice > 0 ? formatNumber(data.holding.avgPrice) + '원' : '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">평가금액</div>
                            <div style="font-weight: 600;">${data.holding.currentValue > 0 ? formatNumber(data.holding.currentValue) + '원' : '-'}</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">평가손익</div>
                            <div style="font-weight: 600; color: var(--accent-${profitClass === 'positive' ? 'green' : 'red'});">
                                ${data.holding.profit !== 0 ? `${data.holding.profit > 0 ? '+' : ''}${formatNumber(data.holding.profit)}원 (${data.holding.profitPercent}%)` : '-'}
                            </div>
                        </div>
                    </div>
                </div>

                ${data.indicators ? `
                <div style="margin-bottom: 15px; padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">📈 기술적 지표</div>
                    <div style="display: flex; gap: 15px; justify-content: space-around;">
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted);">RSI</div>
                            <div style="font-weight: 600; font-size: 16px;">${data.indicators.rsi}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted);">MACD</div>
                            <div style="font-weight: 600; font-size: 16px;">${data.indicators.macd}</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted);">BB</div>
                            <div style="font-weight: 600; font-size: 16px;">${data.indicators.bb}</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                    <div style="font-size: 13px; color: var(--text-muted); margin-bottom: 10px;">💰 거래 가능</div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">보유 현금</div>
                            <div style="font-weight: 600; color: var(--accent-green);">${formatNumber(data.krwBalance)}원</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">최대 매수 가능</div>
                            <div style="font-weight: 600; color: var(--accent-green);">${formatNumber(data.maxBuyAmount)}원</div>
                        </div>
                        <div>
                            <div style="font-size: 11px; color: var(--text-muted);">보유 코인 평가</div>
                            <div style="font-weight: 600; color: var(--accent-red);">${formatNumber(data.maxSellAmount)}원</div>
                        </div>
                    </div>
                </div>
            `;

            // 매수/매도 버튼 이벤트 설정
            document.getElementById('coinDetailBuyBtn').onclick = () => {
                closeCoinDetailModal();
                // 즉시 매매 패널로 이동하고 코인 선택
                setQuickTradeMode('buy');
                const quickCoinSelect = document.getElementById('quickTradeCoin');
                if (quickCoinSelect) {
                    quickCoinSelect.value = coin;
                }
            };

            document.getElementById('coinDetailSellBtn').onclick = () => {
                closeCoinDetailModal();
                setQuickTradeMode('sell');
                const quickCoinSelect = document.getElementById('quickTradeCoin');
                if (quickCoinSelect) {
                    quickCoinSelect.value = coin;
                }
            };
        }

        function closeCoinDetailModal() {
            document.getElementById('coinDetailModal').classList.remove('active');
            currentCoinForModal = null;
        }

        // System Status
        async function loadSystemStatus() {
            const status = await fetchAPI('/status');
            const container = document.getElementById('systemStatus');

            if (!status) {
                container.innerHTML = '<span class="badge badge-stopped">연결 실패</span>';
                return;
            }

            const runningBadge = status.isRunning
                ? '<span class="badge badge-running">실행중</span>'
                : '<span class="badge badge-stopped">중지됨</span>';

            const modeBadge = status.mode === 'DRY_RUN'
                ? '<span class="badge badge-dry">모의투자</span>'
                : '<span class="badge badge-live">실전투자</span>';

            const coinCount = Array.isArray(status.targetCoins) ? status.targetCoins.length : 0;

            container.innerHTML = `
                ${runningBadge}
                ${modeBadge}
                <span style="color: var(--text-secondary);">분석 대상: <strong>${coinCount}개 코인</strong></span>
            `;

            // 가상지갑 패널 표시/숨김 (DRY RUN 모드에서만 표시)
            const virtualWalletPanel = document.getElementById('virtualWalletPanel');
            if (virtualWalletPanel) {
                virtualWalletPanel.style.display = status.mode === 'DRY_RUN' ? 'block' : 'none';
            }
        }

        // Overview Stats (큰 카드 형태)
        async function loadOverviewStats() {
            const account = await fetchAPI('/account');
            const stats = await fetchAPI('/statistics');
            const cumulativePnL = await fetchAPI('/cumulative-pnl');

            // 총 평가자산 - API에서 직접 가져옴 (KRW잔액 + 보유코인 평가액)
            let totalAssets = parseFloat(account?.totalAssets) || parseFloat(account?.krwBalance) || 0;
            let totalPositionValue = 0;
            let totalPositionCost = 0;

            // 포지션 평가손익 계산용
            if (account?.positions?.length > 0) {
                for (const pos of account.positions) {
                    const currentPrice = parseFloat(pos.currentPrice) || parseFloat(pos.entryPrice) || 0;
                    const amount = parseFloat(pos.amount) || 0;
                    const entryPrice = parseFloat(pos.entryPrice) || parseFloat(pos.avgPrice) || 0;
                    totalPositionValue += currentPrice * amount;
                    totalPositionCost += entryPrice * amount;
                }
            }

            // 평가손익 (현재가 기준 - 보유코인)
            const totalEvalProfit = totalPositionValue - totalPositionCost;
            const evalProfitPercent = totalPositionCost > 0 ? ((totalPositionValue / totalPositionCost - 1) * 100) : 0;

            // 거래 통계
            let totalTrades = 0;
            let winningTrades = 0;

            if (Array.isArray(stats)) {
                stats.forEach(stat => {
                    totalTrades += parseInt(stat.totalTrades) || 0;
                    winningTrades += parseInt(stat.winningTrades) || 0;
                });
            }

            const avgWinRate = totalTrades > 0 ? (winningTrades / totalTrades * 100) : 0;

            // 누적손익 계산 (Portfolio 탭에서 사용)
            const cumulativeProfit = cumulativePnL?.profit || 0;
            const cumulativeProfitPercent = cumulativePnL?.profitPercent || 0;
            const cumulativeClass = cumulativeProfit >= 0 ? 'positive' : 'negative';
            const totalProfitClass = totalEvalProfit >= 0 ? 'positive' : 'negative';

            // ===== Portfolio 탭 요소 업데이트 (롤링 애니메이션 적용) =====
            updateStatCardWithAnimation('portfolioTotalAssets', {
                label: '총 평가자산',
                value: totalAssets,
                suffix: '원',
                subText: `시드: ${formatNumber(cumulativePnL?.initialSeedMoney || 0)}원`,
                subClass: ''
            });

            updateStatCardWithAnimation('portfolioCumulativePnL', {
                label: '누적손익 (시드머니 대비)',
                value: cumulativeProfit,
                suffix: '원',
                prefix: cumulativeProfit >= 0 ? '+' : '',
                valueClass: cumulativeClass,
                subText: `${cumulativeProfitPercent >= 0 ? '+' : ''}${cumulativeProfitPercent.toFixed(2)}%`,
                subClass: cumulativeClass
            });

            updateStatCardWithAnimation('portfolioTotalProfit', {
                label: '평가손익 (보유코인)',
                value: totalEvalProfit,
                suffix: '원',
                prefix: totalEvalProfit >= 0 ? '+' : '',
                valueClass: totalProfitClass,
                subText: `${evalProfitPercent >= 0 ? '+' : ''}${evalProfitPercent.toFixed(2)}%`,
                subClass: totalProfitClass
            });

            updateStatCardWithAnimation('portfolioWinRate', {
                label: '승률',
                value: avgWinRate,
                suffix: '%',
                decimals: 2,
                subText: `${winningTrades}승 / ${totalTrades}거래`,
                subClass: ''
            });

            // 실시간 자산추이 차트 업데이트
            if (totalAssets > 0 && portfolioChartData && portfolioChartData.length > 0) {
                updatePortfolioChartLastPoint(totalAssets);
            }

            // 실시간 수익률 차트 업데이트
            if (totalAssets > 0 && profitChartData && profitChartData.length > 0) {
                updateProfitChartLastPoint(totalAssets);
            }
        }

        // 통계 카드 애니메이션 업데이트 헬퍼
        function updateStatCardWithAnimation(elementId, config) {
            const container = document.getElementById(elementId);
            if (!container) return;

            const { label, value, suffix = '', prefix = '', valueClass = '', subText = '', subClass = '', decimals = 0 } = config;

            // 첫 로드인지 확인 (구조가 없으면 생성)
            let valueEl = container.querySelector('.stat-value');
            let subEl = container.querySelector('.stat-change');

            if (!valueEl) {
                // 초기 구조 생성
                container.innerHTML = `
                    <div class="stat-label">${label}</div>
                    <div class="stat-value ${valueClass}" data-prev-value="0"></div>
                    <div class="stat-change ${subClass}" style="${!subClass ? 'color: var(--text-muted);' : ''}">${subText}</div>
                `;
                valueEl = container.querySelector('.stat-value');
                subEl = container.querySelector('.stat-change');
                // 초기값 직접 설정
                valueEl.textContent = prefix + formatNumberWithDecimals(value, decimals) + suffix;
                valueEl.dataset.prevValue = value;
            } else {
                // 이전 값과 비교하여 플래시 효과 적용
                const prevValue = parseFloat(valueEl.dataset.prevValue) || 0;
                if (Math.abs(prevValue - value) > 0.01) {
                    valueEl.classList.remove('price-flash-up', 'price-flash-down');
                    void valueEl.offsetWidth; // reflow
                    if (value > prevValue) {
                        valueEl.classList.add('price-flash-up');
                    } else if (value < prevValue) {
                        valueEl.classList.add('price-flash-down');
                    }
                    valueEl.dataset.prevValue = value;
                }

                // 클래스 업데이트
                valueEl.className = `stat-value ${valueClass}`;
                if (subEl) {
                    subEl.className = `stat-change ${subClass}`;
                    subEl.style.color = !subClass ? 'var(--text-muted)' : '';
                    subEl.textContent = subText;
                }
                // 애니메이션 적용
                animateNumber(valueEl, value, {
                    suffix,
                    prefix,
                    decimals,
                    duration: 600
                });
            }
        }

        // 가상지갑 메시지 표시
        function showVirtualWalletMessage(message, isSuccess) {
            const msgEl = document.getElementById('virtualWalletMessage');
            msgEl.style.display = 'block';
            msgEl.style.background = isSuccess ? 'rgba(63, 185, 80, 0.2)' : 'rgba(248, 81, 73, 0.2)';
            msgEl.style.color = isSuccess ? 'var(--accent-green)' : 'var(--accent-red)';
            msgEl.textContent = message;
            setTimeout(() => { msgEl.style.display = 'none'; }, 3000);
        }

        // 가상 입금
        async function virtualDeposit() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            if (!amount || amount < 1000) {
                showVirtualWalletMessage('최소 1,000원 이상 입력해주세요.', false);
                return;
            }

            const result = await fetchAPI('/virtual/deposit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });

            if (result?.success) {
                // 시드머니 업데이트 (손익 계산에 반영)
                if (result.newSeedMoney !== undefined) {
                    initialSeedMoney = result.newSeedMoney;
                }
                showVirtualWalletMessage(`${formatNumber(amount)}원 입금 완료! 시드머니: ${formatNumber(result.newSeedMoney || 0)}원`, true);
                document.getElementById('depositAmount').value = '';
                loadOverviewStats();
            } else {
                showVirtualWalletMessage(result?.error || '입금 실패', false);
            }
        }

        // 가상 출금
        async function virtualWithdraw() {
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            if (!amount || amount < 1000) {
                showVirtualWalletMessage('최소 1,000원 이상 입력해주세요.', false);
                return;
            }

            const result = await fetchAPI('/virtual/withdraw', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });

            if (result?.success) {
                // 시드머니 업데이트 (손익 계산에 반영)
                if (result.newSeedMoney !== undefined) {
                    initialSeedMoney = result.newSeedMoney;
                }
                showVirtualWalletMessage(`${formatNumber(amount)}원 출금 완료! 시드머니: ${formatNumber(result.newSeedMoney || 0)}원`, true);
                document.getElementById('withdrawAmount').value = '';
                loadOverviewStats();
            } else {
                showVirtualWalletMessage(result?.error || '출금 실패', false);
            }
        }

        // 빠른 입금
        async function quickDeposit(amount) {
            const result = await fetchAPI('/virtual/deposit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ amount })
            });

            if (result?.success) {
                // 시드머니 업데이트 (손익 계산에 반영)
                if (result.newSeedMoney !== undefined) {
                    initialSeedMoney = result.newSeedMoney;
                }
                showVirtualWalletMessage(`${formatNumber(amount)}원 입금 완료! 시드머니: ${formatNumber(result.newSeedMoney || 0)}원`, true);
                loadOverviewStats();
            } else {
                showVirtualWalletMessage(result?.error || '입금 실패', false);
            }
        }

        // 시드머니 리셋
        async function virtualReset() {
            const newSeedMoney = parseInt(document.getElementById('resetSeedMoney').value);

            if (!confirm('정말 시드머니를 리셋하시겠습니까?\n모든 포지션이 청산되고 거래 기록이 초기화됩니다.')) {
                return;
            }

            const result = await fetchAPI('/virtual/reset', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ seedMoney: newSeedMoney || 10000000 })
            });

            if (result?.success) {
                showVirtualWalletMessage(`시드머니가 ${formatNumber(result.newSeedMoney)}원으로 리셋되었습니다.`, true);
                document.getElementById('resetSeedMoney').value = '';
                loadOverviewStats();
                loadPositions();
            } else {
                showVirtualWalletMessage(result?.error || '리셋 실패', false);
            }
        }

        // 시장 현황
        async function loadMarketOverview() {
            const container = document.getElementById('marketOverview');
            const data = await fetchAPI('/market/prices');

            if (!data || data.length === 0) {
                container.innerHTML = '<div class="empty-state">시장 데이터를 불러올 수 없습니다</div>';
                return;
            }

            // 상승/하락 코인 수 계산
            let rising = 0, falling = 0, unchanged = 0;
            let totalVolume = 0;
            let topGainer = null, topLoser = null;

            data.forEach(coin => {
                if (coin.change > 0.1) rising++;
                else if (coin.change < -0.1) falling++;
                else unchanged++;

                totalVolume += coin.volumeKrw || 0;

                if (!topGainer || coin.change > topGainer.change) topGainer = coin;
                if (!topLoser || coin.change < topLoser.change) topLoser = coin;
            });

            // 상위 거래량 5개 코인
            const topVolume = [...data].sort((a, b) => b.volumeKrw - a.volumeKrw).slice(0, 5);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <!-- 시장 요약 -->
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">시장 현황</div>
                        <div style="display: flex; gap: 16px; align-items: center;">
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${rising}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">상승</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--text-muted);">${unchanged}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">보합</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--accent-red);">${falling}</div>
                                <div style="font-size: 11px; color: var(--text-muted);">하락</div>
                            </div>
                        </div>
                    </div>

                    <!-- 상승률 1위 -->
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border-left: 3px solid var(--accent-green); cursor: pointer;" onclick="selectCoin('${topGainer?.coin || ''}'); switchToTab('market');">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">상승률 1위</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; font-size: 16px;">${topGainer?.coin?.replace('KRW-', '') || '-'}</div>
                            <div style="color: var(--accent-green); font-weight: 700;">+${topGainer?.change?.toFixed(2) || 0}%</div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${formatNumber(topGainer?.price || 0)}원</div>
                    </div>

                    <!-- 하락률 1위 -->
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; border-left: 3px solid var(--accent-red); cursor: pointer;" onclick="selectCoin('${topLoser?.coin || ''}'); switchToTab('market');">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">하락률 1위</div>
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; font-size: 16px;">${topLoser?.coin?.replace('KRW-', '') || '-'}</div>
                            <div style="color: var(--accent-red); font-weight: 700;">${topLoser?.change?.toFixed(2) || 0}%</div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">${formatNumber(topLoser?.price || 0)}원</div>
                    </div>

                    <!-- 총 거래대금 -->
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                        <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 4px;">24h 총 거래대금</div>
                        <div style="font-size: 20px; font-weight: 700;">${(totalVolume / 1000000000000).toFixed(2)}조원</div>
                        <div style="font-size: 12px; color: var(--text-muted);">${data.length}개 코인</div>
                    </div>
                </div>

                <!-- 거래량 상위 5개 -->
                <div style="margin-top: 16px;">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; font-weight: 500;">거래량 TOP 5</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        ${topVolume.map((coin, idx) => `
                            <div style="background: var(--bg-tertiary); padding: 10px 16px; border-radius: 6px; flex: 1; min-width: 140px; cursor: pointer;" onclick="selectCoin('${coin.coin}'); switchToTab('market');">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="font-size: 12px; color: var(--accent-blue); font-weight: 600;">#${idx + 1}</span>
                                        <span style="font-weight: 600; margin-left: 4px;">${coin.coin.replace('KRW-', '')}</span>
                                    </div>
                                    <span class="${coin.change >= 0 ? 'positive' : 'negative'}" style="font-weight: 600; font-size: 13px;">
                                        ${coin.change >= 0 ? '+' : ''}${coin.change.toFixed(2)}%
                                    </span>
                                </div>
                                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${(coin.volumeKrw / 100000000).toFixed(0)}억원</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Account Info
        async function loadAccountInfo() {
            const account = await fetchAPI('/account');
            const container = document.getElementById('accountInfo');

            if (!account) {
                container.innerHTML = '<div class="empty-state">데이터를 불러올 수 없습니다</div>';
                return;
            }

            const krwBalance = parseFloat(account.krwBalance) || 0;
            const positions = account.positions || [];

            // 포지션 총 가치 계산
            let totalPositionValue = 0;
            let totalPositionCost = 0;
            positions.forEach(pos => {
                const currentPrice = parseFloat(pos.currentPrice) || parseFloat(pos.entryPrice) || 0;
                const amount = parseFloat(pos.amount) || 0;
                const entryPrice = parseFloat(pos.entryPrice) || 0;
                totalPositionValue += currentPrice * amount;
                totalPositionCost += entryPrice * amount;
            });

            // 총 자산 및 수익
            const totalAssets = krwBalance + totalPositionValue;
            const totalProfit = totalPositionValue - totalPositionCost;
            const profitPercent = totalPositionCost > 0 ? ((totalPositionValue / totalPositionCost - 1) * 100) : 0;
            const profitClass = totalProfit >= 0 ? 'positive' : 'negative';

            // 플래시 효과 적용 헬퍼 함수
            const applyFlashEffect = (el, newValue) => {
                const prevValue = parseFloat(el.dataset.prevValue) || 0;
                if (Math.abs(prevValue - newValue) > 0.01) {
                    el.classList.remove('price-flash-up', 'price-flash-down');
                    void el.offsetWidth; // reflow
                    if (newValue > prevValue) {
                        el.classList.add('price-flash-up');
                    } else if (newValue < prevValue) {
                        el.classList.add('price-flash-down');
                    }
                }
                el.dataset.prevValue = newValue;
            };

            // 구조가 없으면 생성, 있으면 애니메이션 적용
            if (!container.querySelector('.account-large-grid')) {
                container.innerHTML = `
                    <div class="account-large-grid">
                        <div class="account-large-item">
                            <div class="account-large-label">총 자산</div>
                            <div class="account-large-value" id="accountTotalAssets" data-prev-value="0"></div>
                        </div>
                        <div class="account-large-item">
                            <div class="account-large-label">KRW 잔액</div>
                            <div class="account-large-value" id="accountKrwBalance" data-prev-value="0"></div>
                        </div>
                        <div class="account-large-item">
                            <div class="account-large-label">포지션 가치</div>
                            <div class="account-large-value" id="accountPositionValue" data-prev-value="0"></div>
                        </div>
                        <div class="account-large-item">
                            <div class="account-large-label">포지션 수익</div>
                            <div class="account-large-value" id="accountPositionProfit" data-prev-value="0"></div>
                        </div>
                    </div>`;
                // 초기값 설정
                const totalAssetsEl = document.getElementById('accountTotalAssets');
                const krwBalanceEl = document.getElementById('accountKrwBalance');
                const posValueEl = document.getElementById('accountPositionValue');
                const profitEl = document.getElementById('accountPositionProfit');

                totalAssetsEl.textContent = formatNumber(totalAssets) + '원';
                totalAssetsEl.dataset.prevValue = totalAssets;
                krwBalanceEl.textContent = formatNumber(krwBalance) + '원';
                krwBalanceEl.dataset.prevValue = krwBalance;
                posValueEl.textContent = formatNumber(totalPositionValue) + '원';
                posValueEl.dataset.prevValue = totalPositionValue;
                profitEl.className = `account-large-value ${profitClass}`;
                profitEl.textContent = `${totalProfit >= 0 ? '+' : ''}${formatNumber(totalProfit)}원 (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%)`;
                profitEl.dataset.prevValue = totalProfit;
            } else {
                // 플래시 효과 + 애니메이션 적용
                const totalAssetsEl = document.getElementById('accountTotalAssets');
                const krwBalanceEl = document.getElementById('accountKrwBalance');
                const posValueEl = document.getElementById('accountPositionValue');
                const profitEl = document.getElementById('accountPositionProfit');

                applyFlashEffect(totalAssetsEl, totalAssets);
                applyFlashEffect(krwBalanceEl, krwBalance);
                applyFlashEffect(posValueEl, totalPositionValue);
                applyFlashEffect(profitEl, totalProfit);

                animateNumber(totalAssetsEl, totalAssets, { suffix: '원', duration: 600 });
                animateNumber(krwBalanceEl, krwBalance, { suffix: '원', duration: 600 });
                animateNumber(posValueEl, totalPositionValue, { suffix: '원', duration: 600 });

                profitEl.className = `account-large-value ${profitClass}`;
                // 수익은 퍼센트도 함께 표시해야 해서 직접 처리
                animateNumber(profitEl, totalProfit, {
                    suffix: `원 (${profitPercent >= 0 ? '+' : ''}${profitPercent.toFixed(2)}%)`,
                    prefix: totalProfit >= 0 ? '+' : '',
                    duration: 600
                });
            }
        }

        // Trade Stats
        let previousTradeStats = null;

        async function loadTradeStats() {
            const stats = await fetchAPI('/statistics');
            const container = document.getElementById('tradeStats');

            if (!stats || !Array.isArray(stats) || stats.length === 0) {
                container.innerHTML = '<div class="empty-state">거래 내역이 없습니다</div>';
                previousTradeStats = null;
                return;
            }

            // 실제로 거래가 있는 코인만 필터링
            const tradedStats = stats.filter(stat => (parseInt(stat.totalTrades) || 0) > 0);

            if (tradedStats.length === 0) {
                container.innerHTML = '<div class="empty-state">아직 거래한 코인이 없습니다</div>';
                previousTradeStats = null;
                return;
            }

            // 거래 횟수 순으로 정렬
            tradedStats.sort((a, b) => (parseInt(b.totalTrades) || 0) - (parseInt(a.totalTrades) || 0));

            // 플래시 효과 헬퍼
            const applyFlash = (el, newVal, prevVal) => {
                if (Math.abs(prevVal - newVal) > 0.01) {
                    el.classList.remove('price-flash-up', 'price-flash-down');
                    void el.offsetWidth;
                    el.classList.add(newVal > prevVal ? 'price-flash-up' : 'price-flash-down');
                }
            };

            // 기존 구조 확인
            const existingCards = container.querySelectorAll('[data-stat-coin]');
            const currentCoins = tradedStats.map(s => s.coin);
            const prevCoins = previousTradeStats ? previousTradeStats.map(s => s.coin) : [];
            const coinsChanged = currentCoins.length !== prevCoins.length ||
                                 !currentCoins.every(c => prevCoins.includes(c));

            if (existingCards.length === 0 || coinsChanged) {
                // 전체 렌더링
                let html = '';
                tradedStats.forEach(stat => {
                    const profit = parseFloat(stat.totalProfit) || 0;
                    const profitClass = profit >= 0 ? 'positive' : 'negative';
                    html += `
                        <div data-stat-coin="${stat.coin}" style="margin-bottom: 15px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px;">
                            <div style="font-weight: 600; margin-bottom: 8px;">${stat.coin}</div>
                            <div style="display: flex; justify-content: space-between; font-size: 13px;">
                                <span style="color: var(--text-secondary);" data-stat-trades="${stat.coin}">거래: ${stat.totalTrades || 0}회</span>
                                <span style="color: var(--text-secondary);" data-stat-winrate="${stat.coin}">승률: ${formatPercent(stat.winRate)}%</span>
                                <span class="stat-value ${profitClass}" data-stat-profit="${stat.coin}" data-prev-value="${profit}" style="font-size: 13px;">${profit >= 0 ? '+' : ''}${formatNumber(profit)}원</span>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                // 증분 업데이트
                tradedStats.forEach(stat => {
                    const profit = parseFloat(stat.totalProfit) || 0;
                    const profitClass = profit >= 0 ? 'positive' : 'negative';

                    // 거래 횟수 업데이트
                    const tradesEl = container.querySelector(`[data-stat-trades="${stat.coin}"]`);
                    if (tradesEl) {
                        tradesEl.textContent = `거래: ${stat.totalTrades || 0}회`;
                    }

                    // 승률 업데이트
                    const winrateEl = container.querySelector(`[data-stat-winrate="${stat.coin}"]`);
                    if (winrateEl) {
                        winrateEl.textContent = `승률: ${formatPercent(stat.winRate)}%`;
                    }

                    // 수익 업데이트 (애니메이션)
                    const profitEl = container.querySelector(`[data-stat-profit="${stat.coin}"]`);
                    if (profitEl) {
                        const prevProfit = parseFloat(profitEl.dataset.prevValue) || 0;
                        applyFlash(profitEl, profit, prevProfit);
                        profitEl.className = `stat-value ${profitClass}`;
                        animateNumber(profitEl, profit, {
                            prefix: profit >= 0 ? '+' : '',
                            suffix: '원',
                            duration: 600
                        });
                        profitEl.dataset.prevValue = profit;
                    }
                });
            }

            previousTradeStats = tradedStats;
        }

        // Positions
        let previousPositionsData = null;

        async function loadPositions() {
            const account = await fetchAPI('/account');
            const container = document.getElementById('positions');

            if (!account?.positions || account.positions.length === 0) {
                container.innerHTML = '<div class="empty-state">보유 포지션 없음</div>';
                previousPositionsData = null;
                return;
            }

            // 플래시 효과 적용 헬퍼
            const applyFlash = (el, newVal, prevVal) => {
                if (Math.abs(prevVal - newVal) > 0.01) {
                    el.classList.remove('price-flash-up', 'price-flash-down');
                    void el.offsetWidth;
                    el.classList.add(newVal > prevVal ? 'price-flash-up' : 'price-flash-down');
                }
            };

            // 기존 구조가 있는지 확인
            const existingGrid = container.querySelector('.positions-large-grid');
            const isFirstLoad = !existingGrid;

            // 현재 포지션 코인 목록
            const currentCoins = account.positions.map(p => p.coin);
            const prevCoins = previousPositionsData ? previousPositionsData.map(p => p.coin) : [];

            // 포지션이 추가/삭제되었으면 전체 다시 렌더링
            const coinsChanged = currentCoins.length !== prevCoins.length ||
                                 !currentCoins.every(c => prevCoins.includes(c));

            if (isFirstLoad || coinsChanged) {
                // 전체 렌더링
                let html = '<div class="positions-large-grid">';
                account.positions.forEach(pos => {
                    const entryPrice = parseFloat(pos.entryPrice) || parseFloat(pos.avgPrice) || 0;
                    const avgPrice = parseFloat(pos.avgPrice) || entryPrice;
                    const amount = parseFloat(pos.amount) || 0;
                    const currentPrice = parseFloat(pos.currentPrice) || entryPrice;
                    const totalInvested = avgPrice * amount;
                    const currentValue = currentPrice * amount;
                    const profit = currentValue - totalInvested;
                    const profitPercent = avgPrice > 0 ? ((currentPrice - avgPrice) / avgPrice * 100) : 0;
                    const profitClass = profit >= 0 ? 'positive' : 'negative';

                    html += `
                        <div class="position-large-card" data-coin="${pos.coin}" onclick="openCoinDetailModal('${pos.coin}')">
                            <div class="position-large-header">
                                <span class="position-large-coin">${pos.coin}</span>
                                <span class="position-large-percent ${profitClass}" data-pos-percent="${pos.coin}" data-prev-percent="${profitPercent}">
                                    ${profitPercent >= 0 ? '+' : ''}${formatPercent(profitPercent)}%
                                </span>
                            </div>
                            <div class="position-large-stats">
                                <div class="position-large-stat">
                                    <div class="position-large-stat-label">평단가</div>
                                    <div class="position-large-stat-value" data-pos-avg="${pos.coin}" data-prev-value="${avgPrice}">${formatNumber(avgPrice)}원</div>
                                </div>
                                <div class="position-large-stat">
                                    <div class="position-large-stat-label">현재가</div>
                                    <div class="position-large-stat-value" data-pos-price="${pos.coin}" data-prev-value="${currentPrice}">${formatNumber(currentPrice)}원</div>
                                </div>
                                <div class="position-large-stat">
                                    <div class="position-large-stat-label">수량</div>
                                    <div class="position-large-stat-value" data-pos-amount="${pos.coin}">${amount > 0.001 ? amount.toFixed(4) : amount.toFixed(8)}</div>
                                </div>
                                <div class="position-large-stat">
                                    <div class="position-large-stat-label">평가금액</div>
                                    <div class="position-large-stat-value" data-pos-value="${pos.coin}" data-prev-value="${currentValue}">${formatNumber(currentValue)}원</div>
                                </div>
                            </div>
                            <div class="position-large-footer">
                                <span class="position-large-footer-label">평가손익</span>
                                <span class="position-large-profit ${profitClass}" data-pos-profit="${pos.coin}" data-prev-value="${profit}">
                                    ${profit >= 0 ? '+' : ''}${formatNumber(profit)}원
                                </span>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                container.innerHTML = html;
            } else {
                // 증분 업데이트 - 애니메이션 적용
                account.positions.forEach(pos => {
                    const entryPrice = parseFloat(pos.entryPrice) || parseFloat(pos.avgPrice) || 0;
                    const avgPrice = parseFloat(pos.avgPrice) || entryPrice;
                    const amount = parseFloat(pos.amount) || 0;
                    const currentPrice = parseFloat(pos.currentPrice) || entryPrice;
                    const totalInvested = avgPrice * amount;
                    const currentValue = currentPrice * amount;
                    const profit = currentValue - totalInvested;
                    const profitPercent = avgPrice > 0 ? ((currentPrice - avgPrice) / avgPrice * 100) : 0;
                    const profitClass = profit >= 0 ? 'positive' : 'negative';

                    // 현재가 업데이트
                    const priceEl = container.querySelector(`[data-pos-price="${pos.coin}"]`);
                    if (priceEl) {
                        const prevPrice = parseFloat(priceEl.dataset.prevValue) || 0;
                        applyFlash(priceEl, currentPrice, prevPrice);
                        animateNumber(priceEl, currentPrice, { suffix: '원', duration: 600 });
                        priceEl.dataset.prevValue = currentPrice;
                    }

                    // 평가금액 업데이트
                    const valueEl = container.querySelector(`[data-pos-value="${pos.coin}"]`);
                    if (valueEl) {
                        const prevValue = parseFloat(valueEl.dataset.prevValue) || 0;
                        applyFlash(valueEl, currentValue, prevValue);
                        animateNumber(valueEl, currentValue, { suffix: '원', duration: 600 });
                        valueEl.dataset.prevValue = currentValue;
                    }

                    // 평가손익 업데이트
                    const profitEl = container.querySelector(`[data-pos-profit="${pos.coin}"]`);
                    if (profitEl) {
                        const prevProfit = parseFloat(profitEl.dataset.prevValue) || 0;
                        applyFlash(profitEl, profit, prevProfit);
                        profitEl.className = `position-large-profit ${profitClass}`;
                        animateNumber(profitEl, profit, {
                            prefix: profit >= 0 ? '+' : '',
                            suffix: '원',
                            duration: 600
                        });
                        profitEl.dataset.prevValue = profit;
                    }

                    // 수익률 업데이트
                    const percentEl = container.querySelector(`[data-pos-percent="${pos.coin}"]`);
                    if (percentEl) {
                        const prevPercent = parseFloat(percentEl.dataset.prevPercent) || 0;
                        applyFlash(percentEl, profitPercent, prevPercent);
                        percentEl.className = `position-large-percent ${profitClass}`;
                        animateNumber(percentEl, profitPercent, {
                            prefix: profitPercent >= 0 ? '+' : '',
                            suffix: '%',
                            decimals: 2,
                            duration: 600
                        });
                        percentEl.dataset.prevPercent = profitPercent;
                    }
                });
            }

            // 이전 데이터 저장
            previousPositionsData = account.positions;
        }

        // Recent Trades
        async function loadRecentTrades() {
            const trades = await fetchAPI('/trades?limit=10');
            const container = document.getElementById('recentTrades');

            if (!trades || !Array.isArray(trades) || trades.length === 0) {
                container.innerHTML = '<div class="empty-state">거래 내역이 없습니다</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>시간</th>
                            <th>코인</th>
                            <th>유형</th>
                            <th>가격</th>
                            <th>수량</th>
                            <th>금액</th>
                            <th>손익</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            trades.slice(0, 10).forEach(trade => {
                const time = trade.exitTime || trade.entryTime;
                const timeStr = time ? new Date(time).toLocaleString('ko-KR') : '-';
                const profit = parseFloat(trade.profit) || 0;
                const profitClass = profit >= 0 ? 'positive' : 'negative';
                const badgeClass = trade.type === 'BUY' ? 'badge-buy' : 'badge-sell';
                const price = trade.type === 'SELL' ? trade.exitPrice : trade.entryPrice;
                const amount = parseFloat(trade.amount) || parseFloat(trade.volume) || 0;
                const totalValue = price * amount;

                html += `
                    <tr>
                        <td style="font-size: 11px; color: var(--text-muted);">${timeStr}</td>
                        <td style="font-weight: 600;">${trade.coin}</td>
                        <td><span class="badge ${badgeClass}">${trade.type}</span></td>
                        <td style="font-size: 12px;">${formatNumber(price)}원</td>
                        <td style="font-size: 12px;">${amount > 0.001 ? amount.toFixed(4) : amount.toFixed(8)}</td>
                        <td style="font-size: 12px;">${formatNumber(totalValue)}원</td>
                        <td style="font-size: 12px;">${formatProfit(profit)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ===== Portfolio History Chart =====
        async function loadPortfolioHistory(period = null, forceShowLoading = false) {
            // Use previously selected period if not specified
            if (period === null) {
                period = currentPortfolioPeriod;
            } else {
                currentPortfolioPeriod = period;
            }

            // Update button states
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-secondary');
            });
            const activeBtn = document.querySelector(`[data-period="${period}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('btn-secondary');
                activeBtn.classList.add('btn-primary');
            }

            const container = document.getElementById('portfolioChart');

            // Only show loading on initial load or when user changes period
            if (!portfolioChartInitialized || forceShowLoading) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>데이터 로딩 중...</div>';
            }

            const data = await fetchAPI(`/portfolio/history?period=${period}`);

            if (!data || !data.data || data.data.length === 0) {
                // 이미 차트가 렌더링된 상태에서 자동 새로고침 시에는 기존 차트 유지
                if (portfolioChartInitialized && !forceShowLoading) {
                    console.log('포트폴리오 데이터 일시 없음 - 기존 차트 유지');
                    return;
                }
                // 초기 로드 또는 사용자가 기간 변경 시에만 "데이터 없음" 메시지 표시
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted);">
                        <div style="font-size: 36px; margin-bottom: 10px;">📊</div>
                        <div>아직 기록된 데이터가 없습니다</div>
                        <div style="font-size: 12px; margin-top: 5px;">자동으로 5분마다 자산을 기록합니다</div>
                    </div>
                `;
                document.getElementById('chartStartValue').textContent = '-';
                document.getElementById('chartEndValue').textContent = '-';
                document.getElementById('chartChange').textContent = '-';
                return;
            }

            // Render chart
            renderPortfolioChart(data.data, container);
            portfolioChartInitialized = true;

            // Update stats
            const firstValue = data.data[0].totalAssets;
            const lastValue = data.data[data.data.length - 1].totalAssets;
            const changeValue = lastValue - firstValue;
            const changePercent = ((changeValue / firstValue) * 100).toFixed(2);

            document.getElementById('chartStartValue').textContent = formatNumber(firstValue) + '원';
            document.getElementById('chartEndValue').textContent = formatNumber(lastValue) + '원';

            const changeEl = document.getElementById('chartChange');
            const isPositive = changeValue >= 0;
            changeEl.style.color = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';
            changeEl.textContent = `${isPositive ? '+' : ''}${formatNumber(changeValue)}원 (${isPositive ? '+' : ''}${changePercent}%)`;
        }

        // Store chart data globally for tooltip calculations
        function renderPortfolioChart(data, container) {
            // Store data for tooltip
            portfolioChartData = data;
            const startValue = data[0]?.totalAssets || 0;

            // Simple SVG line chart
            const width = container.clientWidth || 500;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 30, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const values = data.map(d => d.totalAssets);
            const minVal = Math.min(...values) * 0.995;
            const maxVal = Math.max(...values) * 1.005;
            const range = maxVal - minVal || 1;

            // Create points
            const points = data.map((d, i) => {
                const x = padding.left + (i / (data.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - ((d.totalAssets - minVal) / range) * chartHeight;
                return { x, y, value: d.totalAssets, time: d.timestamp, idx: i };
            });

            // Create path
            const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');

            // Gradient fill
            const areaPath = linePath + ` L ${points[points.length - 1].x} ${padding.top + chartHeight} L ${points[0].x} ${padding.top + chartHeight} Z`;

            const isPositive = points[points.length - 1].y <= points[0].y;
            const strokeColor = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';
            const fillColor = isPositive ? 'rgba(63, 185, 80, 0.15)' : 'rgba(248, 81, 73, 0.15)';

            // Y-axis labels
            const yLabels = [];
            for (let i = 0; i <= 4; i++) {
                const value = minVal + (range * (4 - i) / 4);
                const y = padding.top + (i / 4) * chartHeight;
                yLabels.push(`<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" fill="var(--text-muted)" font-size="10">${(value / 10000).toFixed(0)}만</text>`);
                yLabels.push(`<line x1="${padding.left}" y1="${y}" x2="${padding.left + chartWidth}" y2="${y}" stroke="var(--border-color)" stroke-dasharray="3,3"/>`);
            }

            // X-axis labels (show 5 time points)
            const xLabels = [];
            for (let i = 0; i < 5; i++) {
                const idx = Math.floor((data.length - 1) * i / 4);
                const x = padding.left + (idx / (data.length - 1 || 1)) * chartWidth;
                const time = new Date(data[idx].timestamp);
                // Include new shorter periods in time display
                const isVeryShortPeriod = ['5s', '30s', '1m'].includes(currentPortfolioPeriod);
                const isShortPeriod = ['5m', '15m', '30m', '1h', '24h'].includes(currentPortfolioPeriod);
                let label;
                if (isVeryShortPeriod) {
                    label = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                } else if (isShortPeriod) {
                    label = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                } else {
                    label = time.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                }
                xLabels.push(`<text x="${x}" y="${height - 5}" text-anchor="middle" fill="var(--text-muted)" font-size="10">${label}</text>`);
            }

            // Create circles with data attributes for tooltip
            const circlesHtml = points.map((p, i) => {
                const changeFromStart = startValue > 0 ? ((p.value - startValue) / startValue * 100).toFixed(2) : 0;
                return `<circle
                    class="chart-point"
                    cx="${p.x}"
                    cy="${p.y}"
                    r="4"
                    fill="${strokeColor}"
                    opacity="0.7"
                    data-value="${p.value}"
                    data-time="${p.time}"
                    data-change="${changeFromStart}"
                    data-idx="${i}"
                />`;
            }).join('');

            container.innerHTML = `
                <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" id="portfolioChartSvg">
                    ${yLabels.join('')}
                    ${xLabels.join('')}
                    <defs>
                        <linearGradient id="chartGradient" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="${strokeColor}" stop-opacity="0.3"/>
                            <stop offset="100%" stop-color="${strokeColor}" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path d="${areaPath}" fill="url(#chartGradient)"/>
                    <path d="${linePath}" fill="none" stroke="${strokeColor}" stroke-width="2"/>
                    ${circlesHtml}
                </svg>
            `;

            // Add tooltip event listeners
            setupChartTooltipListeners();
        }

        function setupChartTooltipListeners() {
            const tooltip = document.getElementById('chartTooltip');
            const chartPoints = document.querySelectorAll('.chart-point');

            chartPoints.forEach(point => {
                point.addEventListener('mouseenter', (e) => {
                    const value = parseFloat(point.getAttribute('data-value'));
                    const time = point.getAttribute('data-time');
                    const change = parseFloat(point.getAttribute('data-change'));

                    // Format time
                    const timeDate = new Date(time);
                    const isVeryShortPeriod = ['5s', '30s', '1m'].includes(currentPortfolioPeriod);
                    let timeStr;
                    if (isVeryShortPeriod) {
                        timeStr = timeDate.toLocaleString('ko-KR', {
                            month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', second: '2-digit'
                        });
                    } else {
                        timeStr = timeDate.toLocaleString('ko-KR', {
                            month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit'
                        });
                    }

                    document.getElementById('chartTooltipTime').textContent = timeStr;
                    document.getElementById('chartTooltipValue').textContent = formatNumber(value) + '원';

                    const changeEl = document.getElementById('chartTooltipChange');
                    const isPositive = change >= 0;
                    changeEl.style.color = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';
                    changeEl.textContent = `${isPositive ? '+' : ''}${change}%`;

                    tooltip.classList.add('active');
                });

                point.addEventListener('mousemove', (e) => {
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;
                    let left = e.clientX + 15;
                    let top = e.clientY - tooltipHeight / 2;

                    // Keep tooltip within viewport
                    if (left + tooltipWidth > window.innerWidth) {
                        left = e.clientX - tooltipWidth - 15;
                    }
                    if (top < 10) top = 10;
                    if (top + tooltipHeight > window.innerHeight - 10) {
                        top = window.innerHeight - tooltipHeight - 10;
                    }

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                });

                point.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('active');
                });
            });
        }

        // Update portfolio chart last point in real-time
        function updatePortfolioChartLastPoint(newTotalAssets) {
            if (!portfolioChartData || portfolioChartData.length === 0) return;

            const container = document.getElementById('portfolioChart');
            const svg = document.getElementById('portfolioChartSvg');
            if (!svg) return;

            // Update the last data point
            const lastIdx = portfolioChartData.length - 1;
            portfolioChartData[lastIdx].totalAssets = newTotalAssets;
            portfolioChartData[lastIdx].timestamp = new Date().toISOString();

            // Get chart dimensions
            const width = container.clientWidth || 500;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 30, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const values = portfolioChartData.map(d => d.totalAssets);
            const minVal = Math.min(...values) * 0.995;
            const maxVal = Math.max(...values) * 1.005;
            const range = maxVal - minVal || 1;

            // Recalculate last point position
            const lastX = padding.left + (lastIdx / (portfolioChartData.length - 1 || 1)) * chartWidth;
            const lastY = padding.top + chartHeight - ((newTotalAssets - minVal) / range) * chartHeight;

            // Update last circle position and data
            const lastPoint = svg.querySelector(`.chart-point[data-idx="${lastIdx}"]`);
            if (lastPoint) {
                lastPoint.setAttribute('cy', lastY);
                lastPoint.setAttribute('data-value', newTotalAssets);
                lastPoint.setAttribute('data-time', new Date().toISOString());

                const startValue = portfolioChartData[0]?.totalAssets || 0;
                const changeFromStart = startValue > 0 ? ((newTotalAssets - startValue) / startValue * 100).toFixed(2) : 0;
                lastPoint.setAttribute('data-change', changeFromStart);
            }

            // Update stat displays
            const firstValue = portfolioChartData[0].totalAssets;
            const changeValue = newTotalAssets - firstValue;
            const changePercent = ((changeValue / firstValue) * 100).toFixed(2);

            const endValueEl = document.getElementById('chartEndValue');
            if (endValueEl) endValueEl.textContent = formatNumber(newTotalAssets) + '원';

            const changeEl = document.getElementById('chartChange');
            if (changeEl) {
                const isPositive = changeValue >= 0;
                changeEl.style.color = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';
                changeEl.textContent = `${isPositive ? '+' : ''}${formatNumber(changeValue)}원 (${isPositive ? '+' : ''}${changePercent}%)`;
            }
        }

        // ===== Profit Rate History Chart =====
        async function loadProfitHistory(period = '24h', forceShowLoading = false) {
            const container = document.getElementById('profitChart');
            if (!container) return;

            document.querySelectorAll('[data-profit-period]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.profitPeriod === period);
            });

            if (!profitChartInitialized || forceShowLoading) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>데이터 로드 중...</div>';
            }

            currentProfitPeriod = period;

            try {
                const [historyData, cumulativePnL] = await Promise.all([
                    fetchAPI(`/portfolio/history?period=${period}`),
                    fetchAPI('/cumulative-pnl')
                ]);

                if (cumulativePnL && cumulativePnL.initialSeedMoney) {
                    initialSeedMoney = cumulativePnL.initialSeedMoney;
                }

                if (!historyData || !historyData.data || historyData.data.length === 0) {
                    if (profitChartInitialized && !forceShowLoading) return;
                    container.innerHTML = '<div class="no-data">수익률 데이터가 없습니다</div>';
                    return;
                }

                renderProfitChart(historyData.data, container);
                profitChartInitialized = true;
            } catch (error) {
                console.error('수익률 차트 로드 실패:', error);
                if (!profitChartInitialized) {
                    container.innerHTML = '<div class="no-data">수익률 데이터 로드 실패</div>';
                }
            }
        }

        function renderProfitChart(data, container) {
            profitChartData = data;

            const profitData = data.map(d => ({
                ...d,
                profitPercent: initialSeedMoney > 0 ? ((d.totalAssets - initialSeedMoney) / initialSeedMoney * 100) : 0
            }));

            const width = container.clientWidth || 500;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 30, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const values = profitData.map(d => d.profitPercent);
            const minVal = Math.min(...values, 0) - 0.5;
            const maxVal = Math.max(...values, 0) + 0.5;
            const range = maxVal - minVal || 1;

            const zeroY = padding.top + chartHeight - ((0 - minVal) / range) * chartHeight;

            const points = profitData.map((d, i) => {
                const x = padding.left + (i / (data.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - ((d.profitPercent - minVal) / range) * chartHeight;
                return { x, y, value: d.profitPercent, assets: d.totalAssets, time: d.timestamp, idx: i };
            });

            const linePath = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(' ');
            const areaPath = linePath + ` L ${points[points.length - 1].x} ${zeroY} L ${points[0].x} ${zeroY} Z`;

            const currentProfit = points[points.length - 1]?.value || 0;
            const isPositive = currentProfit >= 0;
            const strokeColor = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';

            const yLabels = [];
            for (let i = 0; i <= 4; i++) {
                const value = minVal + (range * (4 - i) / 4);
                const y = padding.top + (i / 4) * chartHeight;
                yLabels.push(`<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" fill="var(--text-muted)" font-size="10">${value.toFixed(1)}%</text>`);
                yLabels.push(`<line x1="${padding.left}" y1="${y}" x2="${padding.left + chartWidth}" y2="${y}" stroke="var(--border-color)" stroke-dasharray="3,3"/>`);
            }

            if (minVal < 0 && maxVal > 0) {
                yLabels.push(`<line x1="${padding.left}" y1="${zeroY}" x2="${padding.left + chartWidth}" y2="${zeroY}" stroke="var(--text-muted)" stroke-width="1"/>`);
            }

            const xLabels = [];
            for (let i = 0; i < 5; i++) {
                const idx = Math.floor((data.length - 1) * i / 4);
                const x = padding.left + (idx / (data.length - 1 || 1)) * chartWidth;
                const time = new Date(data[idx].timestamp);
                const isVeryShortPeriod = ['5s', '30s', '1m'].includes(currentProfitPeriod);
                const isShortPeriod = ['5m', '15m', '30m', '1h', '24h'].includes(currentProfitPeriod);
                let label;
                if (isVeryShortPeriod) {
                    label = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                } else if (isShortPeriod) {
                    label = time.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
                } else {
                    label = time.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' });
                }
                xLabels.push(`<text x="${x}" y="${height - 5}" text-anchor="middle" fill="var(--text-muted)" font-size="10">${label}</text>`);
            }

            const circlesHtml = points.map((p, i) => {
                const pointColor = p.value >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                return `<circle class="profit-chart-point" cx="${p.x}" cy="${p.y}" r="4" fill="${pointColor}" opacity="0.7" data-value="${p.value.toFixed(2)}" data-assets="${p.assets}" data-time="${p.time}" data-idx="${i}"/>`;
            }).join('');

            container.innerHTML = `
                <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" id="profitChartSvg">
                    ${yLabels.join('')}
                    ${xLabels.join('')}
                    <defs>
                        <linearGradient id="profitGradientPositive" x1="0" y1="0" x2="0" y2="1">
                            <stop offset="0%" stop-color="var(--accent-green)" stop-opacity="0.3"/>
                            <stop offset="100%" stop-color="var(--accent-green)" stop-opacity="0"/>
                        </linearGradient>
                        <linearGradient id="profitGradientNegative" x1="0" y1="1" x2="0" y2="0">
                            <stop offset="0%" stop-color="var(--accent-red)" stop-opacity="0.3"/>
                            <stop offset="100%" stop-color="var(--accent-red)" stop-opacity="0"/>
                        </linearGradient>
                    </defs>
                    <path d="${areaPath}" fill="url(#profitGradient${isPositive ? 'Positive' : 'Negative'})"/>
                    <path d="${linePath}" fill="none" stroke="${strokeColor}" stroke-width="2"/>
                    ${circlesHtml}
                </svg>
            `;

            updateProfitChartStats(profitData);
            setupProfitChartTooltipListeners();
        }

        function updateProfitChartStats(profitData) {
            const startProfit = profitData[0]?.profitPercent || 0;
            const endProfit = profitData[profitData.length - 1]?.profitPercent || 0;
            const maxProfit = Math.max(...profitData.map(d => d.profitPercent));
            const minProfit = Math.min(...profitData.map(d => d.profitPercent));

            const startEl = document.getElementById('profitChartStart');
            const endEl = document.getElementById('profitChartEnd');
            const maxEl = document.getElementById('profitChartMax');
            const minEl = document.getElementById('profitChartMin');

            if (startEl) {
                startEl.textContent = `${startProfit >= 0 ? '+' : ''}${startProfit.toFixed(2)}%`;
                startEl.style.color = startProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            if (endEl) {
                endEl.textContent = `${endProfit >= 0 ? '+' : ''}${endProfit.toFixed(2)}%`;
                endEl.style.color = endProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            if (maxEl) {
                maxEl.textContent = `${maxProfit >= 0 ? '+' : ''}${maxProfit.toFixed(2)}%`;
                maxEl.style.color = 'var(--accent-green)';
            }
            if (minEl) {
                minEl.textContent = `${minProfit >= 0 ? '+' : ''}${minProfit.toFixed(2)}%`;
                minEl.style.color = 'var(--accent-red)';
            }
        }

        function setupProfitChartTooltipListeners() {
            const tooltip = document.getElementById('chartTooltip');
            const chartPoints = document.querySelectorAll('.profit-chart-point');

            chartPoints.forEach(point => {
                point.addEventListener('mouseenter', (e) => {
                    const value = parseFloat(point.getAttribute('data-value'));
                    const assets = parseFloat(point.getAttribute('data-assets'));
                    const time = point.getAttribute('data-time');

                    const timeDate = new Date(time);
                    const isVeryShortPeriod = ['5s', '30s', '1m'].includes(currentProfitPeriod);
                    let timeStr;
                    if (isVeryShortPeriod) {
                        timeStr = timeDate.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    } else {
                        timeStr = timeDate.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                    }

                    document.getElementById('chartTooltipTime').textContent = timeStr;
                    document.getElementById('chartTooltipValue').textContent = formatNumber(assets) + '원';

                    const changeEl = document.getElementById('chartTooltipChange');
                    const isPositive = value >= 0;
                    changeEl.style.color = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';
                    changeEl.textContent = `${isPositive ? '+' : ''}${value}%`;

                    tooltip.classList.add('active');
                });

                point.addEventListener('mousemove', (e) => {
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;
                    let left = e.clientX + 15;
                    let top = e.clientY - tooltipHeight / 2;

                    if (left + tooltipWidth > window.innerWidth) left = e.clientX - tooltipWidth - 15;
                    if (top < 10) top = 10;
                    if (top + tooltipHeight > window.innerHeight - 10) top = window.innerHeight - tooltipHeight - 10;

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                });

                point.addEventListener('mouseleave', () => {
                    tooltip.classList.remove('active');
                });
            });
        }

        // Update profit chart last point in real-time
        function updateProfitChartLastPoint(newTotalAssets) {
            if (!profitChartData || profitChartData.length === 0) return;

            const container = document.getElementById('profitChart');
            const svg = document.getElementById('profitChartSvg');
            if (!svg) return;

            const lastIdx = profitChartData.length - 1;
            profitChartData[lastIdx].totalAssets = newTotalAssets;
            profitChartData[lastIdx].timestamp = new Date().toISOString();

            const newProfitPercent = initialSeedMoney > 0 ? ((newTotalAssets - initialSeedMoney) / initialSeedMoney * 100) : 0;

            const width = container.clientWidth || 500;
            const height = 250;
            const padding = { top: 20, right: 20, bottom: 30, left: 70 };
            const chartWidth = width - padding.left - padding.right;
            const chartHeight = height - padding.top - padding.bottom;

            const profitValues = profitChartData.map(d => initialSeedMoney > 0 ? ((d.totalAssets - initialSeedMoney) / initialSeedMoney * 100) : 0);
            profitValues[lastIdx] = newProfitPercent;

            const minVal = Math.min(...profitValues, 0) - 0.5;
            const maxVal = Math.max(...profitValues, 0) + 0.5;
            const range = maxVal - minVal || 1;

            const lastX = padding.left + (lastIdx / (profitChartData.length - 1 || 1)) * chartWidth;
            const lastY = padding.top + chartHeight - ((newProfitPercent - minVal) / range) * chartHeight;

            const lastPoint = svg.querySelector(`.profit-chart-point[data-idx="${lastIdx}"]`);
            if (lastPoint) {
                lastPoint.setAttribute('cy', lastY);
                lastPoint.setAttribute('data-value', newProfitPercent.toFixed(2));
                lastPoint.setAttribute('data-assets', newTotalAssets);
                lastPoint.setAttribute('data-time', new Date().toISOString());
                lastPoint.setAttribute('fill', newProfitPercent >= 0 ? 'var(--accent-green)' : 'var(--accent-red)');
            }

            const endEl = document.getElementById('profitChartEnd');
            if (endEl) {
                endEl.textContent = `${newProfitPercent >= 0 ? '+' : ''}${newProfitPercent.toFixed(2)}%`;
                endEl.style.color = newProfitPercent >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
        }

        // ===== Quick Trade Functions =====
        let quickTradeMode = 'buy';

        function setQuickTradeMode(mode) {
            quickTradeMode = mode;
            const buyTab = document.getElementById('quickBuyTab');
            const sellTab = document.getElementById('quickSellTab');
            const buyPanel = document.getElementById('quickBuyPanel');
            const sellPanel = document.getElementById('quickSellPanel');

            if (mode === 'buy') {
                buyTab.className = 'btn btn-success btn-sm';
                sellTab.className = 'btn btn-secondary btn-sm';
                buyPanel.style.display = 'block';
                sellPanel.style.display = 'none';
                updateBuyPresetInfo();
            } else {
                buyTab.className = 'btn btn-secondary btn-sm';
                sellTab.className = 'btn btn-danger btn-sm';
                buyPanel.style.display = 'none';
                sellPanel.style.display = 'block';
                updateSellPresetInfo();
            }
        }

        // 보유 현금 및 보유 코인 평가액 캐시
        let cachedAvailableKrw = 0;
        let cachedTotalHolding = 0;

        // 매수 프리셋 정보 업데이트
        async function updateBuyPresetInfo() {
            try {
                const account = await fetchAPI('/account');
                if (account) {
                    cachedAvailableKrw = parseFloat(account.krwBalance) || 0;
                    document.getElementById('availableKrwDisplay').textContent = formatNumber(cachedAvailableKrw) + '원';
                }
            } catch (e) {
                console.error('매수 프리셋 정보 업데이트 실패:', e);
            }
        }

        // 매도 프리셋 정보 업데이트
        async function updateSellPresetInfo() {
            try {
                const account = await fetchAPI('/account');
                if (account && account.positions) {
                    cachedTotalHolding = account.positions.reduce((sum, pos) => {
                        return sum + (parseFloat(pos.currentValue) || 0);
                    }, 0);
                    document.getElementById('totalHoldingDisplay').textContent = formatNumber(cachedTotalHolding) + '원';
                } else {
                    cachedTotalHolding = 0;
                    document.getElementById('totalHoldingDisplay').textContent = '0원';
                }
            } catch (e) {
                console.error('매도 프리셋 정보 업데이트 실패:', e);
            }
        }

        // 매수 프리셋 설정
        async function setBuyPreset(percent) {
            if (cachedAvailableKrw <= 0) {
                await updateBuyPresetInfo();
            }

            const amount = percent === 0 ? 0 : Math.floor(cachedAvailableKrw * (percent / 100));
            document.getElementById('quickBuyAmount').value = formatMoneyInput(amount.toString());

            // 활성 버튼 표시
            document.querySelectorAll('#quickBuyPanel .preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 매도 프리셋 설정
        async function setSellPreset(percent) {
            if (cachedTotalHolding <= 0) {
                await updateSellPresetInfo();
            }

            const amount = percent === 0 ? 0 : Math.floor(cachedTotalHolding * (percent / 100));
            document.getElementById('quickSellAmount').value = formatMoneyInput(amount.toString());

            // 활성 버튼 표시
            document.querySelectorAll('#quickSellPanel .preset-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 초기 로드 시 프리셋 정보 업데이트
        setTimeout(() => {
            updateBuyPresetInfo();
            updateSellPresetInfo();
        }, 1500);

        // 숫자 콤마 포맷팅 함수
        function formatMoneyInput(value) {
            // 숫자만 추출
            const num = value.replace(/[^\d]/g, '');
            if (!num) return '';
            // 콤마 추가
            return parseInt(num).toLocaleString();
        }

        // 콤마 제거하고 숫자 반환
        function parseMoneyInput(value) {
            return parseInt(value.replace(/[^\d]/g, '')) || 0;
        }

        // 숫자 입력 필드에 콤마 포맷팅 적용
        document.addEventListener('DOMContentLoaded', function() {
            // 금액 입력 필드 포맷팅
            const moneyInputs = document.querySelectorAll('.money-input');
            moneyInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    const cursorPos = this.selectionStart;
                    const oldLength = this.value.length;
                    this.value = formatMoneyInput(this.value);
                    const newLength = this.value.length;
                    // 커서 위치 조정
                    const newPos = cursorPos + (newLength - oldLength);
                    this.setSelectionRange(newPos, newPos);
                });
            });

            // 숫자 입력 필드 포맷팅 (분할 개수용)
            const numberInputs = document.querySelectorAll('.number-input');
            numberInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    const cursorPos = this.selectionStart;
                    const oldLength = this.value.length;
                    this.value = formatMoneyInput(this.value);
                    const newLength = this.value.length;
                    const newPos = cursorPos + (newLength - oldLength);
                    this.setSelectionRange(newPos, newPos);
                });
            });

            // 매도 전략 설명 업데이트
            const strategySelect = document.getElementById('quickSellStrategy');
            if (strategySelect) {
                strategySelect.addEventListener('change', function() {
                    const desc = document.getElementById('sellStrategyDesc');
                    const descriptions = {
                        'worst': '손실이 큰 포지션부터 정리하여 추가 손실을 방지합니다.',
                        'best': '수익이 큰 포지션부터 정리하여 이익을 실현합니다.',
                        'overbought': 'RSI가 높은(과매수) 코인부터 정리합니다.'
                    };
                    desc.textContent = descriptions[this.value] || '';
                });
            }
        });

        async function executeSmartBuy() {
            const amount = parseMoneyInput(document.getElementById('quickBuyAmount').value);

            if (!amount || amount < 10000) {
                showToast('최소 10,000원 이상 입력해주세요.', 'error');
                return;
            }

            if (!confirm(`총 ${formatNumber(amount)}원으로 조건에 맞는 코인에 자동 매수하시겠습니까?\n(점수 60점 이상, 코인당 최소 5,000원)`)) {
                return;
            }

            showToast('스마트 자동 매수 분석 중...', 'info');

            try {
                const response = await fetch('/api/trade/smart-buy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        totalAmount: amount,
                        minScore: 60,
                        maxCoins: 0,  // 0 = 무제한
                        strategy: 'score'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`✅ ${result.trades.length}개 코인 매수 완료! (${result.qualifiedCoins}개 적합, 총 ${formatNumber(result.totalInvested)}원)`, 'success');
                    // Refresh data
                    loadOverviewStats();
                    loadAccountInfo();
                    loadPositions();
                    loadManualPositions();
                    loadRecentTrades();
                } else {
                    showToast(`❌ 매수 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`❌ 오류: ${error.message}`, 'error');
            }
        }

        async function executeSmartSell() {
            const targetAmount = parseMoneyInput(document.getElementById('quickSellAmount').value);
            const strategy = document.getElementById('quickSellStrategy').value;

            if (!targetAmount || targetAmount < 1000) {
                showToast('❌ 최소 1,000원 이상 입력해주세요', 'error');
                return;
            }

            const strategyNames = {
                'worst': '손실 큰 것부터',
                'best': '수익 큰 것부터',
                'overbought': '과매수 것부터'
            };

            if (!confirm(`${formatNumber(targetAmount)}원을 "${strategyNames[strategy]}" 전략으로 자동 매도하시겠습니까?`)) {
                return;
            }

            showToast('스마트 자동 매도 실행 중...', 'info');

            try {
                const response = await fetch('/api/trade/smart-sell', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        targetAmount: targetAmount,
                        strategy: strategy
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showToast(`✅ ${result.trades.length}개 코인 매도 완료! 총 ${formatNumber(result.totalReceived)}원 회수`, 'success');
                    // Refresh data
                    loadOverviewStats();
                    loadAccountInfo();
                    loadPositions();
                    loadManualPositions();
                    loadSellRecommendations();
                    loadRecentTrades();
                } else {
                    showToast(`❌ 매도 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                showToast(`❌ 오류: ${error.message}`, 'error');
            }
        }

        // ===== 매수 추천 로드 =====
        async function loadBuyRecommendations() {
            const container = document.getElementById('buyRecommendations');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>매수 추천 분석 중...</div>';
            try {
                const data = await fetchAPI('/coin-analysis');
                if (!data || !data.recommendations) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--text-muted);">분석 데이터를 불러올 수 없습니다.</div>';
                    return;
                }
                const buyRecs = data.recommendations.filter(r => r.action.includes('BUY') || r.action === 'HOLD_OR_BUY').sort((a, b) => b.buyScore - a.buyScore);
                if (buyRecs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;"><div style="font-size: 36px; margin-bottom: 10px;">🤔</div><div style="color: var(--text-muted);">현재 매수 추천 코인이 없습니다</div></div>';
                    return;
                }
                let html = '';
                buyRecs.slice(0, 10).forEach(rec => {
                    const sym = rec.coin.replace('KRW-', '');
                    const rsi = rec.indicators && rec.indicators.rsi ? rec.indicators.rsi : '-';
                    const macd = rec.indicators && rec.indicators.macd ? rec.indicators.macd : '-';
                    html += '<div class="rec-card buy-rec"><div class="rec-header"><div><div class="rec-coin">' + sym + '</div><div class="rec-price">' + formatNumber(rec.currentPrice) + '원</div></div><div class="rec-score">' + rec.buyScore + '점</div></div><div class="rec-reason">' + rec.reason + '</div><div class="rec-indicators"><span class="indicator-badge">RSI ' + rsi + '</span><span class="indicator-badge">MACD ' + macd + '</span></div><div class="rec-trade-form"><input type="text" class="form-input money-input" placeholder="금액 (원)" id="buyAmount-' + sym + '" style="flex: 1; padding: 8px; font-size: 13px;"><button class="btn btn-success btn-sm" onclick="manualBuyCoin(\'' + rec.coin + '\', \'buyAmount-' + sym + '\')">매수</button></div></div>';
                });
                container.innerHTML = html;
                container.querySelectorAll('.money-input').forEach(input => {
                    input.addEventListener('input', function() { let val = this.value.replace(/[^0-9]/g, ''); if (val) this.value = parseInt(val).toLocaleString(); });
                });
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--accent-red);">오류: ' + error.message + '</div>';
            }
        }

        // ===== 매도 추천 로드 =====
        async function loadSellRecommendations() {
            const container = document.getElementById('sellRecommendations');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>매도 추천 분석 중...</div>';
            try {
                const positionsData = await fetchAPI('/positions');
                if (!positionsData || !positionsData.holdings || positionsData.holdings.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;"><div style="font-size: 36px; margin-bottom: 10px;">📭</div><div style="color: var(--text-muted);">보유 중인 코인이 없습니다</div></div>';
                    return;
                }
                const analysisData = await fetchAPI('/coin-analysis');
                let sellRecs = [];
                for (const holding of positionsData.holdings) {
                    const coin = holding.coin;
                    const analysis = analysisData && analysisData.recommendations ? analysisData.recommendations.find(r => r.coin === coin) : null;
                    const profitPercent = parseFloat(holding.profitPercent) || 0;
                    const isSellRec = analysis && analysis.action && analysis.action.includes('SELL');
                    const isLoss = profitPercent < -5;
                    const rsiVal = analysis && analysis.indicators && analysis.indicators.rsi ? analysis.indicators.rsi : 0;
                    const isOverbought = rsiVal > 70;
                    if (isSellRec || isLoss || isOverbought || profitPercent > 10) {
                        let reason = isSellRec ? '매도 신호' : isLoss ? '손실 ' + profitPercent.toFixed(2) + '%' : isOverbought ? '과매수 상태' : '수익 ' + profitPercent.toFixed(2) + '%';
                        let category = isSellRec ? 'signal' : isLoss ? 'loss' : isOverbought ? 'overbought' : 'profit';
                        sellRecs.push(Object.assign({}, holding, { reason: reason, category: category }));
                    }
                }
                sellRecs.sort((a, b) => { const order = { loss: 0, overbought: 1, signal: 2, profit: 3 }; return order[a.category] - order[b.category]; });
                if (sellRecs.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 30px;"><div style="font-size: 36px; margin-bottom: 10px;">👍</div><div style="color: var(--text-muted);">현재 매도 추천 코인이 없습니다</div></div>';
                    return;
                }
                let html = '';
                sellRecs.forEach(rec => {
                    const sym = rec.coin.replace('KRW-', '');
                    const profitClass = parseFloat(rec.profitPercent) >= 0 ? 'positive' : 'negative';
                    const sign = parseFloat(rec.profitPercent) >= 0 ? '+' : '';
                    const amt = rec.amount ? rec.amount.toFixed(4) : '0';
                    const amtFull = rec.amount ? rec.amount.toFixed(8) : '';
                    html += '<div class="rec-card sell-rec"><div class="rec-header"><div><div class="rec-coin">' + sym + '</div><div class="rec-price">' + formatNumber(rec.currentPrice) + '원</div></div><div class="rec-profit ' + profitClass + '">' + sign + rec.profitPercent + '%</div></div><div class="rec-holding">보유: ' + amt + ' ' + sym + ' (' + formatNumber(rec.currentValue) + '원)</div><div class="rec-reason">' + rec.reason + '</div><div class="rec-trade-form"><input type="text" class="form-input" placeholder="수량" id="sellQty-' + sym + '" value="' + amtFull + '" style="flex: 1; padding: 8px;"><button class="btn btn-sm" onclick="setSellQtyPercent(\'' + sym + '\', ' + rec.amount + ', 50)">50%</button><button class="btn btn-sm" onclick="setSellQtyPercent(\'' + sym + '\', ' + rec.amount + ', 100)">전량</button><button class="btn btn-danger btn-sm" onclick="manualSellCoin(\'' + rec.coin + '\', \'sellQty-' + sym + '\')">매도</button></div></div>';
                });
                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--accent-red);">오류: ' + error.message + '</div>';
            }
        }

        // ===== 보유 포지션 로드 =====
        async function loadManualPositions() {
            const container = document.getElementById('manualPositions');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>포지션 로딩 중...</div>';
            try {
                const data = await fetchAPI('/positions');
                if (!data || !data.holdings || data.holdings.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px;"><div style="font-size: 48px; margin-bottom: 15px;">📭</div><div style="color: var(--text-muted);">보유 중인 코인이 없습니다</div></div>';
                    return;
                }
                let html = '<div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-muted);">총 ' + data.holdings.length + '개 보유</span><span style="color: var(--text-muted);">평가금액: ' + formatNumber(data.totalValue || 0) + '원</span></div>';
                data.holdings.forEach(h => {
                    const sym = h.coin.replace('KRW-', '');
                    const profitClass = parseFloat(h.profitPercent) >= 0 ? 'positive' : 'negative';
                    const profit = parseFloat(h.profit) || 0;
                    const profitPct = parseFloat(h.profitPercent) || 0;
                    const profitSign = profit >= 0 ? '+' : '';
                    const pctSign = profitPct >= 0 ? '+' : '';
                    const amt = h.amount ? h.amount.toFixed(4) : '0';
                    const amtFull = h.amount ? h.amount.toFixed(8) : '';
                    html += '<div class="position-card"><div class="position-header"><div class="position-info"><div class="position-coin">' + sym + '</div><div class="position-details">보유: <strong>' + amt + '</strong> | 평단: ' + formatNumber(h.avgPrice) + '원</div></div><div class="position-value"><div style="font-weight: 600;">' + formatNumber(h.currentValue) + '원</div><div class="position-profit ' + profitClass + '">' + profitSign + formatNumber(profit) + '원 (' + pctSign + profitPct.toFixed(2) + '%)</div></div></div><div class="position-actions"><div class="position-action-group"><input type="text" class="form-input money-input" placeholder="추가매수 금액" id="addBuy-' + sym + '" style="width: 110px; padding: 6px;"><button class="btn btn-success btn-sm" onclick="manualBuyCoin(\'' + h.coin + '\', \'addBuy-' + sym + '\')">추가매수</button></div><div class="position-action-group"><input type="text" class="form-input" placeholder="매도 수량" id="posSell-' + sym + '" value="' + amtFull + '" style="width: 110px; padding: 6px;"><button class="btn btn-sm" onclick="setSellQtyPercent(\'' + sym + '\', ' + h.amount + ', 25, \'posSell\')" style="padding: 4px 6px; font-size: 10px;">25%</button><button class="btn btn-sm" onclick="setSellQtyPercent(\'' + sym + '\', ' + h.amount + ', 50, \'posSell\')" style="padding: 4px 6px; font-size: 10px;">50%</button><button class="btn btn-sm" onclick="setSellQtyPercent(\'' + sym + '\', ' + h.amount + ', 100, \'posSell\')" style="padding: 4px 6px; font-size: 10px;">전량</button><button class="btn btn-danger btn-sm" onclick="manualSellCoin(\'' + h.coin + '\', \'posSell-' + sym + '\')">매도</button></div></div></div>';
                });
                container.innerHTML = html;
                container.querySelectorAll('.money-input').forEach(input => {
                    input.addEventListener('input', function() { let val = this.value.replace(/[^0-9]/g, ''); if (val) this.value = parseInt(val).toLocaleString(); });
                });
            } catch (error) {
                container.innerHTML = '<div style="text-align: center; padding: 30px; color: var(--accent-red);">오류: ' + error.message + '</div>';
            }
        }

        // ===== 개별 코인 수동 매수 =====
        async function manualBuyCoin(coin, inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const amount = parseMoneyInput(input.value);
            const symbol = coin.replace('KRW-', '');
            if (!amount || amount < 5000) { showToast('최소 5,000원 이상 입력해주세요', 'error'); return; }
            if (!confirm(symbol + '을(를) ' + formatNumber(amount) + '원어치 매수하시겠습니까?')) return;
            showToast(symbol + ' 매수 주문 중...', 'info');
            try {
                const response = await fetch('/api/trade/buy', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ coin: coin, amount: amount }) });
                const result = await response.json();
                if (result.success) { showToast('✅ ' + symbol + ' ' + formatNumber(amount) + '원 매수 완료!', 'success'); input.value = ''; loadOverviewStats(); loadManualPositions(); loadBuyRecommendations(); loadPortfolioAnalysis(); loadAccountInfo(); loadPositions(); loadRecentTrades(); }
                else { showToast('❌ 매수 실패: ' + result.error, 'error'); }
            } catch (error) { showToast('❌ 오류: ' + error.message, 'error'); }
        }

        // ===== 개별 코인 수동 매도 =====
        async function manualSellCoin(coin, inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            const quantity = parseFloat(input.value.replace(/,/g, ''));
            const symbol = coin.replace('KRW-', '');
            if (!quantity || quantity <= 0) { showToast('매도 수량을 입력해주세요', 'error'); return; }
            if (!confirm(symbol + ' ' + quantity + '개를 매도하시겠습니까?')) return;
            showToast(symbol + ' 매도 주문 중...', 'info');
            try {
                const response = await fetch('/api/trade/sell', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ coin: coin, quantity: quantity }) });
                const result = await response.json();
                if (result.success) { showToast('✅ ' + symbol + ' 매도 완료!', 'success'); loadOverviewStats(); loadManualPositions(); loadSellRecommendations(); loadPortfolioAnalysis(); loadAccountInfo(); loadPositions(); loadRecentTrades(); }
                else { showToast('❌ 매도 실패: ' + result.error, 'error'); }
            } catch (error) { showToast('❌ 오류: ' + error.message, 'error'); }
        }

        // ===== 매도 수량 비율 설정 =====
        function setSellQtyPercent(symbol, totalAmount, percent, prefix) {
            prefix = prefix || 'sellQty';
            const input = document.getElementById(prefix + '-' + symbol);
            if (!input || !totalAmount) return;
            input.value = (totalAmount * percent / 100).toFixed(8);
        }

        // Save portfolio snapshot periodically
        async function savePortfolioSnapshot() {
            try {
                await fetch('/api/portfolio/snapshot', { method: 'POST' });
            } catch (e) {
                console.log('Portfolio snapshot save failed:', e.message);
            }
        }

        // Coin Analysis - 전체 코인 평가 리스트
        let analysisLoading = false;
        let allCoinScoresData = [];

        async function loadCoinAnalysis() {
            if (analysisLoading) return;

            const container = document.getElementById('coinAnalysis');
            container.innerHTML = '<div class="loading" style="padding: 40px;"><div class="spinner"></div>상위 100개 코인 분석 중... (약 30초 소요)</div>';

            analysisLoading = true;
            const data = await fetchAPI('/all-coin-scores');
            analysisLoading = false;

            if (!data?.coins || data.coins.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px; text-align: center;">
                        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">분석 데이터가 없습니다</div>
                        <div style="font-size: 13px; color: var(--text-muted);">잠시 후 다시 시도해주세요.</div>
                    </div>
                `;
                return;
            }

            // 데이터 저장 (필터/정렬용)
            allCoinScoresData = data.coins;

            // 통계 업데이트
            updateAnalysisStats(data);

            // 리스트 렌더링
            renderCoinAnalysisList(data.coins);
        }

        function updateAnalysisStats(data) {
            const statsContainer = document.getElementById('analysisStats');
            const buyCount = data.coins.filter(c => c.recommendation === 'BUY').length;
            const sellCount = data.coins.filter(c => c.recommendation === 'SELL').length;
            const holdCount = data.coins.filter(c => c.recommendation === 'HOLD').length;
            const strongCount = data.coins.filter(c => ['STRONG', 'VERY_STRONG'].includes(c.signalStrength)).length;

            statsContainer.innerHTML = `
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);">${data.coins.length}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">분석 코인</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${buyCount}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">매수 추천</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--accent-red);">${sellCount}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">매도 추천</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--accent-yellow);">${holdCount}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">관망</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--accent-blue);">${strongCount}</div>
                    <div style="font-size: 11px; color: var(--text-muted);">강한 신호</div>
                </div>
            `;
        }

        function renderCoinAnalysisList(coins) {
            const container = document.getElementById('coinAnalysis');

            if (!coins || coins.length === 0) {
                container.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-muted);">표시할 코인이 없습니다.</div>';
                return;
            }

            let html = '';
            coins.forEach(coin => {
                const change = parseFloat(coin.change24h) || 0;
                const changeClass = change >= 0 ? 'positive' : 'negative';
                const changePrefix = change >= 0 ? '+' : '';

                // 추천 스타일
                const recStyles = {
                    'BUY': { label: '매수', color: 'var(--accent-green)', bg: 'rgba(63, 185, 80, 0.15)' },
                    'SELL': { label: '매도', color: 'var(--accent-red)', bg: 'rgba(248, 81, 73, 0.15)' },
                    'HOLD': { label: '관망', color: 'var(--accent-yellow)', bg: 'rgba(210, 153, 34, 0.15)' }
                };
                const recStyle = recStyles[coin.recommendation] || recStyles['HOLD'];

                // 신호 강도 스타일
                const strengthStyles = {
                    'WEAK': { label: '약함', color: 'var(--text-muted)', bg: 'var(--bg-tertiary)' },
                    'MEDIUM': { label: '보통', color: 'var(--accent-blue)', bg: 'rgba(88, 166, 255, 0.15)' },
                    'STRONG': { label: '강함', color: 'var(--accent-green)', bg: 'rgba(63, 185, 80, 0.15)' },
                    'VERY_STRONG': { label: '매우강함', color: '#a855f7', bg: 'rgba(168, 85, 247, 0.15)' }
                };
                const strengthStyle = strengthStyles[coin.signalStrength] || strengthStyles['WEAK'];

                // RSI 색상
                const rsi = coin.indicators?.rsi || 0;
                let rsiColor = 'var(--text-secondary)';
                if (rsi <= 30) rsiColor = 'var(--accent-green)';
                else if (rsi >= 70) rsiColor = 'var(--accent-red)';

                // MACD 표시
                const macdSignal = coin.indicators?.macdSignal || 'NEUTRAL';
                const macdStyles = {
                    'BULLISH': { label: '↑', color: 'var(--accent-green)' },
                    'BEARISH': { label: '↓', color: 'var(--accent-red)' },
                    'NEUTRAL': { label: '-', color: 'var(--text-muted)' }
                };
                const macdStyle = macdStyles[macdSignal] || macdStyles['NEUTRAL'];

                html += `
                    <div class="analysis-row" style="display: grid; grid-template-columns: 140px 100px 80px 60px 60px 80px 100px 100px 70px; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-color); align-items: center; transition: background 0.15s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                        <div style="cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            <div style="font-weight: 600; font-size: 14px;">${coin.symbol}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">${coin.coin}</div>
                        </div>
                        <div style="text-align: right; font-weight: 500; cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            ${formatNumber(coin.currentPrice)}
                        </div>
                        <div style="text-align: right; cursor: pointer;" class="${changeClass}" onclick="showCoinDetailModal('${coin.coin}')">
                            ${changePrefix}${change.toFixed(2)}%
                        </div>
                        <div style="text-align: center; color: ${rsiColor}; font-weight: 500; cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            ${rsi.toFixed(0)}
                        </div>
                        <div style="text-align: center; color: ${macdStyle.color}; font-weight: 600; font-size: 16px; cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            ${macdStyle.label}
                        </div>
                        <div style="text-align: center; cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            <div style="font-size: 12px; color: var(--accent-green);">+${coin.buyScore || 0}</div>
                            <div style="font-size: 12px; color: var(--accent-red);">-${coin.sellScore || 0}</div>
                        </div>
                        <div style="text-align: center; cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            <span style="padding: 3px 8px; border-radius: 4px; font-size: 11px; background: ${strengthStyle.bg}; color: ${strengthStyle.color};">
                                ${strengthStyle.label}
                            </span>
                        </div>
                        <div style="text-align: center; cursor: pointer;" onclick="showCoinDetailModal('${coin.coin}')">
                            <span style="padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; background: ${recStyle.bg}; color: ${recStyle.color};">
                                ${recStyle.label}
                            </span>
                        </div>
                        <div style="text-align: center;">
                            <button class="btn btn-success btn-sm" style="padding: 4px 10px; font-size: 11px;" onclick="event.stopPropagation(); openAcceptModal('${coin.coin}', 'BUY', ${coin.currentPrice}, 50000);">매수</button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filterAnalysisResults() {
            const filter = document.getElementById('analysisFilter').value;
            let filtered = [...allCoinScoresData];

            if (filter === 'buy') {
                filtered = filtered.filter(c => c.recommendation === 'BUY');
            } else if (filter === 'sell') {
                filtered = filtered.filter(c => c.recommendation === 'SELL');
            } else if (filter === 'hold') {
                filtered = filtered.filter(c => c.recommendation === 'HOLD');
            } else if (filter === 'strong') {
                filtered = filtered.filter(c => ['STRONG', 'VERY_STRONG'].includes(c.signalStrength));
            }

            // 현재 정렬도 적용
            const sortBy = document.getElementById('analysisSort').value;
            filtered = sortCoinsBy(filtered, sortBy);

            renderCoinAnalysisList(filtered);
        }

        function sortAnalysisResults() {
            const sortBy = document.getElementById('analysisSort').value;
            const filter = document.getElementById('analysisFilter').value;

            let filtered = [...allCoinScoresData];

            // 필터 적용
            if (filter === 'buy') filtered = filtered.filter(c => c.recommendation === 'BUY');
            else if (filter === 'sell') filtered = filtered.filter(c => c.recommendation === 'SELL');
            else if (filter === 'hold') filtered = filtered.filter(c => c.recommendation === 'HOLD');
            else if (filter === 'strong') filtered = filtered.filter(c => ['STRONG', 'VERY_STRONG'].includes(c.signalStrength));

            // 정렬 적용
            filtered = sortCoinsBy(filtered, sortBy);

            renderCoinAnalysisList(filtered);
        }

        function sortCoinsBy(coins, sortBy) {
            switch (sortBy) {
                case 'score':
                    return coins.sort((a, b) => (b.totalScore || 0) - (a.totalScore || 0));
                case 'buy':
                    return coins.sort((a, b) => (b.buyScore || 0) - (a.buyScore || 0));
                case 'sell':
                    return coins.sort((a, b) => (b.sellScore || 0) - (a.sellScore || 0));
                case 'volume':
                    return coins.sort((a, b) => (b.volume24h || 0) - (a.volume24h || 0));
                case 'change':
                    return coins.sort((a, b) => Math.abs(b.change24h || 0) - Math.abs(a.change24h || 0));
                default:
                    return coins;
            }
        }

        async function showCoinDetailModal(coinCode) {
            const coin = allCoinScoresData.find(c => c.coin === coinCode);
            if (!coin) return;

            const change = parseFloat(coin.change24h) || 0;
            const changeClass = change >= 0 ? 'positive' : 'negative';
            const changePrefix = change >= 0 ? '+' : '';

            const recStyles = {
                'BUY': { label: '매수 추천', color: 'var(--accent-green)', bg: 'rgba(63, 185, 80, 0.2)' },
                'SELL': { label: '매도 추천', color: 'var(--accent-red)', bg: 'rgba(248, 81, 73, 0.2)' },
                'HOLD': { label: '관망', color: 'var(--accent-yellow)', bg: 'rgba(210, 153, 34, 0.2)' }
            };
            const recStyle = recStyles[coin.recommendation] || recStyles['HOLD'];

            const content = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h2 style="margin: 0; font-size: 24px;">${coin.symbol}</h2>
                            <div style="color: var(--text-muted); font-size: 13px;">${coin.coin}</div>
                        </div>
                        <span style="padding: 8px 16px; border-radius: 8px; font-size: 14px; font-weight: 600; background: ${recStyle.bg}; color: ${recStyle.color};">
                            ${recStyle.label}
                        </span>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px;">
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">현재가</div>
                            <div style="font-size: 18px; font-weight: 700;">${formatNumber(coin.currentPrice)}원</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">24h 변동</div>
                            <div style="font-size: 18px; font-weight: 700;" class="${changeClass}">${changePrefix}${change.toFixed(2)}%</div>
                        </div>
                        <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; text-align: center;">
                            <div style="font-size: 11px; color: var(--text-muted); margin-bottom: 4px;">거래량</div>
                            <div style="font-size: 18px; font-weight: 700;">${formatNumber(Math.round((coin.volume24h || 0) / 1000000))}M</div>
                        </div>
                    </div>

                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 14px;">기술적 지표</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">RSI</div>
                                <div style="font-size: 16px; font-weight: 600;">${(coin.indicators?.rsi || 0).toFixed(1)}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">MACD</div>
                                <div style="font-size: 16px; font-weight: 600;">${coin.indicators?.macdSignal || '-'}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">BB%</div>
                                <div style="font-size: 16px; font-weight: 600;">${((coin.indicators?.bbPercent || 0) * 100).toFixed(0)}%</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: var(--text-muted);">신호강도</div>
                                <div style="font-size: 16px; font-weight: 600;">${coin.signalStrength || '-'}</div>
                            </div>
                        </div>
                    </div>

                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 14px;">점수 분석</h3>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span style="color: var(--accent-green);">매수 ${coin.buyScore || 0}점</span>
                            <span style="color: var(--text-muted);">총점 ${coin.totalScore || 0}점</span>
                            <span style="color: var(--accent-red);">매도 ${coin.sellScore || 0}점</span>
                        </div>
                        <div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--bg-primary);">
                            <div style="width: ${coin.buyScore || 0}%; background: var(--accent-green);"></div>
                            <div style="flex: 1; background: var(--text-muted); opacity: 0.2;"></div>
                            <div style="width: ${coin.sellScore || 0}%; background: var(--accent-red);"></div>
                        </div>
                    </div>

                    ${coin.signals && coin.signals.length > 0 ? `
                    <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 style="margin: 0 0 12px 0; font-size: 14px;">감지된 신호</h3>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            ${coin.signals.map(s => `<span style="padding: 4px 10px; border-radius: 4px; font-size: 12px; background: var(--bg-secondary); color: var(--text-secondary);">${s}</span>`).join('')}
                        </div>
                    </div>
                    ` : ''}

                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-success" style="flex: 1;" onclick="openAcceptModal('${coin.coin}', 'BUY', ${coin.currentPrice}, 50000); closeCoinDetailModal();">
                            매수하기
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" onclick="selectCoin('${coin.coin}'); switchToTab('market'); closeCoinDetailModal();">
                            차트 보기
                        </button>
                    </div>
                </div>
            `;

            // 모달 생성
            let modal = document.getElementById('coinDetailModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'coinDetailModal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';
                modal.onclick = (e) => { if (e.target === modal) closeCoinDetailModal(); };
                document.body.appendChild(modal);
            }

            modal.innerHTML = `
                <div style="background: var(--bg-primary); border-radius: 12px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative;">
                    <button onclick="closeCoinDetailModal()" style="position: absolute; top: 12px; right: 12px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px;">&times;</button>
                    ${content}
                </div>
            `;
            modal.style.display = 'flex';
        }

        function closeCoinDetailModal() {
            const modal = document.getElementById('coinDetailModal');
            if (modal) modal.style.display = 'none';
        }

        // Parameter Settings
        async function loadParameterRanges() {
            const ranges = await fetchAPI('/parameter-ranges');
            const config = await fetchAPI('/optimal-config');

            if (!ranges) return;

            parameterRanges = ranges;
            currentParams = config?.parameters || {};

            const container = document.getElementById('parameterSettings');
            let html = '';

            for (const [key, range] of Object.entries(ranges)) {
                const currentValue = currentParams[key] ?? range.min;
                const isDecimal = range.step < 1;
                html += `
                    <div class="param-item">
                        <div class="param-header">
                            <span class="param-name">${range.label}</span>
                            <input type="number" class="param-input"
                                id="input-${key}"
                                min="${range.min}"
                                max="${range.max}"
                                step="${range.step}"
                                value="${currentValue}"
                                onchange="updateFromInput('${key}', this.value)"
                                style="width: 80px; text-align: right; background: var(--bg-tertiary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 4px 8px; border-radius: 4px; font-size: 14px;">
                        </div>
                        <input type="range" class="form-range"
                            id="param-${key}"
                            min="${range.min}"
                            max="${range.max}"
                            step="${range.step}"
                            value="${currentValue}"
                            oninput="updateFromSlider('${key}', this.value)">
                        <div class="param-range-info">
                            범위: ${range.min} ~ ${range.max} | ${range.description}
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Investment Presets
        let investmentPresets = [];
        let activePresetId = null;

        async function loadInvestmentPresets() {
            const data = await fetchAPI('/investment-presets');
            const container = document.getElementById('investmentPresets');

            if (!data?.presets) {
                container.innerHTML = '<div class="empty-state">프리셋을 불러올 수 없습니다</div>';
                return;
            }

            investmentPresets = data.presets;
            let html = '';

            for (const preset of investmentPresets) {
                const riskDots = [];
                for (let i = 1; i <= 5; i++) {
                    let riskClass = '';
                    if (i <= preset.riskLevel) {
                        if (preset.riskLevel <= 2) riskClass = 'filled low';
                        else if (preset.riskLevel <= 3) riskClass = 'filled medium';
                        else riskClass = 'filled high';
                    }
                    riskDots.push(`<div class="risk-dot ${riskClass}"></div>`);
                }

                html += `
                    <div class="preset-card ${activePresetId === preset.id ? 'active' : ''}"
                         onclick="applyPreset('${preset.id}')"
                         data-preset-id="${preset.id}">
                        <span class="preset-apply-badge">적용됨</span>
                        <div class="preset-header">
                            <span class="preset-icon">${preset.icon}</span>
                            <div class="preset-title">
                                <div class="preset-name">${preset.name}</div>
                                <div class="preset-name-en">${preset.nameEn}</div>
                            </div>
                        </div>
                        <div class="preset-description">${preset.description}</div>
                        <div class="preset-risk">
                            <span class="preset-risk-label">리스크 수준:</span>
                            <div class="risk-dots">${riskDots.join('')}</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        async function applyPreset(presetId) {
            const preset = investmentPresets.find(p => p.id === presetId);
            if (!preset) {
                showToast('프리셋을 찾을 수 없습니다', 'error');
                return;
            }

            // API로 프리셋 적용
            const result = await fetchAPI('/investment-presets/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ presetId, config: preset.config })
            });

            if (result?.success) {
                activePresetId = presetId;

                // 파라미터 UI 업데이트
                for (const [key, value] of Object.entries(preset.config)) {
                    const input = document.getElementById(`input-${key}`);
                    const slider = document.getElementById(`param-${key}`);
                    if (input) input.value = value;
                    if (slider) slider.value = value;
                    currentParams[key] = value;
                }

                // 프리셋 카드 UI 업데이트
                document.querySelectorAll('.preset-card').forEach(card => {
                    if (card.dataset.presetId === presetId) {
                        card.classList.add('active');
                    } else {
                        card.classList.remove('active');
                    }
                });

                showToast(`'${preset.name}' 프리셋이 적용되었습니다`, 'success');
            } else {
                showToast('프리셋 적용 실패: ' + (result?.error || '알 수 없는 오류'), 'error');
            }
        }

        function updateFromSlider(key, value) {
            const range = parameterRanges[key];
            const numValue = range?.step < 1 ? parseFloat(value) : parseInt(value);
            document.getElementById(`input-${key}`).value = numValue;
            currentParams[key] = numValue;
        }

        function updateFromInput(key, value) {
            const range = parameterRanges[key];
            let numValue = range?.step < 1 ? parseFloat(value) : parseInt(value);
            // 범위 체크
            if (range) {
                numValue = Math.max(range.min, Math.min(range.max, numValue));
            }
            document.getElementById(`input-${key}`).value = numValue;
            document.getElementById(`param-${key}`).value = numValue;
            currentParams[key] = numValue;
        }

        async function applyParameters() {
            const params = {};
            for (const key of Object.keys(parameterRanges)) {
                const input = document.getElementById(`input-${key}`);
                if (input) {
                    const range = parameterRanges[key];
                    params[key] = range?.step < 1 ? parseFloat(input.value) : parseInt(input.value);
                }
            }

            const result = await fetchAPI('/config/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(params)
            });

            if (result?.success) {
                showToast('파라미터가 성공적으로 적용되었습니다', 'success');
            } else {
                showToast('파라미터 적용 실패: ' + (result?.error || '알 수 없는 오류'), 'error');
            }
        }

        // 서버에서 파라미터 다시 로드
        async function reloadParametersFromServer() {
            if (confirm('현재 변경 내용이 사라집니다. 서버에서 다시 로드하시겠습니까?')) {
                await loadParameterRanges();
                await loadOptimalParams();
                showToast('서버에서 파라미터를 다시 로드했습니다', 'success');
            }
        }

        // ========== Auto Optimization Settings ==========
        async function loadOptimizationSettings() {
            try {
                const settings = await fetchAPI('/optimization/settings');
                if (!settings) return;
                const toggle = document.getElementById('autoOptimizationToggle');
                if (toggle) toggle.checked = settings.enabled || false;
                const intervalSelect = document.getElementById('optimizationInterval');
                if (intervalSelect && settings.interval) intervalSelect.value = settings.interval.toString();
                updateOptimizationStatusUI(settings);
            } catch (error) {
                console.error('최적화 설정 로드 실패:', error);
            }
        }

        function updateOptimizationStatusUI(settings) {
            const statusEl = document.getElementById('optimizationStatus');
            const statusTextEl = document.getElementById('optimizationStatusText');
            const nextTimeEl = document.getElementById('nextOptimizationTime');
            if (!statusEl || !statusTextEl) return;
            if (!settings) {
                statusEl.classList.remove('running');
                statusEl.classList.add('stopped');
                statusTextEl.textContent = '상태 알 수 없음';
                if (nextTimeEl) nextTimeEl.textContent = '-';
                return;
            }
            if (settings.enabled) {
                statusEl.classList.remove('stopped');
                statusEl.classList.add('running');
                statusTextEl.textContent = settings.isRunning ? '실행 중...' : '활성화됨';
            } else {
                statusEl.classList.remove('running');
                statusEl.classList.add('stopped');
                statusTextEl.textContent = '비활성화됨';
            }
            if (nextTimeEl) {
                if (settings.enabled && settings.nextRun) {
                    nextTimeEl.textContent = new Date(settings.nextRun).toLocaleString('ko-KR');
                } else if (settings.enabled && settings.isRunning) {
                    nextTimeEl.textContent = '현재 실행 중...';
                } else {
                    nextTimeEl.textContent = '-';
                }
            }
        }

        async function toggleAutoOptimization() {
            const toggle = document.getElementById('autoOptimizationToggle');
            const enabled = toggle.checked;
            try {
                toggle.disabled = true;
                const result = await fetchAPI('/optimization/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                if (result?.success) {
                    showToast(enabled ? '자동 최적화가 활성화되었습니다' : '자동 최적화가 비활성화되었습니다', 'success');
                    updateOptimizationStatusUI(result);
                } else {
                    throw new Error(result?.error || '설정 변경 실패');
                }
            } catch (error) {
                console.error('자동 최적화 토글 실패:', error);
                showToast('설정 변경 실패: ' + error.message, 'error');
                toggle.checked = !enabled;
            } finally {
                toggle.disabled = false;
            }
        }

        async function updateOptimizationInterval() {
            const intervalSelect = document.getElementById('optimizationInterval');
            const interval = parseInt(intervalSelect.value);
            try {
                const result = await fetchAPI('/optimization/interval', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interval })
                });
                if (result?.success) {
                    const hours = interval / 3600000;
                    showToast('최적화 주기가 ' + hours + '시간으로 변경되었습니다', 'success');
                    updateOptimizationStatusUI(result);
                } else {
                    throw new Error(result?.error || '주기 변경 실패');
                }
            } catch (error) {
                console.error('최적화 주기 변경 실패:', error);
                showToast('주기 변경 실패: ' + error.message, 'error');
            }
        }

        async function runOptimizationNow() {
            const btn = document.getElementById('runOptimizationNow');
            if (!confirm('지금 바로 최적화를 실행하시겠습니까? 완료까지 몇 분이 소요될 수 있습니다.')) {
                return;
            }
            try {
                btn.disabled = true;
                btn.textContent = '실행 중...';
                showToast('최적화를 시작합니다...', 'info');
                const result = await fetchAPI('/optimization/run-now', { method: 'POST' });
                if (result?.success) {
                    showToast('최적화가 시작되었습니다. 완료 시 알림이 표시됩니다.', 'success');
                    // 최적화 상태를 별도로 로드
                    const settings = await fetchAPI('/optimization/settings');
                    updateOptimizationStatusUI(settings);
                } else {
                    throw new Error(result?.error || '최적화 실행 실패');
                }
            } catch (error) {
                console.error('최적화 즉시 실행 실패:', error);
                showToast('최적화 실행 실패: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = '지금 실행';
            }
        }


        // Optimal Params Display
        async function loadOptimalParams() {
            const config = await fetchAPI('/optimal-config');
            const container = document.getElementById('optimalParams');

            if (!config?.parameters) {
                container.innerHTML = '<div class="empty-state">최적화 파라미터가 아직 생성되지 않았습니다</div>';
                return;
            }

            const updatedAt = config.updatedAt ? new Date(config.updatedAt).toLocaleString('ko-KR') : '-';
            const params = config.parameters;

            let html = `
                <div style="margin-bottom: 15px; color: var(--text-secondary); font-size: 13px;">
                    마지막 업데이트: <strong>${updatedAt}</strong>
                    ${config.cycle ? ` | 사이클: <strong>#${config.cycle}</strong>` : ''}
                </div>
                <div class="param-grid">
            `;

            for (const [key, value] of Object.entries(params)) {
                const label = parameterRanges[key]?.label || key;
                html += `
                    <div class="param-item">
                        <div class="param-header">
                            <span class="param-name">${label}</span>
                            <span class="param-value-display">${value}</span>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            container.innerHTML = html;
        }

        // Optimization History
        async function loadOptimizationHistory() {
            const history = await fetchAPI('/optimization-history');
            const container = document.getElementById('optimizationHistory');

            if (!history || history.length === 0) {
                container.innerHTML = '<div class="empty-state">최적화 이력이 없습니다</div>';
                return;
            }

            let html = '<div class="table-container"><table><thead><tr><th>사이클</th><th>날짜</th><th>예상 수익률</th><th>주요 파라미터</th></tr></thead><tbody>';

            history.forEach((item, index) => {
                // timestamp 또는 updatedAt 사용
                const dateStr = item.timestamp || item.updatedAt;
                const date = dateStr ? new Date(dateStr).toLocaleString('ko-KR') : '-';
                // fitness 또는 expectedReturn 사용 (중첩 구조 대응)
                const fitness = item.fitness ?? item.expectedReturn ?? item.parameters?.fitness ?? item.parameters?.expectedReturn ?? '-';
                const fitnessClass = parseFloat(fitness) >= 0 ? 'positive' : 'negative';
                // parameters 중첩 구조 대응: params.parameters가 있으면 그것을 사용
                const rawParams = item.parameters || {};
                const params = rawParams.parameters || rawParams;
                // 사이클 번호: 역순으로 최신이 가장 큰 번호 (history는 이미 reverse된 상태)
                const cycleNum = history.length - index;

                html += `
                    <tr>
                        <td><span class="history-cycle">#${cycleNum}</span></td>
                        <td style="font-size: 12px; color: var(--text-muted);">${date}</td>
                        <td class="stat-value ${fitnessClass}">${typeof fitness === 'number' ? formatPercent(fitness) + '%' : fitness}</td>
                        <td style="font-size: 12px;">
                            RSI: ${params.rsiPeriod ?? '-'} |
                            손절: ${params.stopLossPercent ?? '-'}% |
                            익절: ${params.takeProfitPercent ?? '-'}%
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        // Backtest Results
        async function loadBacktestResults() {
            const container = document.getElementById('backtestResults');
            // 동적 코인 목록 사용 (targetCoins가 비어있으면 기본값)
            const coins = targetCoins.length > 0
                ? targetCoins
                : ['KRW-BTC', 'KRW-ETH', 'KRW-XRP'];

            let html = '<table><thead><tr><th>코인</th><th>수익률</th><th>승률</th><th>거래횟수</th><th>최대낙폭</th><th>샤프비율</th></tr></thead><tbody>';
            let hasResults = false;

            for (const coin of coins) {
                try {
                    // API 엔드포인트 사용 (404 에러 방지)
                    const result = await fetchAPI(`/backtest/results/${coin}`);
                    if (!result || result.exists === false) continue; // 결과 없으면 무시

                    hasResults = true;

                    const returnClass = result.totalReturnPercent >= 0 ? 'positive' : 'negative';
                    const badgeClass = result.totalReturnPercent >= 0 ? 'badge-buy' : 'badge-sell';

                    html += `
                        <tr>
                            <td style="font-weight: 600;">${coin}</td>
                            <td class="stat-value ${returnClass}">
                                <span class="badge ${badgeClass}">
                                    ${result.totalReturnPercent >= 0 ? '+' : ''}${formatPercent(result.totalReturnPercent)}%
                                </span>
                            </td>
                            <td>${formatPercent(result.winRate)}%</td>
                            <td>${result.totalTrades}회</td>
                            <td>${formatPercent(result.maxDrawdown)}%</td>
                            <td>${formatPercent(result.sharpeRatio)}</td>
                        </tr>
                    `;
                } catch (error) {
                    // 파일이 없거나 파싱 에러는 조용히 무시
                }
            }

            html += '</tbody></table>';

            if (!hasResults) {
                container.innerHTML = '<div class="empty-state">백테스팅 결과가 없습니다. 시스템이 실행되면 자동으로 생성됩니다.</div>';
            } else {
                container.innerHTML = html;
            }
        }

        // Accept Modal (추천 수락용)
        let acceptModalData = {};

        function openAcceptModal(coin, action, currentPrice, suggestedAmount = 50000) {
            acceptModalData = { coin, action, currentPrice, suggestedAmount };

            document.getElementById('acceptCoin').textContent = coin;
            document.getElementById('acceptCurrentPrice').textContent = formatNumber(currentPrice) + '원';
            document.getElementById('acceptModalTitle').textContent = action === 'BUY' ? '매수 추천 수락' : '매도 추천 수락';

            // 매수 시 금액 옵션 표시, 매도 시 숨기기
            document.getElementById('acceptAmountGroup').style.display = action === 'BUY' ? 'block' : 'none';

            if (action === 'BUY') {
                document.getElementById('acceptAmount').value = suggestedAmount;
            }

            const confirmBtn = document.getElementById('acceptConfirmBtn');
            confirmBtn.className = action === 'BUY' ? 'btn btn-success' : 'btn btn-danger';
            confirmBtn.textContent = action === 'BUY' ? '매수 실행' : '매도 실행';

            // 금액 옵션 버튼 이벤트
            document.querySelectorAll('.amount-option').forEach(btn => {
                btn.onclick = () => {
                    const multiplier = parseFloat(btn.dataset.multiplier);
                    document.getElementById('acceptAmount').value = Math.floor(suggestedAmount * multiplier);
                    // 선택된 버튼 하이라이트
                    document.querySelectorAll('.amount-option').forEach(b => b.classList.remove('btn-primary'));
                    document.querySelectorAll('.amount-option').forEach(b => b.classList.add('btn-secondary'));
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-primary');
                };
            });

            document.getElementById('acceptModal').classList.add('active');
        }

        function closeAcceptModal() {
            document.getElementById('acceptModal').classList.remove('active');
        }

        async function executeAccept() {
            const { coin, action } = acceptModalData;
            const amount = action === 'BUY' ? parseInt(document.getElementById('acceptAmount').value) : null;

            const result = await fetchAPI('/trade/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ coin, action, amount })
            });

            if (result?.success) {
                showToast(result.message, 'success');
                closeAcceptModal();
                loadCoinAnalysis();
                loadPortfolioSummary();
                loadPositions();
                loadAccountInfo();
            } else {
                showToast('거래 실패: ' + (result?.error || '알 수 없는 오류'), 'error');
            }
        }

        // Trade Modal (수동 거래용)
        let tradeModalData = {};

        function openTradeModal(coin, action, currentPrice, suggestedAmount = 50000) {
            tradeModalData = { coin, action, currentPrice };

            document.getElementById('tradeCoin').value = coin;
            document.getElementById('tradeCurrentPrice').value = formatNumber(currentPrice) + '원';
            document.getElementById('tradeAction').value = action === 'BUY' ? '매수' : '매도';
            document.getElementById('tradeModalTitle').textContent = `${coin} ${action === 'BUY' ? '매수' : '매도'}`;

            // 추천 금액으로 기본값 설정
            if (action === 'BUY' && suggestedAmount > 0) {
                document.getElementById('tradeAmount').value = suggestedAmount;
            }

            const confirmBtn = document.getElementById('tradeConfirmBtn');
            confirmBtn.className = action === 'BUY' ? 'btn btn-success' : 'btn btn-danger';
            confirmBtn.textContent = action === 'BUY' ? '매수 실행' : '매도 실행';

            // 매도 시 금액 입력 숨기기
            document.getElementById('tradeAmountGroup').style.display = action === 'BUY' ? 'block' : 'none';

            document.getElementById('tradeModal').classList.add('active');
        }

        function closeTradeModal() {
            document.getElementById('tradeModal').classList.remove('active');
        }

        async function executeTrade() {
            const { coin, action } = tradeModalData;
            const amount = action === 'BUY' ? parseInt(document.getElementById('tradeAmount').value) : null;

            const result = await fetchAPI('/trade/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ coin, action, amount })
            });

            if (result?.success) {
                showToast(result.message, 'success');
                closeTradeModal();
                loadCoinAnalysis();
                loadPortfolioSummary();
                loadPositions();
            } else {
                showToast('거래 실패: ' + (result?.error || '알 수 없는 오류'), 'error');
            }
        }

        // Update Time
        function updateLastUpdateTime() {
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString('ko-KR');
        }

        // 순차 API 호출용 유틸리티 (에러 발생해도 다음 호출 계속)
        async function safeLoad(fn, delay = 100) {
            try {
                await fn();
            } catch (e) {
                console.warn(`${fn.name || 'Unknown'} 로드 실패:`, e.message);
            }
            if (delay > 0) {
                await new Promise(r => setTimeout(r, delay));
            }
        }

        // 현재 로딩 중인지 추적 (중복 호출 방지)
        let isLoadingAllData = false;

        // Load All Data - 순차 호출로 rate limit 방지
        async function loadAllData() {
            // 이미 로딩 중이면 스킵
            if (isLoadingAllData) return;
            isLoadingAllData = true;

            try {
                // 핵심 데이터 순차 로드 (각 호출 사이 100ms 딜레이)
                await safeLoad(loadSystemStatus);
                await safeLoad(loadOverviewStats);
                await safeLoad(loadAccountInfo);
                await safeLoad(loadTradeStats);
                await safeLoad(loadPositions);
                await safeLoad(loadRecentTrades);

                // 부가 데이터 (병렬 가능)
                await Promise.all([
                    safeLoad(loadMarketOverview, 0),
                    safeLoad(loadPortfolioHistory, 0),
                    safeLoad(loadDetailedSystemStatus, 0),
                    safeLoad(loadTodaySummary, 0),
                    safeLoad(loadPortfolioAnalysis, 0),
                    safeLoad(loadManualPositions, 0)
                ]);

                // Save portfolio snapshot
                savePortfolioSnapshot();

                // 현재 탭에 따라 추가 데이터 로드
                const currentTab = localStorage.getItem('currentTab');
                const now = Date.now();
                if (currentTab === 'market') {
                    // 마켓 탭: 가격만 업데이트 (차트는 별도 인터벌)
                    await safeLoad(loadMarketPrices, 0);
                } else if (currentTab === 'analysis') {
                    // 코인 분석은 1분마다만 갱신
                    if (now - lastCoinAnalysisTime >= COIN_ANALYSIS_INTERVAL) {
                        await safeLoad(loadCoinAnalysis, 0);
                        lastCoinAnalysisTime = now;
                    }
                } else if (currentTab === 'trading') {
                    await safeLoad(loadBuyRecommendations, 0);
                    await safeLoad(loadSellRecommendations, 0);
                    await safeLoad(loadManualPositions, 0);
                    await safeLoad(updateBuyPresetInfo, 0);
                    await safeLoad(updateSellPresetInfo, 0);
                }
                // parameters 탭은 자동 새로고침 안함 (사용자 변경 내용 보존)
                else if (currentTab === 'history') {
                    await safeLoad(loadOptimizationHistory, 0);
                    await safeLoad(loadBacktestResults, 0);
                }

                updateLastUpdateTime();
            } catch (error) {
                console.error('데이터 로드 오류:', error);
            } finally {
                isLoadingAllData = false;
            }
        }

        // Market Prices (실시간 업데이트, 로딩 없이)
        let pricesLoading = false;
        let marketPricesData = []; // 데이터 저장용
        let currentMarketViewMode = localStorage.getItem('marketViewMode') || 'grid';
        let selectedCoin = localStorage.getItem('selectedCoin') || 'KRW-BTC';

        // 뷰 모드 설정
        function setMarketViewMode(mode) {
            currentMarketViewMode = mode;
            localStorage.setItem('marketViewMode', mode);

            // 버튼 활성화 상태 업데이트
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });

            // 뷰 다시 렌더링
            renderMarketPrices();
        }

        // Quick Trade 모달 상태 (레거시 호환용)
        let quickTradeData = null;
        let quickTradeOpen = false;

        // 인라인 트레이드 패널 상태
        let inlineTradeData = null;

        // 코인 선택 (인라인 트레이드 패널 열기)
        function selectCoin(coin, event) {
            selectedCoin = coin;
            localStorage.setItem('selectedCoin', coin);

            // 차트 드롭다운 업데이트
            const chartSelect = document.getElementById('chartCoin');
            if (chartSelect) {
                chartSelect.value = coin;
            }

            // 차트 로드
            loadChart();

            // 선택 상태 업데이트
            renderMarketPrices();

            // 인라인 트레이드 패널 열기 (모달 대신)
            updateInlineTradePanel(coin);
        }

        // 인라인 트레이드 패널 업데이트
        async function updateInlineTradePanel(coin) {
            const panel = document.getElementById('inlineTradePanel');

            // 코인 데이터 찾기
            const coinData = marketPricesData.find(c => c.coin === coin);
            if (!coinData) {
                panel.style.display = 'none';
                return;
            }

            inlineTradeData = { coin, ...coinData };

            // 패널 내용 업데이트
            const symbol = coin.replace('KRW-', '');
            const changeClass = coinData.change >= 0 ? 'positive' : 'negative';
            const changeSign = coinData.change >= 0 ? '+' : '';

            document.getElementById('inlineTradeCoin').textContent = symbol;
            document.getElementById('inlineTradeChange').textContent = `${changeSign}${coinData.change.toFixed(2)}%`;
            document.getElementById('inlineTradeChange').className = changeClass;
            document.getElementById('inlineTradePrice').textContent = formatNumber(coinData.price) + '원';
            document.getElementById('inlineTradePriceSub').textContent = `24시간 변동: ${changeSign}${formatNumber(coinData.changePrice || 0)}원`;
            document.getElementById('inlineTradeHigh').textContent = formatNumber(coinData.high) + '원';
            document.getElementById('inlineTradeLow').textContent = formatNumber(coinData.low) + '원';
            document.getElementById('inlineTradeVolume').textContent = (coinData.volumeKrw / 100000000).toFixed(1) + '억';

            // 보유 정보 확인
            let holdingQuantity = 0;
            let holdingValue = 0;
            let avgPrice = 0;
            try {
                const positions = await fetchAPI('/positions');
                if (positions?.positions) {
                    const pos = positions.positions.find(p => p.coin === coin);
                    if (pos) {
                        holdingQuantity = pos.quantity || 0;
                        avgPrice = pos.avgPrice || 0;
                        holdingValue = holdingQuantity * coinData.price;
                    }
                }
            } catch (e) {
                console.warn('보유 정보 조회 실패:', e);
            }

            inlineTradeData.holdingQuantity = holdingQuantity;
            inlineTradeData.avgPrice = avgPrice;

            document.getElementById('inlineTradeHolding').textContent = holdingQuantity > 0
                ? holdingQuantity.toFixed(8).replace(/\.?0+$/, '')
                : '-';

            // 보유 정보 상세
            const holdingInfoEl = document.getElementById('inlineTradeHoldingInfo');
            if (holdingQuantity > 0) {
                holdingInfoEl.style.display = 'block';
                document.getElementById('inlineTradeHoldingValue').textContent = formatNumber(Math.floor(holdingValue)) + '원';
                document.getElementById('inlineTradeAvgPrice').textContent = formatNumber(avgPrice) + '원';

                const pnl = holdingValue - (holdingQuantity * avgPrice);
                const pnlPercent = avgPrice > 0 ? ((coinData.price / avgPrice) - 1) * 100 : 0;
                const pnlClass = pnl >= 0 ? 'positive' : 'negative';
                const pnlSign = pnl >= 0 ? '+' : '';
                document.getElementById('inlineTradePnL').textContent = `${pnlSign}${formatNumber(Math.floor(pnl))}원 (${pnlSign}${pnlPercent.toFixed(2)}%)`;
                document.getElementById('inlineTradePnL').className = pnlClass;
            } else {
                holdingInfoEl.style.display = 'none';
            }

            // 매도 버튼 활성화 상태
            document.getElementById('inlineTradeSellBtn').disabled = holdingQuantity <= 0;

            // 예상 수량 업데이트
            updateInlineTradeEstQty();

            // 패널 표시
            panel.style.display = 'block';
        }

        // 예상 수량 업데이트
        function updateInlineTradeEstQty() {
            if (!inlineTradeData) return;
            const amount = parseInt(document.getElementById('inlineTradeAmount').value) || 0;
            const qty = amount / inlineTradeData.price;
            document.getElementById('inlineTradeEstQty').textContent = qty.toFixed(8);
        }

        // 금액 설정
        function setInlineTradeAmount(amount) {
            document.getElementById('inlineTradeAmount').value = amount;
            updateInlineTradeEstQty();
        }

        // 퍼센트로 금액 설정 (보유잔액 기준)
        async function setInlineTradeAmountPercent(percent) {
            try {
                const account = await fetchAPI('/account');
                const krwBalance = account?.krwBalance || 0;
                const amount = Math.floor(krwBalance * (percent / 100));
                document.getElementById('inlineTradeAmount').value = amount;
                updateInlineTradeEstQty();
            } catch (e) {
                showToast('잔액 조회 실패', 'error');
            }
        }

        // 인라인 트레이드 실행
        async function executeInlineTrade(action) {
            if (!inlineTradeData) return;

            const coin = inlineTradeData.coin;
            const amount = parseInt(document.getElementById('inlineTradeAmount').value);

            if (action === 'BUY' && (!amount || amount < 5000)) {
                showToast('최소 매수 금액은 5,000원입니다', 'error');
                return;
            }

            const btn = document.getElementById(action === 'BUY' ? 'inlineTradeBuyBtn' : 'inlineTradeSellBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '처리중...';

            try {
                const result = await fetchAPI('/trade/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        coin,
                        action,
                        amount: action === 'BUY' ? amount : null
                    })
                });

                if (result.success) {
                    showToast(result.message || `${action === 'BUY' ? '매수' : '매도'} 완료`, 'success');
                    // 패널 업데이트
                    setTimeout(() => updateInlineTradePanel(coin), 500);
                } else {
                    showToast(result.error || '거래 실패', 'error');
                }
            } catch (error) {
                showToast(error.message || '거래 실패', 'error');
            } finally {
                btn.disabled = action === 'SELL' && inlineTradeData.holdingQuantity <= 0;
                btn.textContent = originalText;
            }
        }

        // Quick Trade 모달 열기 (레거시 - 다른 곳에서 호출될 경우)
        async function openQuickTrade(coin, x, y) {
            quickTradeOpen = true;

            // 코인 데이터 찾기
            const coinData = marketPricesData.find(c => c.coin === coin);
            if (!coinData) {
                showToast('코인 정보를 찾을 수 없습니다', 'error');
                return;
            }

            quickTradeData = { coin, ...coinData };

            // 모달 내용 업데이트
            const symbol = coin.replace('KRW-', '');
            const changeClass = coinData.change >= 0 ? 'positive' : 'negative';
            const changeSign = coinData.change >= 0 ? '+' : '';

            document.getElementById('quickTradeSymbol').textContent = symbol;
            document.getElementById('quickTradeChange').textContent = `${changeSign}${coinData.change.toFixed(2)}%`;
            document.getElementById('quickTradeChange').className = `quick-trade-change ${changeClass}`;
            document.getElementById('quickTradePrice').textContent = formatNumber(coinData.price) + '원';
            document.getElementById('quickTradePriceSub').textContent = `24시간 변동: ${changeSign}${formatNumber(coinData.changePrice)}원`;
            document.getElementById('quickTradeHigh').textContent = formatNumber(coinData.high) + '원';
            document.getElementById('quickTradeLow').textContent = formatNumber(coinData.low) + '원';
            document.getElementById('quickTradeVolume').textContent = (coinData.volumeKrw / 100000000).toFixed(1) + '억';

            // 보유 정보 확인
            let holdingQuantity = 0;
            let holdingValue = 0;
            try {
                const positions = await fetchAPI('/positions');
                if (positions?.positions) {
                    const pos = positions.positions.find(p => p.coin === coin);
                    if (pos) {
                        holdingQuantity = pos.quantity || 0;
                        holdingValue = holdingQuantity * coinData.price;
                    }
                }
            } catch (e) {
                console.warn('보유 정보 조회 실패:', e);
            }

            document.getElementById('quickTradeHolding').textContent = holdingQuantity > 0
                ? holdingQuantity.toFixed(8).replace(/\.?0+$/, '')
                : '-';
            document.getElementById('quickTradeHoldingValue').textContent = holdingQuantity > 0
                ? `보유평가: ${formatNumber(Math.floor(holdingValue))}원`
                : '보유평가: -';

            // 매도 버튼 활성화 상태
            const sellBtn = document.getElementById('quickTradeSellBtn');
            sellBtn.disabled = holdingQuantity <= 0;

            // 모달 위치 계산
            const modal = document.getElementById('quickTradeModal');
            const modalWidth = 360;
            const modalHeight = 500;

            let posX = x - modalWidth / 2;
            let posY = y + 20;

            // 화면 경계 체크
            if (posX < 10) posX = 10;
            if (posX + modalWidth > window.innerWidth - 10) posX = window.innerWidth - modalWidth - 10;
            if (posY + modalHeight > window.innerHeight - 10) {
                posY = y - modalHeight - 20;
            }
            if (posY < 10) posY = 10;

            modal.style.left = posX + 'px';
            modal.style.top = posY + 'px';

            // 모달 표시
            document.getElementById('quickTradeOverlay').style.display = 'block';
            modal.style.display = 'block';
        }

        // Quick Trade 모달 닫기
        function closeQuickTrade() {
            quickTradeOpen = false;
            quickTradeData = null;
            document.getElementById('quickTradeOverlay').style.display = 'none';
            document.getElementById('quickTradeModal').style.display = 'none';
        }

        // Quick Trade 금액 설정
        function setQuickTradeAmount(amount) {
            document.getElementById('quickTradeAmountInput').value = amount;
        }

        // Quick Trade 실행
        async function executeQuickTrade(action) {
            if (!quickTradeData) return;

            const coin = quickTradeData.coin;
            const amount = action === 'BUY' ? parseInt(document.getElementById('quickTradeAmountInput').value) : null;

            const btn = document.getElementById(action === 'BUY' ? 'quickTradeBuyBtn' : 'quickTradeSellBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = '처리중...';

            try {
                const result = await fetchAPI('/trade/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ coin, action, amount })
                });

                if (result?.success) {
                    showToast(result.message, 'success');
                    closeQuickTrade();
                    // 데이터 새로고침
                    loadMarketPrices();
                    loadPositions();
                    loadAccountInfo();
                } else {
                    showToast('거래 실패: ' + (result?.error || '알 수 없는 오류'), 'error');
                }
            } catch (e) {
                showToast('거래 오류: ' + e.message, 'error');
            } finally {
                btn.disabled = action === 'SELL' && (quickTradeData?.holdingQuantity || 0) <= 0;
                btn.textContent = originalText;
            }
        }

        // Quick Trade에서 차트 보기
        function viewQuickTradeChart() {
            if (!quickTradeData) return;

            const coin = quickTradeData.coin;
            closeQuickTrade();

            // 차트 로드
            const chartSelect = document.getElementById('chartCoin');
            if (chartSelect) {
                chartSelect.value = coin;
            }
            loadChart();

            // 차트로 스크롤
            document.getElementById('priceChart')?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // 마켓 데이터 정렬
        function sortMarketPrices() {
            const sortType = document.getElementById('marketSort')?.value || 'volume';

            switch (sortType) {
                case 'volume':
                    marketPricesData.sort((a, b) => b.volumeKrw - a.volumeKrw);
                    break;
                case 'change_desc':
                    marketPricesData.sort((a, b) => b.change - a.change);
                    break;
                case 'change_asc':
                    marketPricesData.sort((a, b) => a.change - b.change);
                    break;
                case 'name':
                    marketPricesData.sort((a, b) => a.coin.localeCompare(b.coin));
                    break;
            }

            renderMarketPrices();
        }

        // 마켓 가격 렌더링 (뷰 모드별)
        function renderMarketPrices() {
            // Quick Trade 모달이 열려있으면 렌더링 스킵 (클릭 이벤트 방해 방지)
            if (quickTradeOpen) return;

            const container = document.getElementById('marketPrices');
            if (!marketPricesData || marketPricesData.length === 0) {
                container.innerHTML = '<div class="empty-state">시세를 불러올 수 없습니다</div>';
                return;
            }

            let html = '';

            if (currentMarketViewMode === 'grid') {
                html = renderGridView(marketPricesData);
            } else if (currentMarketViewMode === 'list') {
                html = renderListView(marketPricesData);
            } else if (currentMarketViewMode === 'compact') {
                html = renderCompactView(marketPricesData);
            }

            container.innerHTML = html;
        }

        // 마켓 아이템 클릭 이벤트 위임 설정
        function setupMarketClickDelegation() {
            const container = document.getElementById('marketPrices');
            if (!container) return;

            container.addEventListener('click', (e) => {
                // 가장 가까운 클릭 가능한 마켓 아이템 찾기
                const item = e.target.closest('.market-item, .market-list-item, .market-compact-item');
                if (!item) return;

                // 헤더 행은 제외
                if (item.style.cursor === 'default') return;

                const coin = item.dataset.coin;
                if (coin) {
                    e.preventDefault();
                    e.stopPropagation();
                    selectCoin(coin, e);
                }
            });
        }

        // Grid View 렌더링
        function renderGridView(data) {
            return `
                <div class="grid grid-3">
                    ${data.map(coin => {
                        const changeClass = coin.change >= 0 ? 'positive' : 'negative';
                        const changeSign = coin.change >= 0 ? '+' : '';
                        const isSelected = coin.coin === selectedCoin;
                        return `
                            <div class="market-item ${isSelected ? 'selected' : ''}"
                                 style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;"
                                 data-coin="${coin.coin}">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span style="font-weight: 600; font-size: 16px;">${coin.coin.replace('KRW-', '')}</span>
                                    <span class="market-change-value" data-change-for="${coin.coin}">${formatChange(coin.change)}</span>
                                </div>
                                <div class="market-price-value" data-price-for="${coin.coin}" data-prev-price="${coin.price}" style="font-size: 24px; font-weight: 700; margin-bottom: 12px;">
                                    ${formatNumber(coin.price)}원
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 12px; color: var(--text-secondary);">
                                    <div>
                                        <div style="color: var(--text-muted);">24h High</div>
                                        <div>${formatNumber(coin.high)}원</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">24h Low</div>
                                        <div>${formatNumber(coin.low)}원</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">변동</div>
                                        <div class="${changeClass}">${changeSign}${formatNumber(coin.changePrice)}원</div>
                                    </div>
                                    <div>
                                        <div style="color: var(--text-muted);">거래대금</div>
                                        <div>${(coin.volumeKrw / 100000000).toFixed(1)}억</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // List View 렌더링
        function renderListView(data) {
            return `
                <div class="market-list-view">
                    <div class="market-list-item" style="background: var(--bg-secondary); font-weight: 600; font-size: 12px; color: var(--text-secondary); cursor: default;">
                        <div>코인</div>
                        <div>현재가</div>
                        <div style="text-align: right;">변동률</div>
                        <div style="text-align: right;">24h High/Low</div>
                        <div style="text-align: right;">거래대금</div>
                    </div>
                    ${data.map(coin => {
                        const changeClass = coin.change >= 0 ? 'positive' : 'negative';
                        const changeSign = coin.change >= 0 ? '+' : '';
                        const isSelected = coin.coin === selectedCoin;
                        return `
                            <div class="market-list-item ${isSelected ? 'selected' : ''}" data-coin="${coin.coin}">
                                <div style="font-weight: 600;">${coin.coin.replace('KRW-', '')}</div>
                                <div class="market-price-value" data-price-for="${coin.coin}" data-prev-price="${coin.price}" style="font-size: 16px; font-weight: 600;">${formatNumber(coin.price)}원</div>
                                <div style="text-align: right;">
                                    <span class="market-change-value ${changeClass}" data-change-for="${coin.coin}" style="font-weight: 600;">${changeSign}${coin.change.toFixed(2)}%</span>
                                </div>
                                <div style="text-align: right; font-size: 12px; color: var(--text-secondary);">
                                    ${formatNumber(coin.high)} / ${formatNumber(coin.low)}
                                </div>
                                <div style="text-align: right; font-size: 12px; color: var(--text-secondary);">
                                    ${(coin.volumeKrw / 100000000).toFixed(1)}억
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Compact View 렌더링
        function renderCompactView(data) {
            return `
                <div class="market-compact-view">
                    ${data.map(coin => {
                        const changeClass = coin.change >= 0 ? 'positive' : 'negative';
                        const changeSign = coin.change >= 0 ? '+' : '';
                        const isSelected = coin.coin === selectedCoin;
                        return `
                            <div class="market-compact-item ${isSelected ? 'selected' : ''}" data-coin="${coin.coin}">
                                <div>
                                    <div style="font-weight: 600; font-size: 14px;">${coin.coin.replace('KRW-', '')}</div>
                                    <div class="market-price-value" data-price-for="${coin.coin}" data-prev-price="${coin.price}" style="font-size: 12px; color: var(--text-secondary);">${formatNumber(coin.price)}원</div>
                                </div>
                                <div class="market-change-value ${changeClass}" data-change-for="${coin.coin}" style="font-weight: 600; font-size: 14px;">
                                    ${changeSign}${coin.change.toFixed(2)}%
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // 마켓 가격만 롤링 애니메이션과 함께 업데이트 (DOM 재렌더링 없이)
        function updateMarketPricesWithAnimation(newData) {
            if (!newData || newData.length === 0) return false;

            const container = document.getElementById('marketPrices');
            if (!container) return false;

            // 기존 요소가 없으면 전체 렌더링 필요
            const existingPriceEl = container.querySelector('[data-price-for]');
            if (!existingPriceEl) return false;

            let hasUpdates = false;

            newData.forEach(coin => {
                // 가격 요소 찾기
                const priceEl = container.querySelector(`[data-price-for="${coin.coin}"]`);
                if (priceEl) {
                    const prevPrice = parseFloat(priceEl.dataset.prevPrice) || 0;
                    const newPrice = coin.price;

                    // 가격이 변경되었을 때만 애니메이션
                    if (Math.abs(prevPrice - newPrice) > 0.01) {
                        hasUpdates = true;

                        // 플래시 효과 (배경색)
                        priceEl.classList.remove('price-flash-up', 'price-flash-down');
                        void priceEl.offsetWidth; // reflow 강제
                        if (newPrice > prevPrice) {
                            priceEl.classList.add('price-flash-up');
                        } else {
                            priceEl.classList.add('price-flash-down');
                        }

                        // 숫자 롤링 애니메이션
                        animateNumber(priceEl, newPrice, {
                            suffix: '원',
                            duration: 600,
                            easing: 'easeOutExpo'
                        });

                        // 이전 가격 업데이트
                        priceEl.dataset.prevPrice = newPrice;
                    }
                }

                // 변동률 요소 찾기 및 업데이트
                const changeEl = container.querySelector(`[data-change-for="${coin.coin}"]`);
                if (changeEl) {
                    const changeClass = coin.change >= 0 ? 'positive' : 'negative';
                    const changeSign = coin.change >= 0 ? '+' : '';

                    // Grid View는 formatChange 사용, 나머지는 직접 표시
                    if (currentMarketViewMode === 'grid') {
                        changeEl.innerHTML = formatChange(coin.change);
                    } else {
                        changeEl.className = `market-change-value ${changeClass}`;
                        changeEl.textContent = `${changeSign}${coin.change.toFixed(2)}%`;
                    }
                }
            });

            return hasUpdates;
        }

        // 마켓 데이터를 저장하여 비교용으로 사용
        let previousMarketData = null;

        async function loadMarketPrices() {
            if (pricesLoading) return; // 중복 호출 방지

            const container = document.getElementById('marketPrices');

            // 최초 로드 시에만 로딩 표시
            const isFirstLoad = container.innerHTML.includes('Loading') || container.innerHTML.includes('로딩') || !container.querySelector('[data-price-for]');

            pricesLoading = true;
            const data = await fetchAPI('/market/prices');
            pricesLoading = false;

            if (!data || data.error) {
                if (isFirstLoad) {
                    container.innerHTML = '<div class="empty-state">시세를 불러올 수 없습니다</div>';
                }
                return;
            }

            // 이전 데이터 정렬 순서 (정렬 변경 감지용)
            const getSortedOrder = (items) => {
                if (!items || items.length === 0) return '';
                return [...items].sort((a, b) => {
                    const aVal = marketPriceSortKey === 'name' ? a.coin :
                                marketPriceSortKey === 'price' ? a.price : a.change;
                    const bVal = marketPriceSortKey === 'name' ? b.coin :
                                marketPriceSortKey === 'price' ? b.price : b.change;
                    if (marketPriceSortDir === 'asc') return aVal > bVal ? 1 : -1;
                    return aVal < bVal ? 1 : -1;
                }).map(c => c.coin).join(',');
            };

            const prevSortedOrder = getSortedOrder(marketPricesData);
            marketPricesData = data;

            if (isFirstLoad) {
                // 최초 로드: 전체 렌더링
                sortMarketPrices();
            } else {
                const newSortedOrder = getSortedOrder(data);

                // 정렬 순서가 변경되었거나 롤링 애니메이션 업데이트 실패 시 전체 렌더링
                if (prevSortedOrder !== newSortedOrder || !updateMarketPricesWithAnimation(data)) {
                    sortMarketPrices();
                }
            }
        }

        // Load Target Coins (동적 코인 목록)
        let targetCoins = [];

        async function loadTargetCoins() {
            const data = await fetchAPI('/target-coins');
            if (data?.coins && data.coins.length > 0) {
                targetCoins = data.coins;

                // 차트 드롭다운 업데이트
                const chartSelect = document.getElementById('chartCoin');
                if (chartSelect) {
                    const currentValue = chartSelect.value;
                    chartSelect.innerHTML = targetCoins.map(coin => {
                        const symbol = coin.replace('KRW-', '');
                        return `<option value="${coin}">${symbol}</option>`;
                    }).join('');

                    // 이전 선택값 유지
                    if (currentValue && targetCoins.includes(currentValue)) {
                        chartSelect.value = currentValue;
                    }
                }
            }
        }

        // Candlestick Chart
        let lastChartCoin = '';
        let lastChartInterval = '';
        let chartLoading = false;
        let priceChartData = null;
        let currentCandlePrice = null;

        async function loadChart(forceRefresh = false) {
            if (chartLoading) return;

            const container = document.getElementById('priceChart');
            const coin = document.getElementById('chartCoin')?.value || 'KRW-BTC';
            const interval = document.getElementById('chartInterval')?.value || '5';

            const isFirstLoad = container.innerHTML.includes('Loading') || container.innerHTML.includes('로딩');
            if (isFirstLoad) {
                container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading chart...</div>';
            }

            if (!forceRefresh && coin === lastChartCoin && interval === lastChartInterval && !isFirstLoad) {
                return;
            }

            chartLoading = true;
            const data = await fetchAPI(`/market/candles/${coin}?unit=${interval}&count=50`);
            chartLoading = false;

            lastChartCoin = coin;
            lastChartInterval = interval;

            if (!data || data.error || data.length === 0) {
                container.innerHTML = '<div class="empty-state">차트 데이터를 불러올 수 없습니다</div>';
                return;
            }

            priceChartData = data;
            renderCandlestickChart(container, data, coin, interval);
        }

        function renderCandlestickChart(container, data, coin, interval) {
            const firstCandle = data[0];
            const latest = data[data.length - 1];

            const allPrices = data.flatMap(d => [d.high, d.low]);
            const minPrice = Math.min(...allPrices) * 0.9995;
            const maxPrice = Math.max(...allPrices) * 1.0005;
            const priceRange = maxPrice - minPrice || 1;

            const volumes = data.map(d => d.volume || 0);
            const maxVolume = Math.max(...volumes) || 1;

            const chartChange = ((latest.close - firstCandle.close) / firstCandle.close * 100).toFixed(2);
            const isPositive = chartChange >= 0;
            const changeClass = isPositive ? 'positive' : 'negative';
            const changeSign = isPositive ? '+' : '';

            let html = `
                <div class="chart-header">
                    <div class="chart-header-left">
                        <div class="chart-price-info">
                            <div class="chart-current-price" id="livePrice">${formatNumber(latest.close)}원</div>
                            <div class="chart-price-change ${changeClass}" id="livePriceChange">
                                ${changeSign}${formatNumber(Math.abs(latest.close - firstCandle.close))}원 (${changeSign}${chartChange}%)
                            </div>
                        </div>
                    </div>
                    <div class="chart-stats">
                        <div class="chart-stat-item">
                            <span class="chart-stat-label">시가</span>
                            <span class="chart-stat-value">${formatNumber(latest.open)}원</span>
                        </div>
                        <div class="chart-stat-item">
                            <span class="chart-stat-label">고가</span>
                            <span class="chart-stat-value positive">${formatNumber(latest.high)}원</span>
                        </div>
                        <div class="chart-stat-item">
                            <span class="chart-stat-label">저가</span>
                            <span class="chart-stat-value negative">${formatNumber(latest.low)}원</span>
                        </div>
                    </div>
                </div>
                <div class="candlestick-container" id="candlestickContainer">
            `;

            data.forEach((candle, i) => {
                const isBullish = candle.close >= candle.open;
                const bodyTop = Math.max(candle.open, candle.close);
                const bodyBottom = Math.min(candle.open, candle.close);

                const highPct = ((candle.high - minPrice) / priceRange * 100).toFixed(2);
                const lowPct = ((candle.low - minPrice) / priceRange * 100).toFixed(2);
                const bodyTopPct = ((bodyTop - minPrice) / priceRange * 100).toFixed(2);
                const bodyBottomPct = ((bodyBottom - minPrice) / priceRange * 100).toFixed(2);
                const bodyHeight = Math.max(bodyTopPct - bodyBottomPct, 0.5);

                const changeFromFirst = ((candle.close - firstCandle.close) / firstCandle.close * 100).toFixed(2);
                const isCurrentCandle = i === data.length - 1;

                html += `
                    <div class="candlestick ${isBullish ? 'bullish' : 'bearish'} ${isCurrentCandle ? 'current' : ''}"
                         data-idx="${i}" data-time="${candle.time}" data-open="${candle.open}"
                         data-high="${candle.high}" data-low="${candle.low}" data-close="${candle.close}"
                         data-volume="${candle.volume || 0}" data-change="${changeFromFirst}">
                        <div class="candlestick-wick" style="bottom: ${bodyTopPct}%; height: ${highPct - bodyTopPct}%;"></div>
                        <div class="candlestick-body" style="bottom: ${bodyBottomPct}%; height: ${bodyHeight}%;"></div>
                        <div class="candlestick-wick" style="bottom: ${lowPct}%; height: ${bodyBottomPct - lowPct}%;"></div>
                    </div>
                `;
            });

            const priceSteps = 5;
            html += `<div class="price-scale">`;
            for (let i = priceSteps; i >= 0; i--) {
                const price = minPrice + (priceRange * i / priceSteps);
                html += `<span>${formatNumber(price)}</span>`;
            }
            html += `</div></div>`;

            html += `<div class="volume-container">`;
            data.forEach((candle) => {
                const volHeight = ((candle.volume || 0) / maxVolume * 100).toFixed(1);
                const isBullish = candle.close >= candle.open;
                html += `<div class="volume-bar ${isBullish ? 'bullish' : 'bearish'}" style="height: ${Math.max(volHeight, 2)}%;"></div>`;
            });
            html += `</div>`;

            const timeSteps = Math.min(5, data.length);
            const timeInterval = Math.floor(data.length / timeSteps);
            html += `<div class="time-scale">`;
            for (let i = 0; i < timeSteps; i++) {
                const idx = i * timeInterval;
                if (idx < data.length) {
                    const time = new Date(data[idx].time);
                    html += `<span>${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}</span>`;
                }
            }
            const latestTime = new Date(latest.time);
            html += `<span>${latestTime.getHours().toString().padStart(2, '0')}:${latestTime.getMinutes().toString().padStart(2, '0')}</span></div>`;

            container.innerHTML = html;
            setupCandlestickTooltipListeners();
        }

        function updateCurrentCandle(newPrice) {
            if (!priceChartData || priceChartData.length === 0) return;

            const container = document.getElementById('candlestickContainer');
            if (!container) return;

            const currentCandleEl = container.querySelector('.candlestick.current');
            if (!currentCandleEl) return;

            const lastCandle = priceChartData[priceChartData.length - 1];
            lastCandle.close = newPrice;
            if (newPrice > lastCandle.high) lastCandle.high = newPrice;
            if (newPrice < lastCandle.low) lastCandle.low = newPrice;

            const allPrices = priceChartData.flatMap(d => [d.high, d.low]);
            const minPrice = Math.min(...allPrices) * 0.9995;
            const maxPrice = Math.max(...allPrices) * 1.0005;
            const priceRange = maxPrice - minPrice || 1;

            const isBullish = lastCandle.close >= lastCandle.open;
            const bodyTop = Math.max(lastCandle.open, lastCandle.close);
            const bodyBottom = Math.min(lastCandle.open, lastCandle.close);

            const highPct = ((lastCandle.high - minPrice) / priceRange * 100).toFixed(2);
            const lowPct = ((lastCandle.low - minPrice) / priceRange * 100).toFixed(2);
            const bodyTopPct = ((bodyTop - minPrice) / priceRange * 100).toFixed(2);
            const bodyBottomPct = ((bodyBottom - minPrice) / priceRange * 100).toFixed(2);
            const bodyHeight = Math.max(bodyTopPct - bodyBottomPct, 0.5);

            currentCandleEl.className = `candlestick ${isBullish ? 'bullish' : 'bearish'} current`;
            currentCandleEl.setAttribute('data-close', newPrice);
            currentCandleEl.setAttribute('data-high', lastCandle.high);
            currentCandleEl.setAttribute('data-low', lastCandle.low);

            const wicks = currentCandleEl.querySelectorAll('.candlestick-wick');
            const body = currentCandleEl.querySelector('.candlestick-body');

            if (wicks[0]) { wicks[0].style.bottom = `${bodyTopPct}%`; wicks[0].style.height = `${highPct - bodyTopPct}%`; }
            if (body) { body.style.bottom = `${bodyBottomPct}%`; body.style.height = `${bodyHeight}%`; }
            if (wicks[1]) { wicks[1].style.bottom = `${lowPct}%`; wicks[1].style.height = `${bodyBottomPct - lowPct}%`; }

            const livePriceEl = document.getElementById('livePrice');
            const livePriceChangeEl = document.getElementById('livePriceChange');

            if (livePriceEl) livePriceEl.textContent = formatNumber(newPrice) + '원';

            if (livePriceChangeEl && priceChartData.length > 0) {
                const firstCandle = priceChartData[0];
                const chartChange = ((newPrice - firstCandle.close) / firstCandle.close * 100).toFixed(2);
                const isPositive = chartChange >= 0;
                const changeSign = isPositive ? '+' : '';
                livePriceChangeEl.className = `chart-price-change ${isPositive ? 'positive' : 'negative'}`;
                livePriceChangeEl.textContent = `${changeSign}${formatNumber(Math.abs(newPrice - firstCandle.close))}원 (${changeSign}${chartChange}%)`;
            }
        }

        function setupCandlestickTooltipListeners() {
            const tooltip = document.getElementById('priceChartTooltip');
            const candles = document.querySelectorAll('.candlestick');

            candles.forEach(candle => {
                candle.addEventListener('mouseenter', (e) => {
                    const time = candle.getAttribute('data-time');
                    const open = parseFloat(candle.getAttribute('data-open'));
                    const high = parseFloat(candle.getAttribute('data-high'));
                    const low = parseFloat(candle.getAttribute('data-low'));
                    const close = parseFloat(candle.getAttribute('data-close'));
                    const change = parseFloat(candle.getAttribute('data-change'));

                    const timeDate = new Date(time);
                    const timeStr = timeDate.toLocaleString('ko-KR', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });

                    document.getElementById('priceChartTooltipTime').textContent = timeStr;
                    document.getElementById('priceChartTooltipOpen').textContent = formatNumber(open) + '원';
                    document.getElementById('priceChartTooltipHigh').textContent = formatNumber(high) + '원';
                    document.getElementById('priceChartTooltipLow').textContent = formatNumber(low) + '원';
                    document.getElementById('priceChartTooltipClose').textContent = formatNumber(close) + '원';

                    const changeEl = document.getElementById('priceChartTooltipChange');
                    const isPositive = change >= 0;
                    changeEl.style.color = isPositive ? 'var(--accent-green)' : 'var(--accent-red)';
                    changeEl.textContent = `${isPositive ? '+' : ''}${change}%`;

                    tooltip.classList.add('active');
                });

                candle.addEventListener('mousemove', (e) => {
                    const tooltipWidth = tooltip.offsetWidth;
                    const tooltipHeight = tooltip.offsetHeight;
                    let left = e.clientX + 15;
                    let top = e.clientY - tooltipHeight / 2;

                    if (left + tooltipWidth > window.innerWidth) left = e.clientX - tooltipWidth - 15;
                    if (top < 10) top = 10;
                    if (top + tooltipHeight > window.innerHeight - 10) top = window.innerHeight - tooltipHeight - 10;

                    tooltip.style.left = left + 'px';
                    tooltip.style.top = top + 'px';
                });

                candle.addEventListener('mouseleave', () => tooltip.classList.remove('active'));
            });
        }

        // Initialize
        console.log('Dashboard initializing...');

        // 초기 로드
        (async function init() {
            await loadTargetCoins();  // 코인 목록 먼저 로드
            await loadAllData();
            await loadParameterRanges();
            await loadInvestmentPresets();

            // 마켓 클릭 이벤트 위임 설정
            setupMarketClickDelegation();

            // 저장된 뷰 모드 복원
            const savedViewMode = localStorage.getItem('marketViewMode') || 'grid';
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === savedViewMode);
            });

            // 저장된 선택 코인으로 차트 설정
            const savedCoin = localStorage.getItem('selectedCoin');
            if (savedCoin) {
                const chartSelect = document.getElementById('chartCoin');
                if (chartSelect && targetCoins.includes(savedCoin)) {
                    chartSelect.value = savedCoin;
                    selectedCoin = savedCoin;
                }
            }

            // 인라인 트레이드 패널 금액 입력 이벤트 리스너
            const inlineAmountInput = document.getElementById('inlineTradeAmount');
            if (inlineAmountInput) {
                inlineAmountInput.addEventListener('input', updateInlineTradeEstQty);
            }

            // 마켓 탭일 때 인라인 패널 초기 표시
            const currentTab = localStorage.getItem('currentTab');
            if (currentTab === 'market' && selectedCoin && marketPricesData.length > 0) {
                updateInlineTradePanel(selectedCoin);
            }

            console.log('Dashboard ready');
        })();

        // Auto refresh - 메인 데이터 5초마다 (rate limit 방지)
        setInterval(loadAllData, 5000);

        // 마켓 가격은 3초마다 업데이트 + 실시간 캔들 업데이트
        setInterval(async () => {
            const currentTab = localStorage.getItem('currentTab');
            if (currentTab === 'market') {
                await loadMarketPrices();

                // 현재 선택된 코인의 가격으로 캔들 실시간 업데이트
                if (marketPricesData && lastChartCoin) {
                    const coinData = marketPricesData.find(c => c.coin === lastChartCoin);
                    if (coinData && coinData.price) {
                        updateCurrentCandle(coinData.price);
                    }
                }
            }
        }, 3000);

        // 차트는 30초마다 전체 리프레시 (새 캔들 생성 반영)
        setInterval(() => {
            const currentTab = localStorage.getItem('currentTab');
            if (currentTab === 'market') {
                loadChart(true); // forceRefresh
            }
        }, 30000);

        // 코인 목록은 30초마다 갱신 (환경설정 변경 반영)
        setInterval(loadTargetCoins, 30000);

        // Trading 탭 전용 업데이트 (5초마다) - 보유 평가액 및 포지션 실시간 반영
        setInterval(async () => {
            const currentTab = localStorage.getItem('currentTab');
            if (currentTab === 'trading') {
                try {
                    await updateBuyPresetInfo();
                    await updateSellPresetInfo();
                    await loadManualPositions();
                    await loadSellRecommendations();
                } catch (e) {
                    console.warn('Trading tab update error:', e);
                }
            }
        }, 5000);

        // ===== News Functions =====
        let newsData = [];
        let newsLoading = false;

        async function loadNews() {
            if (newsLoading) return;

            const sentimentContainer = document.getElementById('newsSentimentOverview');
            const listContainer = document.getElementById('newsList');
            const isFirstLoad = listContainer.innerHTML.includes('로딩') || listContainer.innerHTML.includes('Loading');

            if (isFirstLoad) {
                sentimentContainer.innerHTML = '<div class="loading"><div class="spinner"></div>뉴스 분석 중...</div>';
                listContainer.innerHTML = '<div class="loading"><div class="spinner"></div>뉴스 로딩 중...</div>';
            }

            newsLoading = true;
            const data = await fetchAPI('/news');
            newsLoading = false;

            if (!data || data.error) {
                sentimentContainer.innerHTML = '<div class="empty-state">뉴스를 불러올 수 없습니다</div>';
                listContainer.innerHTML = '<div class="empty-state">뉴스를 불러올 수 없습니다</div>';
                return;
            }

            newsData = data.news || [];
            const sentiment = data.sentiment || {};

            // Render sentiment overview
            renderNewsSentiment(sentiment);

            // Render news list
            filterNews();
        }

        function renderNewsSentiment(sentiment) {
            const container = document.getElementById('newsSentimentOverview');

            const overallEmoji = sentiment.overall === 'very positive' ? '🚀' :
                                 sentiment.overall === 'positive' ? '📈' :
                                 sentiment.overall === 'very negative' ? '💥' :
                                 sentiment.overall === 'negative' ? '📉' : '➖';

            const overallText = sentiment.overall === 'very positive' ? '매우 긍정적' :
                                sentiment.overall === 'positive' ? '긍정적' :
                                sentiment.overall === 'very negative' ? '매우 부정적' :
                                sentiment.overall === 'negative' ? '부정적' : '중립';

            const overallColor = sentiment.overall?.includes('positive') ? 'var(--accent-green)' :
                                 sentiment.overall?.includes('negative') ? 'var(--accent-red)' : 'var(--text-secondary)';

            const recommendationBadge = sentiment.recommendation === 'BUY' ?
                '<span class="badge badge-buy">매수 권장</span>' :
                sentiment.recommendation === 'SELL' ?
                '<span class="badge badge-sell">매도 권장</span>' :
                '<span class="badge" style="background: var(--bg-tertiary);">관망</span>';

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px;">
                    <!-- 전체 심리 -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center; border-left: 3px solid ${overallColor};">
                        <div style="font-size: 36px; margin-bottom: 8px;">${overallEmoji}</div>
                        <div style="font-size: 18px; font-weight: 700; color: ${overallColor}; margin-bottom: 4px;">${overallText}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">시장 심리</div>
                    </div>

                    <!-- 감성 점수 -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 28px; font-weight: 700; margin-bottom: 8px;">${sentiment.score || '0.00'}</div>
                        <div style="font-size: 12px; color: var(--text-muted);">감성 점수</div>
                        <div style="margin-top: 8px;">${recommendationBadge}</div>
                    </div>

                    <!-- 긍정/부정 비율 -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: var(--accent-green); font-weight: 600;">긍정 ${sentiment.positiveRatio || '0%'}</span>
                            <span style="color: var(--accent-red); font-weight: 600;">부정 ${sentiment.negativeRatio || '0%'}</span>
                        </div>
                        <div style="display: flex; height: 8px; border-radius: 4px; overflow: hidden; background: var(--bg-primary);">
                            <div style="width: ${parseFloat(sentiment.positiveRatio) || 0}%; background: var(--accent-green);"></div>
                            <div style="flex: 1; background: var(--bg-primary);"></div>
                            <div style="width: ${parseFloat(sentiment.negativeRatio) || 0}%; background: var(--accent-red);"></div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px; text-align: center;">
                            총 ${sentiment.totalNews || 0}개 뉴스 분석
                        </div>
                    </div>

                    <!-- 뉴스 카운트 -->
                    <div style="background: var(--bg-tertiary); padding: 20px; border-radius: 8px; display: flex; justify-content: space-around; align-items: center;">
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${sentiment.positiveCount || 0}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">긍정</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--text-muted);">${sentiment.neutralCount || 0}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">중립</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 24px; font-weight: 700; color: var(--accent-red);">${sentiment.negativeCount || 0}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">부정</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function filterNews() {
            const filter = document.getElementById('newsFilter')?.value || 'all';
            const source = document.getElementById('newsSource')?.value || 'all';
            const container = document.getElementById('newsList');

            // Keep track of original indices
            let filteredNews = newsData.map((news, idx) => ({ ...news, originalIndex: idx }));

            // Filter by sentiment
            if (filter !== 'all') {
                filteredNews = filteredNews.filter(news => news.sentiment?.sentiment === filter);
            }

            // Filter by source
            if (source !== 'all') {
                if (source === 'twitter') {
                    // Twitter/X 소스는 여러 형태가 있음 (X/@username, X/Crypto 등)
                    filteredNews = filteredNews.filter(news =>
                        news.isTwitter ||
                        news.source?.startsWith('X/') ||
                        news.source?.includes('Twitter')
                    );
                } else {
                    filteredNews = filteredNews.filter(news => news.source === source);
                }
            }

            if (filteredNews.length === 0) {
                container.innerHTML = '<div class="empty-state">조건에 맞는 뉴스가 없습니다</div>';
                return;
            }

            let html = '';
            filteredNews.forEach((news) => {
                const index = news.originalIndex;
                const sentimentEmoji = news.sentiment?.sentiment === 'positive' ? '📈' :
                                       news.sentiment?.sentiment === 'negative' ? '📉' : '➖';
                const sentimentColor = news.sentiment?.sentiment === 'positive' ? 'var(--accent-green)' :
                                       news.sentiment?.sentiment === 'negative' ? 'var(--accent-red)' : 'var(--text-muted)';
                const sentimentText = news.sentiment?.sentiment === 'positive' ? '긍정' :
                                      news.sentiment?.sentiment === 'negative' ? '부정' : '중립';
                const score = news.sentiment?.score?.toFixed(1) || '0';

                const timeStr = news.timestamp ? new Date(news.timestamp).toLocaleString('ko-KR', {
                    month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                }) : '-';
                const hasLink = news.link && news.link !== '#';

                // 링크가 있으면 바로 원문으로, 없으면 상세 모달 표시
                const clickHandler = hasLink
                    ? `window.open('${news.link}', '_blank')`
                    : `showNewsDetail(${index})`;

                html += `
                    <div class="news-item" style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 10px; cursor: pointer; border-left: 3px solid ${sentimentColor}; transition: all 0.2s ease;"
                         onclick="${clickHandler}"
                         onmouseenter="this.style.background='var(--bg-secondary)'"
                         onmouseleave="this.style.background='var(--bg-tertiary)'">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 14px; line-height: 1.4; margin-bottom: 8px;">
                                    ${sentimentEmoji} ${news.title || 'No title'}
                                </div>
                                <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-muted); align-items: center;">
                                    <span style="background: var(--bg-primary); padding: 2px 8px; border-radius: 4px;">${news.source || '-'}</span>
                                    <span>${timeStr}</span>
                                    ${hasLink ? '<span style="color: var(--accent-blue);">↗ 원문</span>' : ''}
                                </div>
                            </div>
                            <div style="text-align: right; min-width: 60px;">
                                <div style="font-weight: 600; color: ${sentimentColor}; font-size: 14px;">${sentimentText}</div>
                                <div style="font-size: 12px; color: var(--text-muted);">점수: ${score}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // 코인별 뉴스 검색
        async function searchCoinNews() {
            const coinInput = document.getElementById('coinNewsSearch').value.trim().toUpperCase();
            if (!coinInput) {
                showToast('코인 심볼을 입력해주세요 (예: BTC, ETH)', 'warning');
                return;
            }

            const container = document.getElementById('newsList');
            const header = document.getElementById('coinNewsHeader');
            const title = document.getElementById('coinNewsTitle');
            const sources = document.getElementById('coinNewsSources');

            container.innerHTML = '<div class="loading"><div class="spinner"></div>코인별 뉴스 검색 중...</div>';
            header.style.display = 'block';
            title.textContent = `🔍 ${coinInput} 관련 뉴스`;

            try {
                const response = await fetch(`/api/news/${coinInput}`);
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // 소스 정보 표시
                sources.innerHTML = `
                    <span>📊 감성: ${data.sentiment?.overall || 'neutral'} (점수: ${data.sentiment?.score || 0})</span>
                    <span style="margin-left: 15px;">🐦 Twitter: ${data.sources?.twitter || 0}개</span>
                    <span style="margin-left: 10px;">📰 Google: ${data.sources?.googleNews || 0}개</span>
                    <span style="margin-left: 10px;">기타: ${data.sources?.other || 0}개</span>
                `;

                if (!data.news || data.news.length === 0) {
                    container.innerHTML = '<div class="empty-state">해당 코인의 뉴스가 없습니다</div>';
                    return;
                }

                // 코인별 뉴스 표시
                const coinNewsData = data.news;
                let html = '';
                coinNewsData.forEach((news) => {
                    const sentimentEmoji = news.sentiment?.sentiment === 'positive' ? '📈' :
                                           news.sentiment?.sentiment === 'negative' ? '📉' : '➖';
                    const sentimentColor = news.sentiment?.sentiment === 'positive' ? 'var(--accent-green)' :
                                           news.sentiment?.sentiment === 'negative' ? 'var(--accent-red)' : 'var(--text-muted)';
                    const sentimentText = news.sentiment?.sentiment === 'positive' ? '긍정' :
                                          news.sentiment?.sentiment === 'negative' ? '부정' : '중립';
                    const score = news.sentiment?.score?.toFixed(1) || '0';
                    const timeStr = news.timestamp ? new Date(news.timestamp).toLocaleString('ko-KR', {
                        month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    }) : '-';
                    const hasLink = news.link && news.link !== '#';
                    const isTwitter = news.isTwitter || news.source?.includes('X/') || news.source?.includes('Twitter');

                    html += `
                        <div class="news-item" style="padding: 16px; background: var(--bg-tertiary); border-radius: 8px; margin-bottom: 10px; cursor: pointer; border-left: 3px solid ${sentimentColor}; transition: all 0.2s ease;"
                             onclick="${hasLink ? `window.open('${news.link}', '_blank')` : ''}"
                             onmouseenter="this.style.background='var(--bg-secondary)'"
                             onmouseleave="this.style.background='var(--bg-tertiary)'">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 12px;">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; font-size: 14px; line-height: 1.4; margin-bottom: 8px;">
                                        ${sentimentEmoji} ${news.title || 'No title'}
                                    </div>
                                    <div style="display: flex; gap: 12px; font-size: 12px; color: var(--text-muted); align-items: center;">
                                        <span style="background: ${isTwitter ? 'var(--accent-blue)' : 'var(--bg-primary)'}; color: ${isTwitter ? 'white' : 'inherit'}; padding: 2px 8px; border-radius: 4px;">
                                            ${isTwitter ? '🐦 ' : ''}${news.source || '-'}
                                        </span>
                                        <span>${timeStr}</span>
                                        ${hasLink ? '<span style="color: var(--accent-blue);">↗ 원문</span>' : ''}
                                    </div>
                                </div>
                                <div style="text-align: right; min-width: 60px;">
                                    <div style="font-weight: 600; color: ${sentimentColor}; font-size: 14px;">${sentimentText}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">점수: ${score}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            } catch (error) {
                container.innerHTML = `<div class="empty-state">뉴스 검색 실패: ${error.message}</div>`;
            }
        }

        // 코인별 뉴스 필터 해제
        function clearCoinNewsFilter() {
            document.getElementById('coinNewsHeader').style.display = 'none';
            document.getElementById('coinNewsSearch').value = '';
            filterNews();
        }

        function showNewsDetail(index) {
            const news = newsData[index];
            if (!news) return;

            const modal = document.getElementById('newsDetailModal');
            const content = document.getElementById('newsDetailContent');
            const link = document.getElementById('newsDetailLink');

            const sentimentEmoji = news.sentiment?.sentiment === 'positive' ? '📈' :
                                   news.sentiment?.sentiment === 'negative' ? '📉' : '➖';
            const sentimentColor = news.sentiment?.sentiment === 'positive' ? 'var(--accent-green)' :
                                   news.sentiment?.sentiment === 'negative' ? 'var(--accent-red)' : 'var(--text-muted)';
            const sentimentText = news.sentiment?.sentiment === 'positive' ? '긍정적' :
                                  news.sentiment?.sentiment === 'negative' ? '부정적' : '중립';

            const score = news.sentiment?.score || 0;
            const confidence = news.sentiment?.confidence || 0;

            // 영향력 분석 생성
            let impactAnalysis = '';
            if (news.sentiment?.sentiment === 'positive') {
                if (score > 3) {
                    impactAnalysis = '이 뉴스는 <strong style="color: var(--accent-green);">강한 긍정적 영향</strong>을 미칠 것으로 예상됩니다. 매수 신호로 해석될 수 있습니다.';
                } else if (score > 1) {
                    impactAnalysis = '이 뉴스는 <strong style="color: var(--accent-green);">약한 긍정적 영향</strong>을 미칠 것으로 예상됩니다. 시장 심리 개선에 기여할 수 있습니다.';
                } else {
                    impactAnalysis = '이 뉴스는 <strong>약간 긍정적</strong>이나 시장에 큰 영향은 없을 것으로 예상됩니다.';
                }
            } else if (news.sentiment?.sentiment === 'negative') {
                if (score < -3) {
                    impactAnalysis = '이 뉴스는 <strong style="color: var(--accent-red);">강한 부정적 영향</strong>을 미칠 것으로 예상됩니다. 매도 신호로 해석될 수 있습니다.';
                } else if (score < -1) {
                    impactAnalysis = '이 뉴스는 <strong style="color: var(--accent-red);">약한 부정적 영향</strong>을 미칠 것으로 예상됩니다. 시장 심리 악화에 기여할 수 있습니다.';
                } else {
                    impactAnalysis = '이 뉴스는 <strong>약간 부정적</strong>이나 시장에 큰 영향은 없을 것으로 예상됩니다.';
                }
            } else {
                impactAnalysis = '이 뉴스는 <strong>중립적</strong>이며 시장에 특별한 영향을 미치지 않을 것으로 예상됩니다.';
            }

            const timeStr = news.timestamp ? new Date(news.timestamp).toLocaleString('ko-KR') : '-';

            const hasLink = news.link && news.link !== '#';
            const description = news.description || news.summary || '';

            content.innerHTML = `
                <!-- 뉴스 제목 -->
                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-size: 16px; font-weight: 600; line-height: 1.5;">${news.title || 'No title'}</div>
                    <div style="margin-top: 8px; font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="background: var(--bg-primary); padding: 2px 8px; border-radius: 4px; margin-right: 8px;">${news.source || '-'}</span>
                            ${timeStr}
                        </div>
                        ${hasLink ? `
                        <a href="${news.link}" target="_blank" rel="noopener noreferrer"
                           style="display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--accent-blue); border-radius: 6px; color: white; text-decoration: none; font-size: 13px; font-weight: 500; transition: all 0.2s;"
                           onmouseenter="this.style.background='#4a9eff';"
                           onmouseleave="this.style.background='var(--accent-blue)';">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                <polyline points="15 3 21 3 21 9"></polyline>
                                <line x1="10" y1="14" x2="21" y2="3"></line>
                            </svg>
                            원문 보기
                        </a>
                        ` : ''}
                    </div>
                </div>

                ${description ? `
                <!-- 뉴스 요약 -->
                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                    <div style="font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 8px;">
                        <span>📰</span>
                        <span>뉴스 요약</span>
                    </div>
                    <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                        ${description}
                    </div>
                </div>
                ` : ''}

                <!-- 감성 분석 결과 -->
                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px; margin-bottom: 16px; border-left: 4px solid ${sentimentColor};">
                    <div style="font-weight: 600; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">${sentimentEmoji}</span>
                        <span>AI 감성 분석</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: 700; color: ${sentimentColor};">${sentimentText}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">감성</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: 700;">${score.toFixed(2)}</div>
                            <div style="font-size: 11px; color: var(--text-muted);">감성 점수</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: 700;">${(confidence * 100).toFixed(0)}%</div>
                            <div style="font-size: 11px; color: var(--text-muted);">신뢰도</div>
                        </div>
                    </div>
                </div>

                <!-- 영향력 분석 -->
                <div style="background: var(--bg-tertiary); padding: 16px; border-radius: 8px;">
                    <div style="font-weight: 600; margin-bottom: 8px;">💡 예상 영향력</div>
                    <div style="font-size: 14px; line-height: 1.6; color: var(--text-secondary);">
                        ${impactAnalysis}
                    </div>
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); font-size: 12px; color: var(--text-muted);">
                        ⚠️ 본 분석은 AI 기반 자동 분석 결과이며, 실제 투자 결정은 신중하게 내려주세요.
                    </div>
                </div>
            `;

            link.href = news.link || '#';
            // 링크가 없으면 하단 원문보기 버튼 숨김
            link.style.display = hasLink ? 'inline-flex' : 'none';
            modal.style.display = 'flex';
        }

        function closeNewsDetailModal() {
            document.getElementById('newsDetailModal').style.display = 'none';
        }

        // 뉴스 모달 외부 클릭 시 닫기
        document.getElementById('newsDetailModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeNewsDetailModal();
            }
        });
    </script>
</body>
</html>
